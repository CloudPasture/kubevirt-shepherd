# KubeVirt Shepherd CI Pipeline
# ADR-0029: Pin actions to commit SHA, use specific runner version
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    if: ${{ hashFiles('go.mod') != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: "1.25"

      - name: golangci-lint
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v6.5.0

  build:
    name: Build
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    if: ${{ hashFiles('go.mod') != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: "1.25"

      - name: Build
        run: go build ./...

  test:
    name: Test
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    if: ${{ hashFiles('go.mod') != '' }}
    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_USER: shepherd
          POSTGRES_PASSWORD: shepherd
          POSTGRES_DB: shepherd_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: "1.25"

      - name: Test
        env:
          DATABASE_URL: postgres://shepherd:shepherd@localhost:5432/shepherd_test?sslmode=disable
        run: go test -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage
          path: coverage.out

  ci-checks:
    name: CI Checks
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    if: ${{ hashFiles('go.mod') != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: "1.25"

      - name: Check no Redis imports (ADR)
        run: bash docs/design/ci/scripts/check_no_redis_import.sh

      - name: Check manual DI - no Wire/Dig (ADR-0013)
        run: bash docs/design/ci/scripts/check_manual_di.sh

      - name: Check no GORM imports (ADR-0003)
        run: go run docs/design/ci/scripts/check_no_gorm_import.go

      - name: Check naked goroutines (ADR-0031)
        run: go run docs/design/ci/scripts/check_naked_goroutine.go

      - name: Check forbidden imports
        run: go run docs/design/ci/scripts/check_forbidden_imports.go

      - name: Check sqlc usage scope (ADR-0012)
        run: bash docs/design/ci/scripts/check_sqlc_usage.sh

      - name: Check semaphore usage (ADR-0031)
        run: go run docs/design/ci/scripts/check_semaphore_usage.go

      - name: Check River bypass (ADR-0006)
        run: go run docs/design/ci/scripts/check_river_bypass.go

      - name: Check transaction boundaries (ADR-0012)
        if: ${{ hashFiles('internal/service/**/*.go') != '' }}
        run: go run docs/design/ci/scripts/check_transaction_boundary.go

      - name: Check K8s in transaction (ADR-0012)
        run: go run docs/design/ci/scripts/check_k8s_in_transaction.go

      - name: Validate OpenAPI spec (ADR-0021)
        run: go run docs/design/ci/scripts/check_validate_spec.go

      - name: Check API contract sync (ADR-0021)
        run: bash docs/design/ci/scripts/api-check.sh

      - name: Check no Outbox imports (ADR-0006)
        run: go run docs/design/ci/scripts/check_no_outbox_import.go

      - name: Check River job args claim-check (ADR-0009)
        run: go run docs/design/ci/scripts/check_river_job_args.go

      - name: Check test assertions (ISSUE-018)
        run: go run docs/design/ci/scripts/check_test_assertions.go

      - name: Check dead tests (warning only)
        run: go run docs/design/ci/scripts/check_dead_tests.go || true

      - name: Check repository test coverage
        run: go run docs/design/ci/scripts/check_repository_tests.go
