# è§„èŒƒäº¤äº’æµç¨‹ (Master Flow)

> **Status**: Stable (ADR-0017, ADR-0018 Accepted)  
> **ç‰ˆæœ¬**: 1.2
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-28  
> **æœ€åæ›´æ–°**: 2026-02-06
> **è¯­è¨€**: ä¸­æ–‡ (ç¿»è¯‘ç‰ˆæœ¬)  
> **è§„èŒƒç‰ˆæœ¬**: [English Canonical Version](../../../../design/interaction-flows/master-flow.md)
>
> ğŸŒ **Other Languages**: [English (Canonical)](../../../../design/interaction-flows/master-flow.md)

---

## æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£æ˜¯ Shepherd å¹³å°æ‰€æœ‰äº¤äº’æµç¨‹çš„**ä¸­æ–‡ç¿»è¯‘ç‰ˆæœ¬**ï¼Œæ˜¯å‰åç«¯å’Œæ•°æ®åº“å¼€å‘çš„**å‚è€ƒæ–‡æ¡£**ã€‚

> **æ³¨æ„**: è‹±æ–‡ç‰ˆæœ¬ (`docs/design/interaction-flows/master-flow.md`) æ˜¯è§„èŒƒç‰ˆæœ¬ (Canonical Version)ã€‚
> å¦‚æœ‰ä¸ä¸€è‡´ï¼Œä»¥è‹±æ–‡ç‰ˆæœ¬ä¸ºå‡†ã€‚

## æ–‡æ¡£èŒƒå›´

| åŒ…å«å†…å®¹ | ä¸åŒ…å«å†…å®¹ |
|----------|------------|
| ç”¨æˆ·äº¤äº’æµç¨‹ | æ•°æ®åº“ DDL/Schema å®šä¹‰ |
| æ•°æ®æµå‘ä¸æ¥æº | è¯¦ç»† API è§„èŒƒ |
| æ¦‚å¿µçŠ¶æ€å›¾ | å®ç°ä»£ç ç¤ºä¾‹ |
| ä¸šåŠ¡è§„åˆ™æ¦‚è¿° | åº•å±‚æŠ€æœ¯çº¦æŸ |

> **äº¤å‰å¼•ç”¨æ¨¡å¼**: æ¶‰åŠæ•°æ®æŒä¹…åŒ–çš„æ“ä½œåœ¨æœ¬æ–‡æ¡£æä¾›æ¦‚å¿µæ¦‚è¿°ï¼Œå®ç°ç»†èŠ‚è¯¦è§ Phase è®¾è®¡æ–‡æ¡£ã€‚
>
> ç¤ºä¾‹: "æ‰€æœ‰æ“ä½œéƒ½ä¼šåˆ›å»ºå®¡è®¡æ—¥å¿—ã€‚è¯¦è§ [04-governance.md Â§7](../../../../design/phases/04-governance.md#7-audit-logging) äº†è§£ Schema è¯¦æƒ…ã€‚"

### æ–‡æ¡£å±‚çº§ï¼ˆé˜²æ­¢å†…å®¹æ¼‚ç§»ï¼‰

| æ–‡æ¡£ | èŒè´£ | èŒƒå›´ |
|------|------|------|
| **ADRs** | æ¶æ„å†³ç­–ï¼ˆæ¥å—åä¸å¯å˜ï¼‰ | å†³ç­–ç†ç”±å’Œæƒè¡¡åˆ†æ |
| **æœ¬æ–‡æ¡£ (master-flow.md)** | äº¤äº’åŸç†ï¼ˆå”¯ä¸€çœŸæºï¼‰ | æ•°æ®æ¥æºã€æµç¨‹åŸç†ã€ç”¨æˆ·æ—…ç¨‹ |
| **Phase æ–‡æ¡£** | å®ç°ç»†èŠ‚ | ä»£ç æ¨¡å¼ã€Schema è®¾è®¡ã€API è®¾è®¡ |
| **[CHECKLIST.md](../../../../design/CHECKLIST.md)** | ADR çº¦æŸå¼•ç”¨ | é›†ä¸­å¼ ADR å¼ºåˆ¶è§„åˆ™ |

> **å†™ä½œæŒ‡å—**: æœ¬æ–‡æ¡£æè¿°"ä»€ä¹ˆæ•°æ®"å’Œ"ä¸ºä»€ä¹ˆè¿™æ ·æµåŠ¨"ã€‚
> å…³äº"å¦‚ä½•å®ç°"ï¼Œé“¾æ¥åˆ° Phase æ–‡æ¡£ï¼Œè€Œä¸æ˜¯é‡å¤å†…å®¹ã€‚
> ç¤ºä¾‹: "InstanceSize Schema è¯¦æƒ…ï¼Œå‚è§ [01-contracts.md Â§InstanceSize](../../../../design/phases/01-contracts.md#deliverables)ã€‚"

**ç›¸å…³æ–‡æ¡£**:
- [ADR-0018: Instance Size Abstraction Â§User Interaction Flow](../../../../adr/ADR-0018-instance-size-abstraction.md#user-interaction-flow)
- [ADR-0015: Governance Model V2 Â§Decision](../../../../adr/ADR-0015-governance-model-v2.md#decision)
- [ADR-0017: VM Request Flow Â§Decision](../../../../adr/ADR-0017-vm-request-flow-clarification.md#decision)
- [Phase 01: å¥‘çº¦ Â§API Contract-First Design](../../../../design/phases/01-contracts.md#api-contract-first-design-adr-0021) â€” æ•°æ®å¥‘çº¦å’Œå‘½åçº¦æŸ
- [Phase 04: æ²»ç† Â§7 Audit Logging](../../../../design/phases/04-governance.md#7-audit-logging) â€” RBACã€å®¡è®¡æ—¥å¿—ã€å®¡æ‰¹æµç¨‹
- [frontend/FRONTEND.md Â§Schema Cache Degradation Strategy](../../../../design/frontend/FRONTEND.md#schema-cache-degradation-strategy-adr-0023) â€” å‰ç«¯åŸºçº¿å®ç°æ ‡å‡†
- [frontend/features/batch-operations-queue.md Â§2 Parent/Child UI Model](../../../../design/frontend/features/batch-operations-queue.md#2-parentchild-ui-model) â€” çˆ¶å­é˜Ÿåˆ— UI ä¸è½®è¯¢è¯­ä¹‰

**å…³é”® ADR çº¦æŸï¼ˆé€‚ç”¨äºæœ¬æ–‡æ¡£æ‰€æœ‰æµç¨‹ï¼‰**:

| ADR | çº¦æŸ | é€‚ç”¨èŒƒå›´ |
|-----|------|---------|
| **ADR-0006** | æ‰€æœ‰å†™æ“ä½œä½¿ç”¨**ç»Ÿä¸€å¼‚æ­¥æ¨¡å‹**ï¼ˆè¯·æ±‚ â†’ 202 â†’ River é˜Ÿåˆ—ï¼‰ | æ‰€æœ‰çŠ¶æ€å˜æ›´æ“ä½œ |
| **ADR-0009** | River Job ä»…æºå¸¦ **EventID**ï¼ˆClaim Checkï¼‰ï¼›DomainEvent payload **ä¸å¯å˜** | æ‰€æœ‰ River Job |
| **ADR-0012** | åŸå­äº‹åŠ¡ï¼šEnt ç”¨äº ORMï¼Œ**sqlc ä»…ç”¨äºæ ¸å¿ƒäº‹åŠ¡** | æ‰€æœ‰æ•°æ®åº“æ“ä½œ |

> **CI æ¦‚è§ˆ**: ä¸Šè¿°çº¦æŸç”±è‡ªåŠ¨åŒ–æ£€æŸ¥ä¿éšœã€‚å®Œæ•´é—¨ç¦å®šä¹‰å’Œè„šæœ¬æ¸…å•è§ [docs/design/ci/README.md Â§Scope Boundary](../../../../design/ci/README.md#scope-boundary)ã€‚

---

## ç»Ÿä¸€å†™ä½œå¥‘çº¦

æœ¬èŠ‚å®šä¹‰å…¨æ–‡å›ºå®šå†™ä½œé£æ ¼ï¼Œç¡®ä¿æ‰€æœ‰ Stage ç« èŠ‚å…·å¤‡ä¸€è‡´çš„é˜…è¯»ä½“éªŒï¼Œ
åŒæ—¶ä¿ç•™å¿…è¦ç»“è®ºï¼Œä¸æŠŠè¯»è€…å®Œå…¨ä¸¢ç»™å¤–é“¾ã€‚

### Stage å›ºå®šç»“æ„ï¼ˆå¿…é¡»ï¼‰

æ¯ä¸ª `Stage` ç« èŠ‚å¿…é¡»æŒ‰ä»¥ä¸‹é¡ºåºç»„ç»‡ï¼š

1. `Purpose`ï¼ˆæœ¬é˜¶æ®µç›®æ ‡ï¼Œ1-2 è¡Œï¼‰
2. `Actors & Trigger`ï¼ˆè°è§¦å‘ã€å‰ç½®æ¡ä»¶ï¼‰
3. `Interaction Flow`ï¼ˆä»…äº¤äº’æµç¨‹å›¾ï¼‰
4. `State Transitions`ï¼ˆå®ä½“çŠ¶æ€å˜åŒ–ä¸å½’å±è¾¹ç•Œï¼‰
5. `Failure & Edge Cases`ï¼ˆé‡å¤è¯·æ±‚ã€æ— æƒé™ã€çŠ¶æ€å†²çªç­‰ï¼‰
6. `Authority Links`ï¼ˆå¯ç‚¹å‡» ADR/phase/database/frontend/CI é“¾æ¥ï¼‰
7. `Scope Boundary`ï¼ˆæ˜ç¡®æœ¬èŠ‚ä¸å±•å¼€çš„å®ç°ç»†èŠ‚ï¼‰

### Part åœ°å›¾ï¼ˆè§„èŒƒï¼‰

| Part | ä¸»è¦å…³æ³¨ç‚¹ | ä¸»è¦è¯»è€… |
|------|-----------|---------|
| **Part 1** | å¹³å°åˆå§‹åŒ–ä¸å®‰å…¨åŸºçº¿ | å¼€å‘è€…ã€å¹³å°ç®¡ç†å‘˜ |
| **Part 2** | èµ„æºå±‚çº§ä¸å½’å±è¾¹ç•Œ | æ™®é€šç”¨æˆ·ã€å¹³å°ç®¡ç†å‘˜ |
| **Part 3** | VM ç”³è¯·/å®¡æ‰¹/æ‰§è¡Œ/åˆ é™¤å…¨ç”Ÿå‘½å‘¨æœŸ | æ™®é€šç”¨æˆ·ã€å¹³å°ç®¡ç†å‘˜ |
| **Part 4** | çŠ¶æ€æœºä¸å…±äº«æ•°æ®æ¨¡å‹è¯­ä¹‰ | å‰åç«¯å·¥ç¨‹å¸ˆ |
| **Part 5/6** | æ‰¹é‡ã€é€šçŸ¥ã€VNC ç­‰ä¸“é¡¹æµç¨‹ | å…¨æ ˆå·¥ç¨‹å¸ˆ |

### å…¨å±€è®¾è®¡ç»“è®ºï¼ˆå„ Stage ä¸å¾—è¦†ç›–ï¼‰

| ä¸»é¢˜ | è§„èŒƒç»“è®º |
|------|---------|
| **å‘½åæ²»ç†** | å¹³å°ç®¡ç†çš„é€»è¾‘åå¿…é¡»é€šè¿‡ ADR-0019 ç»Ÿä¸€æ ¡éªŒã€‚ |
| **å†™å…¥æ¨¡å‹** | çŠ¶æ€å˜æ›´æ“ä½œéµå¾ªç»Ÿä¸€å¼‚æ­¥æ¨¡å‹ï¼ˆ`request -> 202 -> River`ï¼‰ï¼Œè§ [ADR-0006 Â§Decision](../../../../adr/ADR-0006-unified-async-model.md#decision)ã€‚ |
| **äº‹ä»¶å®Œæ•´æ€§** | River Job é‡‡ç”¨ EventID-only claim-checkï¼›äº‹ä»¶ payload ä¸å¯å˜ï¼Œè§ [ADR-0009 Â§Constraint 1](../../../../adr/ADR-0009-domain-event-pattern.md#constraint-1-domainevent-payload-immutability-append-only)ã€‚ |
| **äº‹åŠ¡è¾¹ç•Œ** | è·¨èšåˆæ ¸å¿ƒå†™å…¥é‡‡ç”¨ Ent+sqlc åŸå­äº‹åŠ¡æ¨¡å‹ï¼Œè§ [ADR-0012 Â§Adopt Ent + sqlc Hybrid Mode](../../../../adr/ADR-0012-hybrid-transaction.md#adopt-ent-sqlc-hybrid-mode)ã€‚ |
| **åˆ é™¤è¯­ä¹‰** | ä¸»èµ„æºè¡¨ç¡¬åˆ é™¤ï¼ˆå¯çŸ­æš‚ `DELETING`ï¼‰ï¼›å®¡è®¡/å·¥å•/äº‹ä»¶ç‹¬ç«‹ä¿ç•™å¹¶å½’æ¡£ï¼Œè§ [ADR-0015 Â§13](../../../../adr/ADR-0015-governance-model-v2.md#13-deletion-cascade-constraints)ã€‚ |
| **æ‰¹é‡åŸºçº¿** | V1 æ‰¹é‡é‡‡ç”¨çˆ¶å­å·¥å• + ä¸¤å±‚é™æµï¼Œè§ [ADR-0015 Â§19](../../../../adr/ADR-0015-governance-model-v2.md#19-batch-operations)ã€‚ |

### è·¨å±‚æƒå¨å…³ç³»

| æ–‡æ¡£å±‚ | æƒå¨èŒƒå›´ |
|------|---------|
| [ADRs Â§Reading Order](../../../../adr/README.md#reading-order) | å·²æ¥å—æ¶æ„å†³ç­–ä¸æƒè¡¡ |
| `master-flow.md` | äº¤äº’æ„å›¾ä¸ç«¯åˆ°ç«¯é¢„æœŸè¡Œä¸º |
| [docs/design/README.md Â§Implementation Phases](../../../../design/README.md#implementation-phases) | å®ç°å¥‘çº¦ä¸è¿è¡Œçº¦æŸ |
| [database/README.md Â§Document Map](../../../../design/database/README.md#document-map) | æŒä¹…åŒ–ç”Ÿå‘½å‘¨æœŸã€ä¸€è‡´æ€§ä¸ Schema å½’å± |
| [frontend/README.md Â§Reading Order](../../../../design/frontend/README.md#reading-order) | UI äº¤äº’è§„èŒƒä¸åŠŸèƒ½çº§ UX è¡Œä¸º |
| [ci/README.md Â§Scope Boundary](../../../../design/ci/README.md#scope-boundary) | å¯æ‰§è¡Œé—¨ç¦ä¸é˜²æ¼‚ç§»æ£€æŸ¥ |

### è¾¹ç•Œå£°æ˜

- `master-flow.md` è´Ÿè´£äº¤äº’æ„å›¾ä¸è¡Œä¸ºé¢„æœŸã€‚
- SQL/DDL/ç´¢å¼•/è¿ç§»ç­‰æ•°æ®åº“ç»†èŠ‚å¿…é¡»å†™å…¥ `docs/design/database/`ã€‚
- ç»„ä»¶å®ç°ä¸ä»£ç çº§æ¨¡å¼å¿…é¡»å†™å…¥ `docs/design/phases/` ä¸ `docs/design/frontend/`ã€‚

---

## Part 1: å¹³å°åˆå§‹åŒ–æµç¨‹ {#stage-1}

### Purpose

å®šä¹‰ Schema é©±åŠ¨å¹³å°åˆå§‹åŒ–å’Œé¦–æ¬¡å®‰å…¨éƒ¨ç½²çš„é¢„æœŸè¡Œä¸ºã€‚

### Actors & Trigger

- è§¦å‘ï¼šé¦–æ¬¡éƒ¨ç½²æˆ–å¹³å°é…ç½®å˜æ›´ã€‚
- å‚ä¸æ–¹ï¼šå¼€å‘è€…ã€å¹³å°ç®¡ç†å‘˜ã€å¯åŠ¨å¼•å¯¼æµç¨‹ã€‚

### Interaction Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 1: å¹³å°åˆå§‹åŒ– (å¼€å‘è€…æ“ä½œ)                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  å¼€å‘è€…:                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. è·å– KubeVirt å®˜æ–¹ JSON Schema                                                       â”‚ â”‚
â”‚  â”‚    - æ¥æº: KubeVirt CRD OpenAPI Schema æˆ–å®˜æ–¹æ–‡æ¡£                                        â”‚ â”‚
â”‚  â”‚    - åŒ…å«: æ‰€æœ‰å­—æ®µç±»å‹ã€çº¦æŸã€enum é€‰é¡¹                                                  â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚ 2. å®šä¹‰ Mask é…ç½® (åªé€‰æ‹©è·¯å¾„ï¼Œä¸å®šä¹‰é€‰é¡¹)                                                â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚    mask:                                                                                 â”‚ â”‚
â”‚  â”‚      quick_fields:                                                                       â”‚ â”‚
â”‚  â”‚        - path: "spec.template.spec.domain.cpu.cores"                                     â”‚ â”‚
â”‚  â”‚          display_name: "CPU æ ¸æ•°"                                                        â”‚ â”‚
â”‚  â”‚      advanced_fields:                                                                    â”‚ â”‚
â”‚  â”‚        - path: "spec.template.spec.domain.devices.gpus"                                  â”‚ â”‚
â”‚  â”‚          display_name: "GPU è®¾å¤‡"                                                        â”‚ â”‚
â”‚  â”‚        - path: "spec.template.spec.domain.memory.hugepages.pageSize"                     â”‚ â”‚
â”‚  â”‚          display_name: "Hugepages å¤§å°"                                                  â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚    ğŸ‘‰ Mask åªå¼•ç”¨ Schema è·¯å¾„ï¼Œå­—æ®µç±»å‹å’Œé€‰é¡¹ç”± Schema å®šä¹‰                               â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚ 3. å‰ç«¯æ ¹æ® Schema + Mask è‡ªåŠ¨æ¸²æŸ“ UI                                                    â”‚ â”‚
â”‚  â”‚    - integer â†’ æ•°å­—è¾“å…¥æ¡†                                                                â”‚ â”‚
â”‚  â”‚    - string â†’ æ–‡æœ¬è¾“å…¥æ¡†                                                                 â”‚ â”‚
â”‚  â”‚    - boolean â†’ å¤é€‰æ¡†                                                                    â”‚ â”‚
â”‚  â”‚    - enum â†’ ä¸‹æ‹‰æ¡† (é€‰é¡¹æ¥è‡ª Schemaï¼Œä¸æ˜¯å¼€å‘è€…å®šä¹‰)                                       â”‚ â”‚
â”‚  â”‚    - array â†’ åŠ¨æ€æ·»åŠ /åˆ é™¤è¡¨æ ¼                                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€æµè½¬ï¼ˆé˜¶æ®µ 1ï¼‰

| é¢†åŸŸ | ä¹‹å‰ | ä¹‹å |
|------|------|------|
| Schema ç¼“å­˜ | æœªçŸ¥/ç©º | å…·å¤‡ç‰ˆæœ¬åŒ– schema |
| Mask é…ç½® | æœªå®šä¹‰ | æš´éœ²è·¯å¾„é€šè¿‡æ ¡éªŒ |
| UI æ¸²æŸ“èƒ½åŠ› | é™æ€/æ‰‹å·¥ | Schema é©±åŠ¨ |

### å¤±è´¥ä¸è¾¹ç•Œï¼ˆé˜¶æ®µ 1ï¼‰

- Schema è·å–å¤±è´¥å¿…é¡»é™çº§åˆ°åµŒå…¥å¼ schema åŸºçº¿ã€‚
- æ— æ•ˆ mask è·¯å¾„å¿…é¡»åœ¨éƒ¨ç½²å‰æ ¡éªŒå¤±è´¥ã€‚

### Authority Links (Part 1 baseline)

- [ADR-0023 Â§1 Schema Cache Management Policy](../../../../adr/ADR-0023-schema-cache-and-api-standards.md#1-schema-cache-management-policy)
- [01-contracts.md Â§API Contract-First Design](../../../../design/phases/01-contracts.md#api-contract-first-design-adr-0021)
- [frontend/FRONTEND.md Â§Schema Cache Degradation Strategy](../../../../design/frontend/FRONTEND.md#schema-cache-degradation-strategy-adr-0023)

### è¾¹ç•Œå£°æ˜ï¼ˆé˜¶æ®µ 1ï¼‰

æœ¬é˜¶æ®µå®šä¹‰åˆå§‹åŒ–æµç¨‹é¢„æœŸè¡Œä¸ºã€‚è¿ç§»æ­¥éª¤ä¸ä»£ç ç”Ÿæˆå‘½ä»¤ç»†èŠ‚åœ¨ phase/CI æ–‡æ¡£ä¸­ç»´æŠ¤ã€‚

#### Schema Cache ç”Ÿå‘½å‘¨æœŸå¼•ç”¨ {#schema-cache-lifecycle-adr-0023}

Schema ç¼“å­˜ç”Ÿå‘½å‘¨æœŸä¸é™çº§è¡Œä¸ºï¼Œè¯·ä»¥ä»¥ä¸‹æ–‡æ¡£ä¸ºå‡†ï¼š

- [ADR-0023 Â§1 Schema Cache Management Policy](../../../../adr/ADR-0023-schema-cache-and-api-standards.md#1-schema-cache-management-policy)
- [02-providers.md Â§6 Schema Cache Lifecycle](../../../../design/phases/02-providers.md#6-schema-cache-lifecycle-adr-0023)
- [frontend/FRONTEND.md Â§Schema Cache Degradation Strategy](../../../../design/frontend/FRONTEND.md#schema-cache-degradation-strategy-adr-0023)

### é˜¶æ®µ 1.5: é¦–æ¬¡éƒ¨ç½²å¼•å¯¼ (Bootstrap) {#stage-1-5}

> **Added 2026-01-26**: é…ç½®å­˜å‚¨ç­–ç•¥çš„é¦–æ¬¡éƒ¨ç½²æµç¨‹ã€‚
>
> **è¯¦ç»†è§„åˆ™**: Bootstrap Secrets ä¼˜å…ˆçº§å’Œè‡ªåŠ¨ç”Ÿæˆè¯¦è§ [ADR-0025 Â§Decision Outcome](../../../../adr/ADR-0025-secret-bootstrap.md#decision-outcome)ï¼Œå®ç°ç»†èŠ‚è¯¦è§ [01-contracts.md Â§3.2.2](../../../../design/phases/01-contracts.md#322-system-secrets-table-adr-0025)ã€‚

#### Purpose

ç»Ÿä¸€é¦–æ¬¡å¯åŠ¨æ—¶çš„é…ç½®ä¼˜å…ˆçº§ä¸å¯†é’¥å¼•å¯¼è¡Œä¸ºã€‚

#### Actors & Trigger

- è§¦å‘ï¼šç³»ç»Ÿé¦–æ¬¡å¯åŠ¨ä¸”è¿è¡Œæ€å¯†é’¥ä¸å­˜åœ¨ã€‚
- å‚ä¸æ–¹ï¼šéƒ¨ç½²æ“ä½œè€…ã€å¼•å¯¼é€»è¾‘ã€æ•°æ®åº“æŒä¹…åŒ–å±‚ã€‚

#### Interaction Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 1.5: é¦–æ¬¡éƒ¨ç½²å¼•å¯¼                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ğŸ”§ éƒ¨ç½²é…ç½® (äºŒé€‰ä¸€):                                                                         â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“ æ–¹å¼ A: config.yaml (æœ¬åœ°å¼€å‘ / ä¼ ç»Ÿéƒ¨ç½²)                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  # config.yaml                                                                          â”‚ â”‚
â”‚  â”‚  database:                                                                              â”‚ â”‚
â”‚  â”‚    url: "postgresql://user:pass@localhost:5432/shepherd"                                â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  server:                                                                                 â”‚ â”‚
â”‚  â”‚    port: 8080                                                                            â”‚ â”‚
â”‚  â”‚    log_level: "info"                     # å¯é€‰ï¼Œé»˜è®¤ info                                â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  worker:                                                                                 â”‚ â”‚
â”‚  â”‚    max_workers: 10                       # å¯é€‰ï¼Œé»˜è®¤ 10                                  â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  security:                                                                               â”‚ â”‚
â”‚  â”‚    encryption_key: "32-byte-random"      # å¯é€‰ï¼Œå¼ºçƒˆå»ºè®®                                â”‚ â”‚
â”‚  â”‚    session_secret: "32-byte-random"      # å¯é€‰ï¼Œå¼ºçƒˆå»ºè®®                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ³ æ–¹å¼ B: ç¯å¢ƒå˜é‡ (å®¹å™¨åŒ–éƒ¨ç½²)                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  DATABASE_URL=postgresql://user:pass@host:5432/shepherd    # å¿…éœ€                       â”‚ â”‚
â”‚  â”‚  SERVER_PORT=8080                        # å¯é€‰ï¼Œé»˜è®¤ 8080                               â”‚ â”‚
â”‚  â”‚  LOG_LEVEL=info                          # å¯é€‰ï¼Œé»˜è®¤ info                                â”‚ â”‚
â”‚  â”‚  RIVER_MAX_WORKERS=10                    # å¯é€‰ï¼Œé»˜è®¤ 10                                  â”‚ â”‚
â”‚  â”‚  ENCRYPTION_KEY=<32-byte-random>         # å¯é€‰ï¼Œå¼ºçƒˆå»ºè®®                                â”‚ â”‚
â”‚  â”‚  SESSION_SECRET=<32-byte-random>         # å¯é€‰ï¼Œå¼ºçƒˆå»ºè®®                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â”‚  âš¡ **å•ä¸€ä¼˜å…ˆçº§é“¾** (é‡è¦ - é¿å…æ­§ä¹‰):                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  é…ç½®ç±»å‹              â”‚  ä¼˜å…ˆçº§é“¾ (ä»é«˜åˆ°ä½)                                          â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚  ä¸€èˆ¬é…ç½®              â”‚  ç¯å¢ƒå˜é‡ â†’ config.yaml â†’ ä»£ç é»˜è®¤å€¼                            â”‚ â”‚
â”‚  â”‚  (ç«¯å£ã€æ—¥å¿—çº§åˆ«)       â”‚  ä¾‹: SERVER_PORT ç¯å¢ƒå˜é‡è¦†ç›– config.yaml ä¸­çš„ server.port    â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚  å¯†é’¥/æ•æ„Ÿé…ç½®          â”‚  ç¯å¢ƒå˜é‡ â†’ æ•°æ®åº“ç”Ÿæˆ (system_secrets è¡¨)                     â”‚ â”‚
â”‚  â”‚  (åŠ å¯†å¯†é’¥ã€ä¼šè¯å¯†é’¥)     â”‚  è‹¥è®¾ç½®äº† ENCRYPTION_KEY ç¯å¢ƒå˜é‡ â†’ ä½¿ç”¨å®ƒ (ä¸ç”Ÿæˆ)          â”‚ â”‚
â”‚  â”‚                        â”‚  è‹¥æœªè®¾ç½® ENCRYPTION_KEY â†’ è‡ªåŠ¨ç”Ÿæˆå¹¶å­˜å…¥æ•°æ®åº“               â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚  ğŸ”® V2+ (RFC-0017)     â”‚  å¤–éƒ¨ KMS â†’ ç¯å¢ƒå˜é‡ â†’ æ•°æ®åº“ç”Ÿæˆ                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â”‚  âš ï¸ **å…³é”®åŸåˆ™**: config.yaml ä¸æ˜¯å¯†é’¥æ¥æº (12-factor app åˆè§„)ã€‚                             â”‚
â”‚     å¯†é’¥å¿…é¡»æ¥è‡ª: ç¯å¢ƒå˜é‡ æˆ– æ•°æ®åº“ç”Ÿæˆ æˆ– å¤–éƒ¨å¯†é’¥ç®¡ç†å™¨ã€‚                                      â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ” è‡ªåŠ¨ç”Ÿæˆï¼ˆç¼ºçœæ—¶ï¼‰:                                                                      â”‚
â”‚  - é¦–æ¬¡å¯åŠ¨è‹¥ç¼ºå°‘ ENCRYPTION_KEY / SESSION_SECRETï¼Œè‡ªåŠ¨ç”Ÿæˆ 32 å­—èŠ‚å¼ºéšæœºå¯†é’¥ï¼ˆCSPRNGï¼‰        â”‚
â”‚  - æŒä¹…åŒ–å­˜å…¥ PostgreSQL `system_secrets` è¡¨ (ç¦æ­¢ä»…å†…å­˜ä¸´æ—¶å¯†é’¥)                             â”‚
â”‚  - åç»­å¼•å…¥å¤–éƒ¨å¯†é’¥æ—¶ï¼Œéœ€æ‰§è¡Œæ˜¾å¼é‡åŠ å¯†æ­¥éª¤                                                   â”‚
â”‚  - ğŸ”„ å¯†é’¥è½®æ¢æ¨è¿Ÿåˆ° RFC-0016 (ä¸åœ¨ V1 èŒƒå›´å†…)                                                â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ åº”ç”¨è‡ªåŠ¨åˆå§‹åŒ–:                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. è¿è¡Œ migrations                                                                    â”‚ â”‚
â”‚  â”‚  2. Seed å†…ç½®è§’è‰² (ON CONFLICT DO NOTHING - ä¸è¦†ç›–å·²æœ‰)                                 â”‚ â”‚
â”‚  â”‚  3. Seed é»˜è®¤ç®¡ç†å‘˜ admin/admin (force_password_change=true)                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ–¥ï¸ é¦–æ¬¡ç™»å½•æç¤º:                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚                    âš ï¸ é¦–æ¬¡ç™»å½•                                                       â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    è¯·ä½¿ç”¨é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·ç™»å½•:                                                          â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    ç”¨æˆ·å: admin                                                                     â”‚   â”‚
â”‚  â”‚    å¯†ç :   admin                                                                     â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    âš ï¸ ç™»å½•åè¯·ç«‹å³ä¿®æ”¹å¯†ç !                                                          â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    [ç™»å½•]                                                                            â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ” å¼ºåˆ¶ä¿®æ”¹å¯†ç :                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚                    ğŸ” è¯·è®¾ç½®æ–°å¯†ç                                                    â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    æ‚¨æ­£åœ¨ä½¿ç”¨é»˜è®¤å¯†ç ï¼Œè¯·ç«‹å³ä¿®æ”¹ä»¥ä¿è¯è´¦æˆ·å®‰å…¨ã€‚                                      â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    æ–°å¯†ç :     [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢                ]                                        â”‚   â”‚
â”‚  â”‚    ç¡®è®¤å¯†ç :   [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢                ]                                        â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    å¯†ç è¦æ±‚ (NIST 800-63B):                                                          â”‚   â”‚
â”‚  â”‚    âœ“ æœ€å°‘ 8 ä¸ªå­—ç¬¦ï¼ˆå»ºè®® 15+ å­—ç¬¦ï¼‰                                                   â”‚   â”‚
â”‚  â”‚    âœ“ ä¸åœ¨å¸¸è§å¯†ç é»‘åå•ä¸­                                                             â”‚   â”‚
â”‚  â”‚    â—‹ å¤æ‚åº¦è§„åˆ™é»˜è®¤ä¸å¼ºåˆ¶ï¼ˆå¯é…ç½®ä»¥æ»¡è¶³åˆè§„è¦æ±‚ï¼‰                                       â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â”‚    [ç¡®è®¤ä¿®æ”¹]                                                                        â”‚   â”‚
â”‚  â”‚                                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ:                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  -- Seed é»˜è®¤ç®¡ç†å‘˜ (é¦–æ¬¡å¯åŠ¨)                                                      â”‚       â”‚
â”‚  â”‚  INSERT INTO users (id, username, password_hash, auth_type, force_password_change) â”‚       â”‚
â”‚  â”‚  VALUES ('admin', 'admin', bcrypt('admin'), 'local', true)                         â”‚       â”‚
â”‚  â”‚  ON CONFLICT (username) DO NOTHING;                                                 â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- å…³è” PlatformAdmin è§’è‰²                                                         â”‚       â”‚
â”‚  â”‚  INSERT INTO role_bindings (id, user_id, role_id, scope_type, source)              â”‚       â”‚
â”‚  â”‚  VALUES ('rb-admin', 'admin', 'role-platform-admin', 'global', 'seed')             â”‚       â”‚
â”‚  â”‚  ON CONFLICT DO NOTHING;                                                            â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- ä¿®æ”¹å¯†ç å                                                                       â”‚       â”‚
â”‚  â”‚  UPDATE users SET                                                                   â”‚       â”‚
â”‚  â”‚    password_hash = bcrypt('new_password'),                                          â”‚       â”‚
â”‚  â”‚    force_password_change = false,                                                   â”‚       â”‚
â”‚  â”‚    updated_at = NOW()                                                               â”‚       â”‚
â”‚  â”‚  WHERE id = 'admin';                                                                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- å®¡è®¡æ—¥å¿—                                                                         â”‚       â”‚
â”‚  â”‚  INSERT INTO audit_logs (action, actor_id, resource_type, resource_id, details)    â”‚       â”‚
â”‚  â”‚  VALUES ('user.password_change', 'admin', 'user', 'admin',                         â”‚       â”‚
â”‚  â”‚          '{"reason": "first_login_forced"}');                                       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  âœ… å®Œæˆåè¿›å…¥ç®¡ç†åå°ï¼Œç»§ç»­é˜¶æ®µ 2                                                            â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### State Transitions

| èŒƒå›´ | ä¹‹å‰ | ä¹‹å |
|------|------|------|
| é»˜è®¤ç®¡ç†å‘˜ | æ—  | å·²åˆå§‹åŒ–ï¼ˆ`force_password_change=true`ï¼‰ |
| æ ¸å¿ƒå¯†é’¥ | æœªè®¾ç½® | æ¥è‡ªç¯å¢ƒå˜é‡æˆ–è‡ªåŠ¨ç”Ÿæˆå¹¶æŒä¹…åŒ– |
| å†…ç½®è§’è‰² | æœªåˆå§‹åŒ– | åŸºçº¿è§’è‰²å·²è½åº“ï¼ˆå¹‚ç­‰ seedï¼‰ |

#### Failure & Edge Cases

- ç¼ºå°‘å¿…éœ€æ•°æ®åº“è¿æ¥æ—¶å¿…é¡»åœ¨éƒ¨åˆ†å†™å…¥å‰ä¸­æ­¢å¯åŠ¨ã€‚
- å¯†é’¥ç”Ÿæˆä¸æŒä¹…åŒ–å¿…é¡»åŸå­å®Œæˆï¼Œé¿å…è¿›å…¥ä¸å¯æ¢å¤çŠ¶æ€ã€‚

#### Authority Links

- [ADR-0025 Â§Decision Outcome](../../../../adr/ADR-0025-secret-bootstrap.md#decision-outcome)
- [01-contracts.md Â§3.2.2 System Secrets Table](../../../../design/phases/01-contracts.md#322-system-secrets-table-adr-0025)
- [00-prerequisites.md Â§7 CI Pipeline](../../../../design/phases/00-prerequisites.md#7-ci-pipeline)
- [00-prerequisites.md Â§8 Data Initialization](../../../../design/phases/00-prerequisites.md#8-data-initialization-adr-0018)

#### Scope Boundary

æœ¬èŠ‚ä»…å®šä¹‰é¦–æ¬¡éƒ¨ç½²è¡Œä¸ºä¸ç»“æœã€‚å¯†é’¥è½®æ¢ä¸é«˜çº§è¿ç»´æµç¨‹ä¸åœ¨æœ¬èŠ‚å±•å¼€ã€‚

### é˜¶æ®µ 2: å¹³å°å®‰å…¨é…ç½® (é¦–æ¬¡éƒ¨ç½²) {#stage-2}

> **å‚è€ƒ**: ADR-0015 Â§22 (Authentication & RBAC Strategy)

<a id="stage-2-a"></a>
<a id="stage-2-a-plus"></a>
<a id="stage-2-b"></a>
<a id="stage-2-c"></a>
<a id="stage-2-d"></a>

#### Purpose

å»ºç«‹ä¸šåŠ¡æµé‡è¿›å…¥å‰å¿…é¡»å…·å¤‡çš„è®¤è¯ã€é‰´æƒä¸å®‰å…¨åŸºçº¿ã€‚

#### Actors & Trigger

- è§¦å‘ï¼šé¦–æ¬¡éƒ¨ç½²åæ‰§è¡Œå®‰å…¨åˆå§‹åŒ–ã€‚
- å‚ä¸æ–¹ï¼šå¼•å¯¼è¿›ç¨‹ã€å¹³å°ç®¡ç†å‘˜ã€èº«ä»½æºé›†æˆé…ç½®ã€‚

#### Interaction Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 2.A: å†…ç½®è§’è‰²ä¸æƒé™åˆå§‹åŒ–                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ğŸ”§ ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œ (Seed Data):                                                                 â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ:                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  -- 1. å†…ç½®æƒé™ (Permissions)                                                      â”‚       â”‚
â”‚  â”‚  INSERT INTO permissions (id, resource, action, name) VALUES                      â”‚       â”‚
â”‚  â”‚    ('system:read', 'system', 'read', 'æŸ¥çœ‹ç³»ç»Ÿ'),                                  â”‚       â”‚
â”‚  â”‚    ('system:write', 'system', 'write', 'ä¿®æ”¹ç³»ç»Ÿ'),                                â”‚       â”‚
â”‚  â”‚    ('system:delete', 'system', 'delete', 'åˆ é™¤ç³»ç»Ÿ'),                              â”‚       â”‚
â”‚  â”‚    ('service:read', 'service', 'read', 'æŸ¥çœ‹æœåŠ¡'),                                â”‚       â”‚
â”‚  â”‚    ('service:create', 'service', 'create', 'åˆ›å»ºæœåŠ¡'),                            â”‚       â”‚
â”‚  â”‚    ('service:delete', 'service', 'delete', 'åˆ é™¤æœåŠ¡'),                            â”‚       â”‚
â”‚  â”‚    ('vm:read', 'vm', 'read', 'æŸ¥çœ‹VM'),                                           â”‚       â”‚
â”‚  â”‚    ('vm:create', 'vm', 'create', 'åˆ›å»ºVMè¯·æ±‚'),                                   â”‚       â”‚
â”‚  â”‚    ('vm:operate', 'vm', 'operate', 'VMæ“ä½œ(å¯åœ)'),                                â”‚       â”‚
â”‚  â”‚    ('vm:delete', 'vm', 'delete', 'åˆ é™¤VM'),                                       â”‚       â”‚
â”‚  â”‚    ('vnc:access', 'vnc', 'access', 'VNCæ§åˆ¶å°'),                                   â”‚       â”‚
â”‚  â”‚    ('approval:approve', 'approval', 'approve', 'å®¡æ‰¹è¯·æ±‚'),                        â”‚       â”‚
â”‚  â”‚    ('approval:view', 'approval', 'view', 'æŸ¥çœ‹å¾…å®¡æ‰¹'),                             â”‚       â”‚
â”‚  â”‚    ('cluster:manage', 'cluster', 'manage', 'ç®¡ç†é›†ç¾¤'),                            â”‚       â”‚
â”‚  â”‚    ('template:manage', 'template', 'manage', 'ç®¡ç†æ¨¡æ¿'),                          â”‚       â”‚
â”‚  â”‚    ('rbac:manage', 'rbac', 'manage', 'ç®¡ç†æƒé™'),                                  â”‚       â”‚
â”‚  â”‚    ('platform:admin', 'platform', 'admin', 'è¶…çº§ç®¡ç†å‘˜æƒé™ï¼ˆæ˜¾å¼ï¼‰');               â”‚       â”‚
â”‚  â”‚    -- âš ï¸ ADR-0019 RBAC åˆè§„:                                                        â”‚       â”‚
â”‚  â”‚    -- æ‰€æœ‰è§’è‰²ä½¿ç”¨æ˜¾å¼æƒé™ã€‚é€šé…ç¬¦æ¨¡å¼ (*:*) å·²ç¦æ­¢ã€‚                                â”‚       â”‚
â”‚  â”‚    -- platform:admin æ˜¯æ˜¾å¼è¶…ç®¡æƒé™ï¼ˆç¼–è¯‘æ—¶å¸¸é‡ï¼‰ã€‚                                  â”‚       â”‚
â”‚  â”‚    -- Bootstrap è§’è‰²ä½¿ç”¨ platform:admin ä¸”å¿…é¡»åœ¨åˆå§‹åŒ–åç¦ç”¨ã€‚                       â”‚       â”‚
â”‚  â”‚    -- Bootstrap è§’è‰²ç¦ç”¨ SOP è§æ¡†å Markdown è¯´æ˜ã€‚                             â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 2. å†…ç½®è§’è‰² (ADR-0019 åˆè§„)                                                    â”‚       â”‚
â”‚  â”‚  INSERT INTO roles (id, name, is_builtin, description) VALUES                     â”‚       â”‚
â”‚  â”‚    ('role-bootstrap', 'Bootstrap', true, 'åˆå§‹åŒ–ä¸“ç”¨ - éƒ¨ç½²åå¿…é¡»ç¦ç”¨'),            â”‚       â”‚
â”‚  â”‚    ('role-platform-admin', 'PlatformAdmin', true, 'å¹³å°ç®¡ç†å‘˜'),                   â”‚       â”‚
â”‚  â”‚    ('role-system-admin', 'SystemAdmin', true, 'ç³»ç»Ÿç®¡ç†å‘˜'),                        â”‚       â”‚
â”‚  â”‚    ('role-approver', 'Approver', true, 'å®¡æ‰¹å‘˜'),                                  â”‚       â”‚
â”‚  â”‚    ('role-operator', 'Operator', true, 'è¿ç»´äººå‘˜'),                                 â”‚       â”‚
â”‚  â”‚    ('role-viewer', 'Viewer', true, 'åªè¯»ç”¨æˆ·');                                    â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 3. è§’è‰²-æƒé™å…³è” (ADR-0019: ç¦æ­¢é€šé…ç¬¦ï¼Œä»…ä½¿ç”¨æ˜¾å¼æƒé™)                          â”‚       â”‚
â”‚  â”‚  INSERT INTO role_permissions (role_id, permission_id) VALUES                     â”‚       â”‚
â”‚  â”‚    -- Bootstrap è§’è‰²: platform:admin (æ˜¾å¼è¶…ç®¡æƒé™ï¼Œåˆå§‹åŒ–åå¿…é¡»ç¦ç”¨)                â”‚       â”‚
â”‚  â”‚    ('role-bootstrap', 'platform:admin'),                                           â”‚       â”‚
â”‚  â”‚    -- PlatformAdmin: platform:admin (ADR-0019 æ˜¾å¼è¶…ç®¡æƒé™)                         â”‚       â”‚
â”‚  â”‚    ('role-platform-admin', 'platform:admin'),                                      â”‚       â”‚
â”‚  â”‚    -- Approver: æ˜¾å¼æƒé™ (ADR-0019 ç¦æ­¢é€šé…ç¬¦)                                       â”‚       â”‚
â”‚  â”‚    ('role-approver', 'approval:approve'), ('role-approver', 'approval:view'),      â”‚       â”‚
â”‚  â”‚    ('role-approver', 'vm:read'), ('role-approver', 'system:read'),                 â”‚       â”‚
â”‚  â”‚    ('role-approver', 'service:read'),                                              â”‚       â”‚
â”‚  â”‚    -- SystemAdmin, Operator, Viewer: æ˜¾å¼æƒé™                                       â”‚       â”‚
â”‚  â”‚    ('role-system-admin', 'system:read'), ('role-system-admin', 'system:write'),    â”‚       â”‚
â”‚  â”‚    ('role-system-admin', 'system:delete'), ('role-system-admin', 'service:read'),  â”‚       â”‚
â”‚  â”‚    ('role-system-admin', 'service:create'), ('role-system-admin', 'service:delete'),â”‚      â”‚
â”‚  â”‚    ('role-system-admin', 'vm:read'), ('role-system-admin', 'vm:create'),           â”‚       â”‚
â”‚  â”‚    ('role-system-admin', 'vm:operate'), ('role-system-admin', 'vm:delete'),        â”‚       â”‚
â”‚  â”‚    ('role-system-admin', 'vnc:access'), ('role-system-admin', 'rbac:manage'),      â”‚       â”‚
â”‚  â”‚    ('role-operator', 'system:read'), ('role-operator', 'service:read'),            â”‚       â”‚
â”‚  â”‚    ('role-operator', 'vm:read'), ('role-operator', 'vm:create'),                   â”‚       â”‚
â”‚  â”‚    ('role-operator', 'vm:operate'), ('role-operator', 'vnc:access'),               â”‚       â”‚
â”‚  â”‚    ('role-viewer', 'system:read'), ('role-viewer', 'service:read'),                â”‚       â”‚
â”‚  â”‚    ('role-viewer', 'vm:read');                                                     â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- âš ï¸ ADR-0019 å®‰å…¨ SOP:                                                           â”‚       â”‚
â”‚  â”‚  -- å¹³å°åˆå§‹åŒ–å®Œæˆåï¼Œå¿…é¡»ç¦ç”¨ bootstrap è§’è‰²:                                        â”‚       â”‚
â”‚  â”‚  --   DELETE FROM role_bindings WHERE role_id = 'role-bootstrap';                  â”‚       â”‚
â”‚  â”‚  -- å®Œæ•´æ‰§è¡Œæ­¥éª¤è§æ¡†å Markdown è¯´æ˜ã€‚                                             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 2.A+: è‡ªå®šä¹‰è§’è‰²ç®¡ç† (å¯é€‰)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  å¹³å°ç®¡ç†å‘˜æ“ä½œ (åœ¨ OIDC é…ç½®ä¹‹å‰æˆ–ä¹‹åå‡å¯):                                                    â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ Step 1: åˆ›å»ºè‡ªå®šä¹‰è§’è‰² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â”‚  è§’è‰²ç®¡ç†                                                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  è§’è‰²åˆ—è¡¨:                                                                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ğŸ”’] PlatformAdmin          å†…ç½®    å¹³å°ç®¡ç†å‘˜-å…¨éƒ¨æƒé™                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ğŸ”’] SystemAdmin            å†…ç½®    ç³»ç»Ÿç®¡ç†å‘˜                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ğŸ”’] Approver               å†…ç½®    å®¡æ‰¹å‘˜                                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ğŸ”’] Operator               å†…ç½®    è¿ç»´äººå‘˜                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ğŸ”’] Viewer                 å†…ç½®    åªè¯»ç”¨æˆ·                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [  ] DevLead                è‡ªå®šä¹‰   å¼€å‘ä¸»ç®¡ (å¯ç¼–è¾‘/åˆ é™¤)                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [  ] QA-Manager             è‡ªå®šä¹‰   QA ç®¡ç†å‘˜ (å¯ç¼–è¾‘/åˆ é™¤)                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [+ åˆ›å»ºè‡ªå®šä¹‰è§’è‰²]                                                               â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ Step 2: é…ç½®è‡ªå®šä¹‰è§’è‰²æƒé™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â”‚  åˆ›å»ºè‡ªå®šä¹‰è§’è‰²                                                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  è§’è‰²åç§°:     [DevLead              ]                                           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  è§’è‰²æè¿°:     [å¼€å‘ä¸»ç®¡-å¯ç®¡ç†ç³»ç»Ÿå’ŒæœåŠ¡]                                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  é€‰æ‹©æƒé™ (å…¨å±€æƒé™):                                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€ ç³»ç»Ÿç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€ å®¡æ‰¹ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜‘ system:read              â”‚  â”‚ â˜ approval:approve        â”‚                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜‘ system:write             â”‚  â”‚ â˜ approval:view           â”‚                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜ system:delete            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€ æœåŠ¡ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€ å¹³å°ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜‘ service:read             â”‚  â”‚ â˜ cluster:manage          â”‚                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜‘ service:create           â”‚  â”‚ â˜ template:manage         â”‚                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜ service:delete           â”‚  â”‚ â˜ rbac:manage             â”‚                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€ VM ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜‘ vm:read                  â”‚                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜‘ vm:create                â”‚                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜‘ vm:operate               â”‚                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜ vm:delete                â”‚                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â˜‘ vnc:access               â”‚                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ä¿å­˜è§’è‰²]                                                                        â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ:                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  -- åˆ›å»ºè‡ªå®šä¹‰è§’è‰²                                                                  â”‚       â”‚
â”‚  â”‚  INSERT INTO roles (id, name, is_builtin, description) VALUES                     â”‚       â”‚
â”‚  â”‚    ('role-dev-lead', 'DevLead', false, 'å¼€å‘ä¸»ç®¡-å¯ç®¡ç†ç³»ç»Ÿå’ŒæœåŠ¡');                 â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- å…³è”æƒé™                                                                        â”‚       â”‚
â”‚  â”‚  INSERT INTO role_permissions (role_id, permission_id) VALUES                     â”‚       â”‚
â”‚  â”‚    ('role-dev-lead', 'system:read'), ('role-dev-lead', 'system:write'),           â”‚       â”‚
â”‚  â”‚    ('role-dev-lead', 'service:read'), ('role-dev-lead', 'service:create'),        â”‚       â”‚
â”‚  â”‚    ('role-dev-lead', 'vm:read'), ('role-dev-lead', 'vm:create'),                  â”‚       â”‚
â”‚  â”‚    ('role-dev-lead', 'vm:operate'), ('role-dev-lead', 'vnc:access');              â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ’¡ è‡ªå®šä¹‰è§’è‰²åˆ›å»ºåï¼Œå¯åœ¨ OIDC ç»„æ˜ å°„ (é˜¶æ®µ 2.C) ä¸­é€‰æ‹©ä½¿ç”¨                                     â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼

> **æ ‡å‡†åŒ– Provider è¾“å‡º**ï¼šæ‰€æœ‰è®¤è¯æä¾›æ–¹ï¼ˆOIDC/LDAP/SSOï¼‰é€šè¿‡é€‚é…å±‚ç»Ÿä¸€æˆæ ‡å‡†è¾“å‡ºï¼Œç”¨äº RBAC æ˜ å°„ã€‚è§ [ADR-0026 Â§Standard Provider Output](../../../../adr/ADR-0026-idp-config-naming.md#standard-provider-output-contract)ã€‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 2.B: é…ç½®è®¤è¯æ–¹å¼ (OIDC/LDAP)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  å¹³å°ç®¡ç†å‘˜æ“ä½œ:                                                                               â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ Step 1: é€‰æ‹©è®¤è¯æ–¹å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â”‚  é…ç½®èº«ä»½è®¤è¯                                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  è®¤è¯æ–¹å¼:                                                                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â—‰ OIDC (æ¨è)   - é€‚ç”¨äº: Azure AD, Okta, Keycloak, Google Workspace           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â—‹ LDAP          - é€‚ç”¨äº: Active Directory, OpenLDAP                           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â—‹ å†…ç½®ç”¨æˆ·       - ä»…ç”¨äºæµ‹è¯•ç¯å¢ƒ                                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ä¸‹ä¸€æ­¥ â†’]                                                                      â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ Step 2: OIDC é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â”‚  OIDC Provider é…ç½®                                                                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  Provider åç§°:  [Corp-SSO                    ]                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Issuer URL:     [https://sso.company.com/realms/main]                           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Client ID:      [shepherd-platform           ]                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Client Secret:  [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢                ] ğŸ‘                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Callback URL (å¤åˆ¶åˆ° IdP):                                                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ“‹ https://shepherd.company.com/api/v1/auth/oidc/callback                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [æµ‹è¯•è¿æ¥]  [ä¿å­˜é…ç½®]                                                           â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ:                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  INSERT INTO auth_providers (id, type, name, enabled, issuer, client_id,           â”‚       â”‚
â”‚  â”‚    client_secret_encrypted, scopes, claims_mapping, default_role_id,               â”‚       â”‚
â”‚  â”‚    default_allowed_environments) VALUES                                            â”‚       â”‚
â”‚  â”‚  ('idp-001', 'oidc', 'Corp-SSO', true, 'https://sso.company.com/realms/main',       â”‚       â”‚
â”‚  â”‚   'shepherd-platform', 'encrypted:xxx', ARRAY['openid','profile','email'],         â”‚       â”‚
â”‚  â”‚   '{"groups":"groups","groups_format":"array"}', 'role-viewer', ARRAY['test']);    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 2.C: IdP ç»„æ˜ å°„é…ç½®                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  å¹³å°ç®¡ç†å‘˜æ“ä½œ:                                                                               â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ Step 1: è·å–æ ·æœ¬ç”¨æˆ·æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â”‚  API: GET /api/v1/admin/auth-providers/{id}/sample                                               â”‚   â”‚
â”‚  â”‚  ç³»ç»Ÿä» IdP æ‹‰å– 10 ä¸ªç”¨æˆ·çš„ Token æ•°æ®ï¼Œæå–å¯ç”¨å­—æ®µ:                                    â”‚   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  æ£€æµ‹åˆ°çš„å­—æ®µ:                                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â—‰ groups (array, 5 ä¸ªå”¯ä¸€å€¼)                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚     æ ·æœ¬: ["DevOps-Team", "QA-Team", "Platform-Admin", ...]                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â—‹ department (string, 3 ä¸ªå”¯ä¸€å€¼)                                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚     æ ·æœ¬: ["Engineering", "IT", "QA"]                                             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â—‹ custom_roles (array, 2 ä¸ªå”¯ä¸€å€¼)                                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚     æ ·æœ¬: ["admin", "developer"]                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [åŒæ­¥é€‰ä¸­å­—æ®µ â†’]                                                                 â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ Step 2: é…ç½®ç»„-è§’è‰²æ˜ å°„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â”‚  IdP Group â†’ Shepherd Role æ˜ å°„                                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  IdP ç»„              Shepherd è§’è‰²      å¯è®¿é—®ç¯å¢ƒ                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Platform-Admin     [PlatformAdmin â–¼]   â˜‘ test  â˜‘ prod                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  DevOps-Team        [SystemAdmin â–¼]     â˜‘ test  â˜‘ prod                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  QA-Team            [Operator â–¼]        â˜‘ test  â˜ prod                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  IT-Support         [Viewer â–¼]          â˜‘ test  â˜ prod                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  HR-Department      [æ— æ˜ å°„ â–¼]          -                                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ’¡ æœªæ˜ å°„çš„ç»„é»˜è®¤è·å¾—: Viewer æƒé™ + ä»… test ç¯å¢ƒ                                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ä¿å­˜æ˜ å°„]                                                                       â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ:                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  -- åŒæ­¥ IdP ç»„                                                                    â”‚       â”‚
â”‚  â”‚  INSERT INTO idp_synced_groups (id, auth_provider_id, group_id, source_field)     â”‚       â”‚
â”‚  â”‚  VALUES ('sg-001', 'idp-001', 'Platform-Admin', 'groups'),                        â”‚       â”‚
â”‚  â”‚         ('sg-002', 'idp-001', 'DevOps-Team', 'groups'),                           â”‚       â”‚
â”‚  â”‚         ('sg-003', 'idp-001', 'QA-Team', 'groups');                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- ä¿å­˜æ˜ å°„å…³ç³»                                                                    â”‚       â”‚
â”‚  â”‚  INSERT INTO idp_group_mappings (id, auth_provider_id, idp_group_id, role_id,     â”‚       â”‚
â”‚  â”‚                                  scope_type, allowed_environments) VALUES         â”‚       â”‚
â”‚  â”‚    ('map-001', 'idp-001', 'Platform-Admin', 'role-platform-admin',                â”‚       â”‚
â”‚  â”‚     'global', ARRAY['test', 'prod']),                                             â”‚       â”‚
â”‚  â”‚    ('map-002', 'idp-001', 'DevOps-Team', 'role-system-admin',                     â”‚       â”‚
â”‚  â”‚     'global', ARRAY['test', 'prod']),                                             â”‚       â”‚
â”‚  â”‚    ('map-003', 'idp-001', 'QA-Team', 'role-operator',                             â”‚       â”‚
â”‚  â”‚     'global', ARRAY['test']);                                                     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 2.D: ç”¨æˆ·ç™»å½•æµç¨‹                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ç”¨æˆ·é¦–æ¬¡ç™»å½•:                                                                                â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. ç”¨æˆ·è®¿é—® https://shepherd.company.com                                              â”‚ â”‚
â”‚  â”‚                                                                                        â”‚ â”‚
â”‚  â”‚  2. é‡å®šå‘åˆ° IdP ç™»å½•é¡µé¢                                                               â”‚ â”‚
â”‚  â”‚     â†’ https://sso.company.com/realms/main/protocol/openid-connect/auth?                â”‚ â”‚
â”‚  â”‚       client_id=shepherd-platform&redirect_uri=...                                     â”‚ â”‚
â”‚  â”‚                                                                                        â”‚ â”‚
â”‚  â”‚  3. ç”¨æˆ·åœ¨ IdP å®Œæˆè®¤è¯                                                                 â”‚ â”‚
â”‚  â”‚                                                                                        â”‚ â”‚
â”‚  â”‚  4. IdP å›è°ƒ Shepherd                                                                  â”‚ â”‚
â”‚  â”‚     â† https://shepherd.company.com/api/v1/auth/oidc/callback?code=xxx                  â”‚ â”‚
â”‚  â”‚                                                                                        â”‚ â”‚
â”‚  â”‚  5. Shepherd å¤„ç†:                                                                      â”‚ â”‚
â”‚  â”‚     a. éªŒè¯ Token (ç­¾åã€issuerã€audience)                                             â”‚ â”‚
â”‚  â”‚     b. æå–ç”¨æˆ·ä¿¡æ¯ (sub, email, name, groups)                                         â”‚ â”‚
â”‚  â”‚     c. æ ¹æ® groups æŸ¥æ‰¾ idp_group_mappings                                             â”‚ â”‚
â”‚  â”‚     d. åˆ›å»º/æ›´æ–°ç”¨æˆ·è®°å½•                                                                â”‚ â”‚
â”‚  â”‚     e. åˆ›å»º RoleBindings (åŸºäºæ˜ å°„)                                                     â”‚ â”‚
â”‚  â”‚     f. è¿”å› JWT Session Token                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ (ç”¨æˆ·é¦–æ¬¡ç™»å½•):                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  BEGIN TRANSACTION;                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 1. åˆ›å»ºç”¨æˆ·è®°å½• (å¦‚æœä¸å­˜åœ¨)                                                     â”‚       â”‚
â”‚  â”‚  INSERT INTO users (id, external_id, email, name, auth_provider_id, created_at)   â”‚       â”‚
â”‚  â”‚  VALUES ('user-001', 'oidc|abc123', 'zhang.san@company.com', 'å¼ ä¸‰',               â”‚       â”‚
â”‚  â”‚          'idp-001', NOW())                                                         â”‚       â”‚
â”‚  â”‚  ON CONFLICT (external_id) DO UPDATE SET last_login_at = NOW();                   â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 2. åˆ é™¤æ—§çš„ IdP è‡ªåŠ¨åˆ†é…çš„ RoleBindings (æ ‡è®°ä¸º auto_assigned)                   â”‚       â”‚
â”‚  â”‚  DELETE FROM role_bindings                                                         â”‚       â”‚
â”‚  â”‚  WHERE user_id = 'user-001' AND source = 'idp_mapping';                           â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 3. æ ¹æ®ç”¨æˆ·çš„ groups é‡æ–°åˆ›å»º RoleBindings                                       â”‚       â”‚
â”‚  â”‚  -- (ç”¨æˆ· groups: ['DevOps-Team'] â†’ æ˜ å°„åˆ° role-system-admin)                       â”‚       â”‚
â”‚  â”‚  INSERT INTO role_bindings (id, user_id, role_id, scope_type,                     â”‚       â”‚
â”‚  â”‚                             allowed_environments, source) VALUES                  â”‚       â”‚
â”‚  â”‚    ('rb-auto-001', 'user-001', 'role-system-admin', 'global',                     â”‚       â”‚
â”‚  â”‚     ARRAY['test', 'prod'], 'idp_mapping');                                        â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  COMMIT;                                                                          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç”¨æˆ·ç™»å½•æ–¹å¼æ€»ç»“

| ç™»å½•æ–¹å¼ | é€‚ç”¨åœºæ™¯ | æƒé™æ¥æº |
|----------|----------|----------|
| **OIDC** | ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰ | IdP ç»„ â†’ æ˜ å°„è§„åˆ™ â†’ RoleBindings |
| **LDAP** | é—ç•™ AD ç¯å¢ƒ | LDAP ç»„ â†’ æ˜ å°„è§„åˆ™ â†’ RoleBindings |
| **å†…ç½®ç”¨æˆ·** | å¼€å‘/æµ‹è¯• | æ‰‹åŠ¨åˆ›å»ºç”¨æˆ·å’Œ RoleBindings |

#### åŒå±‚æƒé™ä½“ç³»æ€»ç»“

| ç»´åº¦ | å…¨å±€ RBAC | èµ„æºçº§ RBAC |
|------|-----------|-------------|
| **å­˜å‚¨è¡¨** | `role_bindings` | `resource_role_bindings` |
| **æƒé™èŒƒå›´** | å¹³å°çº§æ“ä½œ | ç‰¹å®šèµ„æºè®¿é—® |
| **è§’è‰²ç±»å‹** | PlatformAdmin, SystemAdmin, Approver, Operator, Viewer, è‡ªå®šä¹‰è§’è‰² | Owner, Admin, Member, Viewer |
| **æˆæƒæ–¹å¼** | ç®¡ç†å‘˜é€šè¿‡ OIDC ç»„æ˜ å°„æˆ–æ‰‹åŠ¨åˆ†é… | èµ„æºåˆ›å»ºè€…è‡ªè¡Œæ·»åŠ æˆå‘˜ |
| **å…¸å‹åœºæ™¯** | "å¼ ä¸‰å¯ä»¥å®¡æ‰¹ VM è¯·æ±‚" | "æå››å¯ä»¥è®¿é—®å¼ ä¸‰çš„ shop ç³»ç»Ÿ" |
| **å¯è§æ€§æ§åˆ¶** | æ— ï¼ˆå…¨å±€æƒé™ï¼‰ | æœ‰ï¼ˆä»…æˆå‘˜å¯è§ï¼‰ |
| **ç»§æ‰¿æ¨¡å‹** | N/A | âœ… Service/VM å®Œå…¨ç»§æ‰¿ System æƒé™ |

#### æƒé™æ£€æŸ¥é€»è¾‘

> **ä¸¤å±‚æƒé™ä½“ç³»**: Shepherd é‡‡ç”¨åŒå±‚æƒé™è®¾è®¡ï¼š
> - **å…¨å±€ RBAC (role_bindings)**: æ§åˆ¶å¹³å°çº§æ“ä½œæƒé™ï¼ˆç®¡ç†é›†ç¾¤ã€æ¨¡æ¿ã€å®¡æ‰¹ç­‰ï¼‰
> - **èµ„æºçº§ RBAC (resource_role_bindings)**: æ§åˆ¶å…·ä½“èµ„æºçš„è®¿é—®æƒé™ï¼ˆæˆ‘çš„ System å¯¹ä½ ä¸å¯è§ï¼‰

```
å®Œæ•´æƒé™æ£€æŸ¥æµç¨‹:

ç”¨æˆ·è¯·æ±‚è®¿é—®èµ„æº R (ä¾‹å¦‚: GET /api/v1/systems/sys-001)

â”Œâ”€ Step 1: å…¨å±€æƒé™æ£€æŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŸ¥è¯¢ role_bindings â†’ èšåˆ Permissions                                            â”‚
â”‚  - å¦‚æœç”¨æˆ·æœ‰ platform:admin æƒé™ â†’ å…è®¸è®¿é—®æ‰€æœ‰èµ„æºï¼ˆæ˜¾å¼è¶…çº§ç®¡ç†å‘˜ï¼‰               â”‚
â”‚  - å¦‚æœç”¨æˆ·æœ‰å¯¹åº”å…¨å±€æƒé™ (system:read) â†’ è¿›å…¥ Step 2                               â”‚
â”‚  - å¦åˆ™ â†’ æ‹’ç»è®¿é—®                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€ Step 2: èµ„æºçº§æƒé™æ£€æŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŸ¥è¯¢ resource_role_bindings WHERE resource_id = 'sys-001' AND user_id = ?        â”‚
â”‚  - å¦‚æœæ‰¾åˆ°è®°å½• (owner/admin/member/viewer) â†’ æ ¹æ®è§’è‰²å†³å®šæ“ä½œæƒé™                  â”‚
â”‚  - å¦‚æœæœªæ‰¾åˆ° â†’ æ£€æŸ¥èµ„æºç»§æ‰¿é“¾ (VM â†’ Service â†’ System)                              â”‚
â”‚  - æœ€ç»ˆæœªæ‰¾åˆ° â†’ æ‹’ç»è®¿é—® (èµ„æºå¯¹æ­¤ç”¨æˆ·ä¸å¯è§)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¤ºä¾‹ 1: å¼ ä¸‰ (DevOps-Team) è®¿é—®è‡ªå·±åˆ›å»ºçš„ System
1. å…¨å±€æƒé™: system:read âˆˆ SystemAdmin æƒé™ â†’ ç»§ç»­
2. èµ„æºæƒé™: resource_role_bindings ä¸­ role='owner' â†’ âœ… å…è®¸

ç¤ºä¾‹ 2: æå›› (IT-Support) è®¿é—®å¼ ä¸‰çš„ System
1. å…¨å±€æƒé™: system:read âˆˆ Viewer æƒé™ â†’ ç»§ç»­
2. èµ„æºæƒé™: æœªæ‰¾åˆ° resource_role_binding è®°å½• â†’ âŒ èµ„æºä¸å¯è§

ç¤ºä¾‹ 3: æå››è¢«å¼ ä¸‰æ·»åŠ ä¸º System æˆå‘˜å
1. å…¨å±€æƒé™: system:read âˆˆ Viewer æƒé™ â†’ ç»§ç»­
2. èµ„æºæƒé™: resource_role_bindings ä¸­ role='member' â†’ âœ… å…è®¸æŸ¥çœ‹

ç¤ºä¾‹ 4: æå››è®¿é—®å¼ ä¸‰ System ä¸‹çš„ VM (æƒé™ç»§æ‰¿)
è®¿é—®ç›®æ ‡: vm-001 (å±äº svc-redis â†’ å±äº sys-shop)
1. å…¨å±€æƒé™: vm:read âˆˆ Viewer æƒé™ â†’ ç»§ç»­
2. èµ„æºæƒé™ (å‘ä¸Šéå†):
   a. æ£€æŸ¥ vm-001 çš„ binding â†’ æ—  (VM å±‚ä¸é…ç½®æˆå‘˜)
   b. æ£€æŸ¥ svc-redis çš„ binding â†’ æ—  (Service å±‚ä¸é…ç½®æˆå‘˜)
   c. æ£€æŸ¥ sys-shop çš„ binding â†’ æ‰¾åˆ°! role='member'
3. ç»“æœ: æå››ç»§æ‰¿ System çš„ member æƒé™ â†’ âœ… å¯ä»¥æŸ¥çœ‹è¯¥ VM
```

#### é˜¶æ®µ 2 Bootstrap è§’è‰²å®‰å…¨è¯´æ˜

- Bootstrap è§’è‰²ï¼ˆ`role-bootstrap`ï¼‰ä»…ç”¨äºåˆå§‹åŒ–ï¼Œé¦–æ¬¡éƒ¨ç½²å®Œæˆåå¿…é¡»ç¦ç”¨ã€‚
- æ“ä½œæµç¨‹ï¼š
  [operations/bootstrap-role-sop.md](../../../../operations/bootstrap-role-sop.md)
- æ²»ç†ä¸å®¡è®¡åŸºçº¿ï¼š
  [04-governance.md Â§7 Audit Logging](../../../../design/phases/04-governance.md#7-audit-logging)

#### State Transitions

| é¢†åŸŸ | å…¸å‹çŠ¶æ€å˜åŒ– |
|------|-------------|
| ç”¨æˆ·è®¤è¯æ¡£æ¡ˆ | é¦–æ¬¡ç™»å½•å `uninitialized -> active` |
| è§’è‰²ç»‘å®š | `absent -> assigned`ï¼ˆå…¨å±€æˆ–èµ„æºçº§ï¼‰ |
| å®¡æ‰¹èƒ½åŠ› | é…ç½®å®Œæˆå `disabled -> enabled` |

#### Failure & Edge Cases

- Bootstrap è§’è‰²åœ¨åˆå§‹åŒ–åå¿…é¡»ç¦ç”¨ï¼Œé¿å…é—ç•™è¶…ç®¡é£é™©ã€‚
- å¤–éƒ¨ IdP æ˜ å°„æ¼‚ç§»ä¸å¾—å¯¼è‡´é™é»˜ææƒã€‚
- ç»§æ‰¿é“¾æ— ç»‘å®šæ—¶å¿…é¡»é»˜è®¤æ‹’ç»å¯è§æ€§ä¸æ“ä½œã€‚

#### Authority Links

- [ADR-0015 Â§22 Authentication and RBAC Strategy](../../../../adr/ADR-0015-governance-model-v2.md#22-authentication-rbac-strategy)
- [04-governance.md Â§7 Audit Logging](../../../../design/phases/04-governance.md#7-audit-logging)
- [01-contracts.md Â§1.1 Naming Constraints](../../../../design/phases/01-contracts.md#11-naming-constraints-adr-0019)

#### Scope Boundary

æœ¬èŠ‚å®šä¹‰å®‰å…¨äº¤äº’è¯­ä¹‰ä¸æƒé™è¾¹ç•Œã€‚åè®®ç»†èŠ‚ä¸åŠ å›ºæ¸…å•åœ¨ phase/operations æ–‡æ¡£ä¸­å®šä¹‰ã€‚

### é˜¶æ®µ 2.E: å®¡æ‰¹ Provider æ ‡å‡† (V1 å†…ç½®ï¼ŒV2+ å¤–éƒ¨æ’ä»¶) {#stage-2-e}

> **Added 2026-01-26**: å®¡æ‰¹ Provider æ¨¡å‹ä¸å¤–éƒ¨é›†æˆè¾¹ç•Œ

#### Purpose

å®šä¹‰ç»Ÿä¸€çš„å®¡æ‰¹ Provider å¥‘çº¦ã€‚V1 åªå†…ç½®ä¸€ä¸ª Providerï¼›
å¤–éƒ¨ç³»ç»Ÿé€šè¿‡æ’ä»¶é€‚é…æ¥å…¥ï¼Œä¸”ä¸æ”¹å˜å®¡æ‰¹çŠ¶æ€æœºè¯­ä¹‰ã€‚

#### Actors & Trigger

- è§¦å‘ï¼šå¹³å°ç®¡ç†å‘˜åˆ¶å®šå®¡æ‰¹ Provider ç­–ç•¥ä¸è·¯ç”±è§„åˆ™ã€‚
- å‚ä¸æ–¹ï¼šå¹³å°ç®¡ç†å‘˜ã€å®¡æ‰¹ Provider è·¯ç”±å±‚ã€å†…ç½® Providerã€å¯é€‰å¤–éƒ¨ Provider é€‚é…å™¨ã€‚

#### Interaction Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 2.Eï¼šå®¡æ‰¹ Provider è¾¹ç•Œï¼ˆç»Ÿä¸€å¥‘çº¦ + å¯æ’æ‹”å®ç°ï¼‰                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  V1 ä¸Šçº¿è·¯å¾„ï¼ˆå¿…éœ€ï¼‰ï¼š                                                                          â”‚
â”‚    1) ç”¨æˆ·æäº¤è¯·æ±‚ -> approval_tickets=PENDING_APPROVAL                                       â”‚
â”‚    2) è·¯ç”±å±‚é€‰æ‹©å†…ç½® Providerï¼ˆ`builtin-default`ï¼ŒV1 å”¯ä¸€å®ç°ï¼‰                                â”‚
â”‚    3) å†…ç½®å®¡æ‰¹äººåš APPROVED / REJECTED å†³ç­–                                                    â”‚
â”‚    4) Shepherd æ‰§è¡Œåç»­è·¯å¾„å¹¶è®°å½•å®¡è®¡                                                          â”‚
â”‚                                                                                              â”‚
â”‚  å¤–éƒ¨æ’ä»¶è·¯å¾„ï¼ˆV2+ è·¯çº¿å›¾ï¼‰ï¼š                                                                  â”‚
â”‚    1) å¤–éƒ¨é€‚é…å™¨æ’ä»¶æŒ‰ç­–ç•¥æ³¨å†Œå¹¶å¯ç”¨                                                           â”‚
â”‚    2) è·¯ç”±å±‚é€šè¿‡ ExternalApprovalProvider.SubmitForApproval å§”æ´¾å·¥å•                           â”‚
â”‚    3) å›è°ƒ/è½®è¯¢ç»“æœæ˜ å°„åˆ°ç»Ÿä¸€çš„ APPROVED / REJECTED                                            â”‚
â”‚    4) å¤–éƒ¨è¶…æ—¶/ä¸å¯ç”¨ -> å¯æ§å›é€€åˆ°å†…ç½®å®¡æ‰¹é˜Ÿåˆ—                                                â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<a id="stage-3"></a>

---

```
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 3: ç®¡ç†å‘˜é…ç½® (Cluster/InstanceSize/Template)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  å¹³å°ç®¡ç†å‘˜:                                                                                  â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ æ­¥éª¤ 1: æ³¨å†Œé›†ç¾¤ (ç³»ç»Ÿè‡ªåŠ¨æ¢æµ‹èƒ½åŠ›) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ç®¡ç†å‘˜åªéœ€æä¾›:                                                                          â”‚ â”‚
â”‚  â”‚  POST /api/v1/admin/clusters                                                             â”‚ â”‚
â”‚  â”‚  { "name": "cluster-a", "kubeconfig": "...", "environment": "prod" }                     â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ç³»ç»Ÿè‡ªåŠ¨æ¢æµ‹ï¼Œç®¡ç†å‘˜æ— éœ€æ‰‹åŠ¨é…ç½®:                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  æ¢æµ‹é¡¹ç›®          æ¢æµ‹æ–¹å¼                                     ç»“æœç¤ºä¾‹              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  GPU è®¾å¤‡          node.status.capacity (nvidia.com/gpu)        nvidia.com/gpu: 2    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                    ğŸ’¡ éœ€é›†ç¾¤é¢„è£… NVIDIA Device Plugin                                 â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Hugepages         node.status.allocatable                      hugepages-2Mi: 4Gi   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                    (hugepages-2Mi, hugepages-1Gi)               hugepages-1Gi: 2Gi   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                    ğŸ’¡ å¯èƒ½ä¸ºç©º (æœªé…ç½® Hugepages æ—¶)                                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  SR-IOV ç½‘ç»œ       kubectl get net-attach-def -A                sriov-net-1          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                    (NetworkAttachmentDefinition CRD)            sriov-net-2          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                    ğŸ’¡ éœ€é›†ç¾¤é¢„è£… Multus CNI + SR-IOV Device Plugin                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  StorageClass      kubectl get storageclasses                   ceph-rbd, local-path â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  KubeVirt ç‰ˆæœ¬     kubevirt.status.observedKubeVirtVersion      v1.2.0               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                    kubectl get kv -n kubevirt -o jsonpath=                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                    '{.items[0].status.observedKubeVirtVersion}'                      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  æ¢æµ‹ç»“æœè‡ªåŠ¨å­˜å‚¨ (ç®¡ç†å‘˜å¯æŸ¥çœ‹ï¼Œä½†æ— éœ€æ‰‹åŠ¨è¾“å…¥):                                           â”‚ â”‚
â”‚  â”‚  cluster.detected_capabilities = {                                                       â”‚ â”‚
â”‚  â”‚      "gpu_devices": ["nvidia.com/GA102GL_A10"],                                          â”‚ â”‚
â”‚  â”‚      "hugepages": ["2Mi", "1Gi"],                                                        â”‚ â”‚
â”‚  â”‚      "sriov_networks": ["sriov-net-1"],                                                  â”‚ â”‚
â”‚  â”‚      "storage_classes": ["ceph-rbd", "local-path"],                                      â”‚ â”‚
â”‚  â”‚      "kubevirt_version": "v1.2.0"                                                        â”‚ â”‚
â”‚  â”‚  }                                                                                       â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ æ­¥éª¤ 2: é…ç½® Namespace â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  âš ï¸ æ ¸å¿ƒåŸåˆ™:                                                                              â”‚ â”‚
â”‚  â”‚  - Namespace æ˜¯**å…¨å±€é€»è¾‘å®ä½“**ï¼Œä¸ç»‘å®šåˆ°ç‰¹å®šé›†ç¾¤                                           â”‚ â”‚
â”‚  â”‚  - å®é™… K8s namespace åœ¨å®¡æ‰¹é€šè¿‡çš„ VM éƒ¨ç½²æ—¶ JIT (å³æ—¶) åˆ›å»º                                â”‚ â”‚
â”‚  â”‚  - **VM è¯·æ±‚æäº¤å Namespace ä¸å¯å˜**                                                      â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  å¹³å°èŒè´£è¾¹ç•Œ:                                                                            â”‚ â”‚
â”‚  â”‚  - âœ… ç®¡ç†é€»è¾‘ namespace æ³¨å†Œè¡¨ï¼ˆç¯å¢ƒæ ‡ç­¾ã€æ‰€æœ‰æƒï¼‰                                          â”‚ â”‚
â”‚  â”‚  - âŒ ä¸ç®¡ç†: Kubernetes RBAC / ResourceQuota (ç”± K8s ç®¡ç†å‘˜è´Ÿè´£)                        â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ç®¡ç†å‘˜æ“ä½œï¼ˆæ³¨å†Œé€»è¾‘ namespaceï¼‰:                                                         â”‚ â”‚
â”‚  â”‚  POST /api/v1/admin/namespaces                    ğŸ‘ˆ éé›†ç¾¤ç»‘å®š                           â”‚ â”‚
â”‚  â”‚  {                                                                                       â”‚ â”‚
â”‚  â”‚      "name": "prod-shop",                                                                â”‚ â”‚
â”‚  â”‚      "environment": "prod",                       ğŸ‘ˆ å†³å®šå®¡æ‰¹ç­–ç•¥å’Œé›†ç¾¤åŒ¹é…                 â”‚ â”‚
â”‚  â”‚      "owner_id": "user-001"                                                              â”‚ â”‚
â”‚  â”‚  }                                                                                       â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ğŸ’¡ æç¤º: ç”¨æˆ·é€‰æ‹© Namespace æ—¶ï¼Œç³»ç»Ÿæ ¹æ® environment æ ‡ç­¾ç¡®å®š:                            â”‚ â”‚
â”‚  â”‚     - å®¡æ‰¹ç­–ç•¥ (test ç¯å¢ƒå¯å¿«é€Ÿå®¡æ‰¹ï¼Œprod ç¯å¢ƒéœ€ä¸¥æ ¼å®¡æ‰¹)                                   â”‚ â”‚
â”‚  â”‚     - è¶…å–è­¦å‘Š (prod ç¯å¢ƒè¶…å–æ—¶æ˜¾ç¤ºè­¦å‘Š)                                                   â”‚ â”‚
â”‚  â”‚     - é›†ç¾¤åŒ¹é… (namespace ç¯å¢ƒç±»å‹å¿…é¡»ä¸é›†ç¾¤ç¯å¢ƒç±»å‹åŒ¹é…: testâ†’test, prodâ†’prod)            â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ğŸ’¡ JIT Namespace åˆ›å»ºï¼ˆå®¡æ‰¹æ‰§è¡Œé˜¶æ®µï¼‰:                                                    â”‚ â”‚
â”‚  â”‚     ç®¡ç†å‘˜å®¡æ‰¹ VM è¯·æ±‚å¹¶é€‰æ‹©ç›®æ ‡é›†ç¾¤å:                                                     â”‚ â”‚
â”‚  â”‚     1. æ£€æŸ¥ç›®æ ‡é›†ç¾¤ä¸Šæ˜¯å¦å­˜åœ¨ K8s namespace                                                â”‚ â”‚
â”‚  â”‚     2. å¦‚ä¸å­˜åœ¨ â†’ åˆ›å»ºå¸¦æœ‰æ ‡å‡†æ ‡ç­¾çš„ namespace                                             â”‚ â”‚
â”‚  â”‚     3. å¯¹ K8s API é”™è¯¯åšåˆ†ç±»å¹¶è¿”å›æ ‡å‡†é”™è¯¯ç ï¼ˆç»†èŠ‚è§æ¡†å Markdown è¯´æ˜ï¼‰ã€‚                  â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ æ­¥éª¤ 3: é…ç½® Template â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  æ¨¡æ¿å®šä¹‰ VM çš„æ“ä½œç³»ç»ŸåŸºç¡€é…ç½®:                                                            â”‚ â”‚
â”‚  â”‚  - OS é•œåƒæ¥æº (DataVolume / PVC å¼•ç”¨)                                                    â”‚ â”‚
â”‚  â”‚  - cloud-init é…ç½® (ç®¡ç†å‘˜å¯è‡ªå®šä¹‰)                                                        â”‚ â”‚
â”‚  â”‚  - å­—æ®µå¯è§æ€§æ§åˆ¶ (quick_fields / advanced_fields)                                        â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ğŸ’¡ æ³¨æ„: ç¡¬ä»¶èƒ½åŠ›è¦æ±‚ (GPU/SR-IOV/Hugepages) å·²ç§»è‡³ InstanceSize é…ç½®                     â”‚ â”‚
â”‚  â”‚  ğŸ’¡ ç³»ç»Ÿåˆå§‹åŒ–æ—¶ä¼šé¢„å¡«å……å¸¸ç”¨æ¨¡æ¿ (ä» seed data å¯¼å…¥åˆ° PostgreSQL)                           â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  åˆ›å»ºæ¨¡æ¿                                                                          â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  åç§°:         [centos7-standard    ]                                              â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  åˆ†ç±»:         [æ“ä½œç³»ç»Ÿ â–¼]                                                         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  çŠ¶æ€:         [active â–¼]                                                          â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€ é•œåƒæ¥æº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  ç±»å‹:         (â—) containerdisk   ( ) pvc                                         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€ containerdisk æ¨¡å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  é•œåƒåœ°å€:   [docker.io/kubevirt/centos:7                    ]             â”‚    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€ pvc æ¨¡å¼ (åˆ‡æ¢åæ˜¾ç¤º) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  Namespace:  [default           ]                                          â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  PVC åç§°:   [centos7-base-disk ]                                          â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€ cloud-init é…ç½® (YAML) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  #cloud-config                                                             â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  users:                                                                    â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚    - name: admin                                                           â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚      sudo: ALL=(ALL) NOPASSWD:ALL                                          â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  chpasswd:                                                                 â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚    expire: true                         ğŸ‘ˆ é¦–æ¬¡ç™»å½•åå¼ºåˆ¶ä¿®æ”¹å¯†ç             â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚    users:                                                                  â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚      - name: admin                                                         â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚        password: changeme123            ğŸ‘ˆ ä¸€æ¬¡æ€§åˆå§‹å¯†ç                     â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  ğŸ’¡ å¹³å°èŒè´£: æä¾›ä¸€æ¬¡æ€§å¯†ç ç¡®ä¿é¦–æ¬¡ç™»å½•                                            â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  ğŸ’¡ åç»­ç®¡ç†: ç”±ç”¨æˆ·/ç®¡ç†å‘˜/å ¡å’æœºè´Ÿè´£ (å¯é€šè¿‡è‡ªå®šä¹‰ cloud-init å¯¹æ¥)               â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  [ä¿å­˜]                                                                            â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  æ¨¡æ¿ç‰ˆæœ¬è¯´æ˜:                                                                            â”‚ â”‚
â”‚  â”‚  - ç”¨æˆ·æäº¤è¯·æ±‚æ—¶çœ‹åˆ°å½“å‰æ´»è·ƒç‰ˆæœ¬                                                          â”‚ â”‚
â”‚  â”‚  - ç®¡ç†å‘˜å®¡æ‰¹æ—¶å¯é€‰æ‹©ä¸åŒç‰ˆæœ¬                                                              â”‚ â”‚
â”‚  â”‚  - æœ€ç»ˆæ¨¡æ¿å†…å®¹å¿«ç…§åˆ° ApprovalTicketï¼ŒVM åˆ›å»ºåä¸å—æ¨¡æ¿æ›´æ–°å½±å“                            â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ğŸ‘‰ æ™®é€šç”¨æˆ·: é€‰æ‹©æ¨¡æ¿ï¼Œä½†ä¸èƒ½ä¿®æ”¹ cloud-init å†…å®¹                                         â”‚ â”‚
â”‚  â”‚  ğŸ‘‰ ç®¡ç†å‘˜: å¯åˆ›å»º/ç¼–è¾‘æ¨¡æ¿ï¼ŒåŒ…æ‹¬é•œåƒæ¥æºå’Œ cloud-init é…ç½®                                â”‚ â”‚
â”‚  â”‚             (å¦‚éœ€å¯¹æ¥å ¡å’æœºï¼Œç®¡ç†å‘˜å¯è‡ªå®šä¹‰ cloud-init é…ç½®)                               â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ æ­¥éª¤ 4: åˆ›å»º InstanceSize (é€šè¿‡ Schema é©±åŠ¨çš„è¡¨å•) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ç®¡ç†å‘˜çœ‹åˆ°çš„ UI (å‰ç«¯æ ¹æ® Schema è‡ªåŠ¨æ¸²æŸ“):                                               â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  åˆ›å»ºInstanceSizeï¼ˆè§„æ ¼ï¼‰                                                                          â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  åç§°:         [gpu-workstation    ]                                              â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  æ˜¾ç¤ºåç§°:     [GPU å·¥ä½œç«™ (8æ ¸ 32GB)]                                             â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€ èµ„æºé…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  CPU æ ¸æ•°:     [8        ]                                                        â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  [âœ“] å¯ç”¨ CPU è¶…å–     ğŸ‘ˆ å‹¾é€‰åæ˜¾ç¤º request/limit                                â”‚   â”‚ â”‚
â”‚  â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚      â”‚  CPU Request: [4    ] æ ¸   CPU Limit: [8    ] æ ¸   (2x è¶…å–)            â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  å†…å­˜:         [32Gi     ]                                                        â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  [âœ“] å¯ç”¨å†…å­˜è¶…å–                                                                  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚      â”‚  Mem Request: [16Gi ] æ ¸   Mem Limit: [32Gi ]   (2x è¶…å–)               â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€ é«˜çº§è®¾ç½® â”€â”€                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  Hugepages:    [æ—  (None) â–¼]   ğŸ‘ˆ ä¸‹æ‹‰æ¡†é€‰é¡¹æ¥è‡ª KubeVirt Schema enum + é»˜è®¤æ—     â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                [æ—  (None) ]    â† é»˜è®¤é€‰é¡¹: ä¸ä½¿ç”¨ Hugepages                       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                [2Mi        ]                                                      â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                [1Gi        ]                                                      â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  ä¸“ç”¨ CPU:     [âœ“]        ğŸ‘ˆ å¤é€‰æ¡† (Schema ç±»å‹: boolean)                         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  GPU è®¾å¤‡:                 ğŸ‘ˆ åŠ¨æ€è¡¨æ ¼ (Schema ç±»å‹: array)                        â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  åç§°       è®¾å¤‡åç§°                                                      â”‚    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  [gpu1   ]  [nvidia.com/GA102GL_A10         ]  â† ç®¡ç†å‘˜è‡ªå·±è¾“å…¥           â”‚    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                                                                            â”‚    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  [+ æ·»åŠ  GPU]                                                              â”‚    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  [ä¿å­˜]                                                                            â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  å­˜å‚¨åˆ° PostgreSQL (åç«¯ä¸ç†è§£å†…å®¹ï¼Œåªå­˜å‚¨ JSON):                                          â”‚ â”‚
â”‚  â”‚  {                                                                                       â”‚ â”‚
â”‚  â”‚      "name": "gpu-workstation",                                                          â”‚ â”‚
â”‚  â”‚      "cpu_overcommit": { "enabled": true, "request": "4", "limit": "8" },                â”‚ â”‚
â”‚  â”‚      "mem_overcommit": { "enabled": true, "request": "16Gi", "limit": "32Gi" },          â”‚ â”‚
â”‚  â”‚      "spec_overrides": {                                                                 â”‚ â”‚
â”‚  â”‚          "spec.template.spec.domain.cpu.cores": 8,                                       â”‚ â”‚
â”‚  â”‚          "spec.template.spec.domain.resources.requests.memory": "32Gi",                  â”‚ â”‚
â”‚  â”‚          "spec.template.spec.domain.memory.hugepages.pageSize": "2Mi",                   â”‚ â”‚
â”‚  â”‚          "spec.template.spec.domain.cpu.dedicatedCpuPlacement": true,                    â”‚ â”‚
â”‚  â”‚          "spec.template.spec.domain.devices.gpus": [                                     â”‚ â”‚
â”‚  â”‚              {"name": "gpu1", "deviceName": "nvidia.com/GA102GL_A10"}                    â”‚ â”‚
â”‚  â”‚          ]                                                                               â”‚ â”‚
â”‚  â”‚      }                                                                                   â”‚ â”‚
â”‚  â”‚  }                                                                                       â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â”‚  âš ï¸ Dry-Run æ ¡éªŒï¼š                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ä¿å­˜å‰ï¼Œç®¡ç†å‘˜å¯å¯¹ç›®æ ‡é›†ç¾¤æ‰§è¡Œ InstanceSize å…¼å®¹æ€§æ ¡éªŒï¼š                                 â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  POST /api/v1/admin/instance-sizes?dryRun=All                                            â”‚ â”‚
â”‚  â”‚  POST /api/v1/admin/instance-sizes?dryRun=All&targetCluster={cluster_id}                 â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  æ ¡éªŒé˜¶æ®µï¼š                                                                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  é˜¶æ®µ 1: ç»“æ„æ£€æŸ¥            â†’ YAML/JSON è¯­æ³•åˆæ³•                                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  é˜¶æ®µ 2: Schema æ ¡éªŒ         â†’ ä¸ KubeVirt VirtualMachine Schema å…¼å®¹               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  é˜¶æ®µ 3: é›†ç¾¤ Dry-Run (å¯é€‰) â†’ åœ¨ç›®æ ‡é›†ç¾¤æ‰§è¡Œ kubectl apply --dry-run=server        â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  å“åº”ï¼ˆdry-run æ¨¡å¼ï¼‰ï¼š                                                                  â”‚ â”‚
â”‚  â”‚  {                                                                                       â”‚ â”‚
â”‚  â”‚      "valid": true,                                                                     â”‚ â”‚
â”‚  â”‚      "rendered_yaml": "...",     ğŸ‘ˆ ç”Ÿæˆ VM è§„æ ¼é¢„è§ˆ                                    â”‚ â”‚
â”‚  â”‚      "compatible_clusters": ["cluster-a", "cluster-c"]   ğŸ‘ˆ åŒ¹é…çš„é›†ç¾¤åˆ—è¡¨              â”‚ â”‚
â”‚  â”‚  }                                                                                       â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é˜¶æ®µ 3 JIT Namespace æ‰§è¡Œè¯´æ˜ {#stage-3-jit-namespace}

<a id="stage-3-c"></a>

- é”™è¯¯åˆ†ç±»ï¼ˆæ ‡å‡†é”™è¯¯ç ï¼‰ï¼š
  - `NAMESPACE_PERMISSION_DENIED (403)`ï¼šç›®æ ‡é›†ç¾¤æ‹’ç» namespace åˆ›å»ºæƒé™ã€‚
  - `NAMESPACE_QUOTA_EXCEEDED (403)`ï¼šè¢«é›†ç¾¤ ResourceQuota ç­–ç•¥æ‹’ç»ã€‚
  - `NAMESPACE_CREATION_FAILED (500)`ï¼šå…¶ä»–æœªå½’ç±»çš„ K8s/API é”™è¯¯ã€‚
- å¤±è´¥å¤„ç†åŸºçº¿ï¼š
  - å·¥å•çŠ¶æ€è½¬ä¸º `FAILED_PROVISIONING`ã€‚
  - Worker ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥é‡è¯•ã€‚
- è§„èŒƒæ¥æºï¼š
  - [ADR-0017 Â§Namespace Just-In-Time Creation (Added 2026-01-27)](../../../../adr/ADR-0017-vm-request-flow-clarification.md#namespace-just-in-time-creation-added-2026-01-27)
  - [01-contracts.md Â§Error Code Standard (ADR-0023)](../../../../design/phases/01-contracts.md#error-code-standard-adr-0023)

#### State Transitions

| é¢†åŸŸ | å…¸å‹çŠ¶æ€å˜åŒ– |
|------|-------------|
| å®¡æ‰¹ Provider é›†åˆ | å†…ç½®å®ç°éšå¼å­˜åœ¨ -> æ˜¾å¼ Provider æ³¨å†Œè¡¨ï¼ˆV1 ä»…å†…ç½®ï¼‰ |
| å†³ç­–å¥‘çº¦ | å­˜åœ¨æä¾›æ–¹å·®å¼‚è§£è¯»é£é™© -> ç»Ÿä¸€ `APPROVED/REJECTED` å¥‘çº¦ |
| æ•…éšœå›é€€æ¨¡å¼ | éšå¼ -> å¤–éƒ¨é€‚é…å™¨æ•…éšœæ—¶æ˜¾å¼å›é€€åˆ°å†…ç½®å®¡æ‰¹ |

#### Failure & Edge Cases

- å¤–éƒ¨é€‚é…å™¨ä¸å¯ç”¨ä¸å¾—é˜»å¡å†…ç½® Provider ä¸»è·¯å¾„ã€‚
- å›è°ƒç­¾åæˆ–çŠ¶æ€æ˜ å°„ä¸åˆæ³•å¿…é¡»æ‹’ç»å¹¶è®°å½•å®¡è®¡ã€‚
- å¤–éƒ¨å®¡æ‰¹è¶…æ—¶å¿…é¡»ä¿æŒå·¥å•å¯æ¢å¤ï¼ˆå›é€€æˆ–ç»§ç»­ pendingï¼‰ï¼Œä¸å¾—å½¢æˆå­¤å„¿çŠ¶æ€ã€‚

#### Authority Links

- [ADR-0005 Â§Decision](../../../../adr/ADR-0005-workflow-extensibility.md#decision)
- [ADR-0015 Â§21 Scope Exclusions (V1)](../../../../adr/ADR-0015-governance-model-v2.md#21-scope-exclusions-v1)
- [04-governance.md Â§9 External Approval Systems](../../../../design/phases/04-governance.md#9-external-approval-systems-v1-interface-only)
- [04-governance.md Â§9.1 Interface Definition](../../../../design/phases/04-governance.md#91-interface-definition)
- [04-governance.md Â§7 Audit Logging](../../../../design/phases/04-governance.md#7-audit-logging)
- [RFC-0004 External Approval Systems Integration](../../../../rfc/RFC-0004-external-approval.md)

#### Scope Boundary

æœ¬èŠ‚åªå®šä¹‰å®¡æ‰¹ Provider æ¨¡å‹ä¸ V1 è¾¹ç•Œã€‚
æä¾›æ–¹ payload/callback/å®‰å…¨ç»†èŠ‚å½’å±
[Part 4 Â§å®¡æ‰¹ Provider æ’ä»¶åŒ–æ¶æ„ (V2+ è·¯çº¿å›¾)](#external-approval-v2-roadmap)
ä¸ RFC-0004ã€‚


---

## Part 2: èµ„æºç®¡ç†æµç¨‹

<a id="stage-4-a"></a>
<a id="stage-4-a-plus"></a>
<a id="stage-4-b"></a>
<a id="stage-4-c"></a>

> **è¯´æ˜**: ç”¨æˆ·åœ¨åˆ›å»º VM ä¹‹å‰ï¼Œå¿…é¡»å…ˆåˆ›å»º System å’Œ Service æ¥ç»„ç»‡èµ„æºã€‚

### Purpose

å®šä¹‰ System/Service èµ„æºå±‚çº§åˆ›å»ºä¸å½’å±å…³ç³»çš„äº¤äº’è¡Œä¸ºã€‚

### Actors & Trigger

- è§¦å‘ï¼šæ™®é€šç”¨æˆ·ä¸ºåç»­ VM å·¥ä½œè´Ÿè½½åˆ›å»ºèµ„æºå±‚çº§ã€‚
- å‚ä¸æ–¹ï¼šèµ„æºæ‹¥æœ‰è€…ã€å›¢é˜Ÿæˆå‘˜ã€RBAC è¯„ä¼°å±‚ã€å®¡è®¡å­ç³»ç»Ÿã€‚

### Interaction Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 4: ç”¨æˆ·åˆ›å»ºç»„ç»‡ç»“æ„                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  é¡ºåº: System â†’ Service â†’ VM                                                                â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  System (ç³»ç»Ÿ)                                                                          â”‚ â”‚
â”‚  â”‚    â”œâ”€â”€ Service (æœåŠ¡)                                                                   â”‚ â”‚
â”‚  â”‚    â”‚     â”œâ”€â”€ VM 1                                                                       â”‚ â”‚
â”‚  â”‚    â”‚     â””â”€â”€ VM 2                                                                       â”‚ â”‚
â”‚  â”‚    â””â”€â”€ Service (æœåŠ¡)                                                                   â”‚ â”‚
â”‚  â”‚          â””â”€â”€ VM 3                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 4.A: ç”¨æˆ·åˆ›å»ºç³»ç»Ÿ (System)                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ç”¨æˆ·æ“ä½œ:                                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  åˆ›å»ºç³»ç»Ÿ                                                                          â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  ç³»ç»Ÿåç§°:     [shop                ]    ğŸ‘ˆ å…¨å±€å”¯ä¸€, æœ€é•¿ 15 å­—ç¬¦                   â”‚       â”‚
â”‚  â”‚  ç³»ç»Ÿæè¿°:     [ç”µå•†æ ¸å¿ƒç³»ç»Ÿ          ]    ğŸ‘ˆ æ”¯æŒ Markdown æ ¼å¼                       â”‚       â”‚
â”‚  â”‚               [é¢„è§ˆ] [ä¸Šä¼  .md æ–‡ä»¶]        â† æˆ–ä¸Šä¼ å·²æœ‰ Markdown æ–‡ä»¶                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  [åˆ›å»º]                                                                             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ (å•äº‹åŠ¡):                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  BEGIN TRANSACTION;                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 1. åˆ›å»ºç³»ç»Ÿ                                                                    â”‚       â”‚
â”‚  â”‚  INSERT INTO systems (id, name, description, created_by, created_at)              â”‚       â”‚
â”‚  â”‚  VALUES ('sys-001', 'shop', 'ç”µå•†æ ¸å¿ƒç³»ç»Ÿ', 'zhang.san', NOW());                   â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 2. ç”¨æˆ·æƒé™è‡ªåŠ¨ç»§æ‰¿ (èµ„æºçº§æƒé™)                                                â”‚       â”‚
â”‚  â”‚  INSERT INTO resource_role_bindings                                               â”‚       â”‚
â”‚  â”‚    (id, user_id, role, resource_type, resource_id, granted_by, created_at)        â”‚       â”‚
â”‚  â”‚  VALUES ('rrb-001', 'zhang.san', 'owner', 'system', 'sys-001', 'zhang.san', NOW()); â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 3. ğŸ“ è®°å½•å®¡è®¡æ—¥å¿—                                                             â”‚       â”‚
â”‚  â”‚  INSERT INTO audit_logs (action, actor_id, resource_type, resource_id, details)   â”‚       â”‚
â”‚  â”‚  VALUES ('system.create', 'zhang.san', 'system', 'sys-001',                       â”‚       â”‚
â”‚  â”‚          '{"name": "shop", "description": "ç”µå•†æ ¸å¿ƒç³»ç»Ÿ"}');                        â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  COMMIT;                                                                          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  âœ… æ— éœ€å®¡æ‰¹: ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥åˆ›å»ºç³»ç»Ÿ                                                          â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ‘† åˆ›å»ºè€…è‡ªåŠ¨æˆä¸ºè¯¥ System çš„ Ownerï¼Œæ‹¥æœ‰å®Œå…¨æ§åˆ¶æƒ                                            â”‚
â”‚     å…¶ä»–ç”¨æˆ·é»˜è®¤çœ‹ä¸åˆ°æ­¤ System åŠå…¶ä¸‹çš„ Service/VM                                            â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 4.A+: èµ„æºçº§æˆå‘˜ç®¡ç† (Owner æ“ä½œ)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ğŸ’¡ æ ¸å¿ƒè®¾è®¡: èµ„æºåˆ›å»ºè€…å¯ä»¥å°†å…¶ä»–ç”¨æˆ·æ·»åŠ åˆ°è‡ªå·±çš„ System/Service ä¸­                              â”‚
â”‚     æ— éœ€å¹³å°ç®¡ç†å‘˜å‚ä¸ï¼Œå®ç°å›¢é˜Ÿè‡ªæœåŠ¡                                                           â”‚
â”‚                                                                                              â”‚
â”‚  Owner æ“ä½œ (ç³»ç»Ÿè®¾ç½® â†’ æˆå‘˜ç®¡ç†):                                                              â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  ç³»ç»Ÿæˆå‘˜ç®¡ç† - shop                                                              â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  å½“å‰æˆå‘˜:                                                                          â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚       â”‚
â”‚  â”‚  â”‚  ç”¨æˆ·              è§’è‰²                æ“ä½œ                                  â”‚   â”‚       â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚       â”‚
â”‚  â”‚  â”‚  å¼ ä¸‰              Owner (åˆ›å»ºè€…)      -                                     â”‚   â”‚       â”‚
â”‚  â”‚  â”‚  æå››              Admin               [âš™ ç¼–è¾‘] [ğŸ—‘ ç§»é™¤]                     â”‚   â”‚       â”‚
â”‚  â”‚  â”‚  ç‹äº”              Member              [âš™ ç¼–è¾‘] [ğŸ—‘ ç§»é™¤]                     â”‚   â”‚       â”‚
â”‚  â”‚  â”‚  èµµå…­              Viewer              [âš™ ç¼–è¾‘] [ğŸ—‘ ç§»é™¤]                     â”‚   â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  [+ æ·»åŠ æˆå‘˜]                                                                       â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  â”Œâ”€ æ·»åŠ æˆå‘˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚       â”‚
â”‚  â”‚  â”‚  æœç´¢ç”¨æˆ·:   [li.si@company.com      ] ğŸ”                                    â”‚   â”‚       â”‚
â”‚  â”‚  â”‚                                                                              â”‚   â”‚       â”‚
â”‚  â”‚  â”‚  æƒé™è§’è‰²:   [Member â–¼]                                                       â”‚   â”‚       â”‚
â”‚  â”‚  â”‚                                                                              â”‚   â”‚       â”‚
â”‚  â”‚  â”‚  å¯é€‰è§’è‰²:                                                                    â”‚   â”‚       â”‚
â”‚  â”‚  â”‚    â€¢ Owner  - å®Œå…¨æ§åˆ¶ (è½¬è®©æ‰€æœ‰æƒ)                                           â”‚   â”‚       â”‚
â”‚  â”‚  â”‚    â€¢ Admin  - å¯ç®¡ç†æˆå‘˜ã€åˆ›å»º/åˆ é™¤æœåŠ¡å’Œ VM                                   â”‚   â”‚       â”‚
â”‚  â”‚  â”‚    â€¢ Member - å¯åˆ›å»ºæœåŠ¡å’Œ VMï¼Œä¸èƒ½ç®¡ç†æˆå‘˜                                    â”‚   â”‚       â”‚
â”‚  â”‚  â”‚    â€¢ Viewer - åªè¯»è®¿é—®                                                        â”‚   â”‚       â”‚
â”‚  â”‚  â”‚                                                                              â”‚   â”‚       â”‚
â”‚  â”‚  â”‚  [æ·»åŠ ]  [å–æ¶ˆ]                                                               â”‚   â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“è®¾è®¡ (èµ„æºçº§æƒé™):                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  -- èµ„æºè§’è‰²ç»‘å®šè¡¨ (åŒºåˆ«äºå…¨å±€ role_bindings)                                       â”‚       â”‚
â”‚  â”‚  CREATE TABLE resource_role_bindings (                                            â”‚       â”‚
â”‚  â”‚    id VARCHAR PRIMARY KEY,                                                        â”‚       â”‚
â”‚  â”‚    user_id VARCHAR NOT NULL,                                                      â”‚       â”‚
â”‚  â”‚    role VARCHAR NOT NULL,          -- owner, admin, member, viewer                â”‚       â”‚
â”‚  â”‚    resource_type VARCHAR NOT NULL, -- system, service, vm                         â”‚       â”‚
â”‚  â”‚    resource_id VARCHAR NOT NULL,   -- å…·ä½“èµ„æº ID                                  â”‚       â”‚
â”‚  â”‚    granted_by VARCHAR NOT NULL,    -- æˆæƒäºº                                       â”‚       â”‚
â”‚  â”‚    created_at TIMESTAMP                                                           â”‚       â”‚
â”‚  â”‚  );                                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- ç¤ºä¾‹: å¼ ä¸‰æŠŠæå››æ·»åŠ ä¸º shop ç³»ç»Ÿçš„ Admin                                        â”‚       â”‚
â”‚  â”‚  INSERT INTO resource_role_bindings                                               â”‚       â”‚
â”‚  â”‚    (id, user_id, role, resource_type, resource_id, granted_by, created_at)        â”‚       â”‚
â”‚  â”‚  VALUES                                                                           â”‚       â”‚
â”‚  â”‚    ('rrb-001', 'user-002', 'admin', 'system', 'sys-001', 'user-001', NOW());      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ” æƒé™ç»§æ‰¿æ¨¡å‹ (å‚è€ƒ: Google Cloud IAM, GitHub Teams):                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  â­ æ ¸å¿ƒåŸåˆ™: å­èµ„æºå®Œå…¨ç»§æ‰¿çˆ¶èµ„æºçš„æƒé™                                              â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  â”Œâ”€ æƒé™åªéœ€è¦åœ¨ System å±‚é…ç½®ä¸€æ¬¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â”‚
â”‚  â”‚  â”‚                                                                                â”‚ â”‚       â”‚
â”‚  â”‚  â”‚  System (shop)                    â† åœ¨è¿™é‡Œæ·»åŠ æˆå‘˜                              â”‚ â”‚       â”‚
â”‚  â”‚  â”‚    â”œâ”€ Admin: æå››                                                             â”‚ â”‚       â”‚
â”‚  â”‚  â”‚    â”œâ”€ Member: ç‹äº”, èµµå…­                                                       â”‚ â”‚       â”‚
â”‚  â”‚  â”‚    â”‚                                                                           â”‚ â”‚       â”‚
â”‚  â”‚  â”‚    â”œâ”€â”€ Service (redis)            â† è‡ªåŠ¨ç»§æ‰¿æå››ã€ç‹äº”ã€èµµå…­çš„æƒé™              â”‚ â”‚       â”‚
â”‚  â”‚  â”‚    â”‚     â”œâ”€â”€ VM (redis-01)        â† è‡ªåŠ¨ç»§æ‰¿                                   â”‚ â”‚       â”‚
â”‚  â”‚  â”‚    â”‚     â””â”€â”€ VM (redis-02)        â† è‡ªåŠ¨ç»§æ‰¿                                   â”‚ â”‚       â”‚
â”‚  â”‚  â”‚    â”‚                                                                           â”‚ â”‚       â”‚
â”‚  â”‚  â”‚    â””â”€â”€ Service (mysql)            â† è‡ªåŠ¨ç»§æ‰¿                                   â”‚ â”‚       â”‚
â”‚  â”‚  â”‚          â””â”€â”€ VM (mysql-01)        â† è‡ªåŠ¨ç»§æ‰¿                                   â”‚ â”‚       â”‚
â”‚  â”‚  â”‚                                                                                â”‚ â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  âœ… å¥½å¤„:                                                                           â”‚       â”‚
â”‚  â”‚    - æ·»åŠ /ç§»é™¤æˆå‘˜åªéœ€ä¿®æ”¹ Systemï¼ŒService å’Œ VM è‡ªåŠ¨ç”Ÿæ•ˆ                            â”‚       â”‚
â”‚  â”‚    - é¿å…äº†ç»´æŠ¤å‡ åä¸ª Service/VM çš„æˆå‘˜é…ç½®                                          â”‚       â”‚
â”‚  â”‚    - ä¸ Google Cloud IAM å’Œ GitHub çš„ç»§æ‰¿æ¨¡å‹ä¸€è‡´                                   â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ” æƒé™æ£€æŸ¥ç®—æ³•:                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  ç”¨æˆ·è¯·æ±‚è®¿é—®èµ„æº R:                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  1. å…¨å±€æƒé™æ£€æŸ¥:                                                                  â”‚       â”‚
â”‚  â”‚     - æ‹¥æœ‰ platform:admin æƒé™ â†’ ç›´æ¥å…è®¸ï¼ˆæ˜¾å¼è¶…çº§ç®¡ç†å‘˜ï¼‰                      â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  2. èµ„æºçº§æƒé™æ£€æŸ¥ (å‘ä¸Šéå†ç»§æ‰¿é“¾):                                                 â”‚       â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â”‚
â”‚  â”‚     â”‚  è®¿é—® VM (vm-001):                                                        â”‚ â”‚       â”‚
â”‚  â”‚     â”‚    1. æ£€æŸ¥ vm-001 çš„ resource_role_binding â†’ æœªæ‰¾åˆ°                        â”‚ â”‚       â”‚
â”‚  â”‚     â”‚    2. å‘ä¸Š: æ£€æŸ¥æ‰€å± Service (svc-001) çš„ binding â†’ æœªæ‰¾åˆ°                  â”‚ â”‚       â”‚
â”‚  â”‚     â”‚    3. å†å‘ä¸Š: æ£€æŸ¥æ‰€å± System (sys-001) çš„ binding â†’ æ‰¾åˆ°! role=member     â”‚ â”‚       â”‚
â”‚  â”‚     â”‚    4. è¿”å› role=member çš„æƒé™ â†’ âœ… å…è®¸æŸ¥çœ‹                                 â”‚ â”‚       â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  ä¼ªä»£ç :                                                                           â”‚       â”‚
â”‚  â”‚  ```                                                                               â”‚       â”‚
â”‚  â”‚  func checkPermission(user, resource) Role:                                        â”‚       â”‚
â”‚  â”‚      current = resource                                                            â”‚       â”‚
â”‚  â”‚      while current != nil:                                                         â”‚       â”‚
â”‚  â”‚          binding = findBinding(user, current)                                      â”‚       â”‚
â”‚  â”‚          if binding != nil:                                                        â”‚       â”‚
â”‚  â”‚              return binding.role                                                   â”‚       â”‚
â”‚  â”‚          current = current.parent  // VMâ†’Serviceâ†’Systemâ†’nil                        â”‚       â”‚
â”‚  â”‚      return nil  // æ— æƒé™ï¼Œèµ„æºä¸å¯è§                                              â”‚       â”‚
â”‚  â”‚  ```                                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“Š æƒé™çŸ©é˜µ (ç»§æ‰¿è‡ª System çš„è§’è‰²):                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚       â”‚
â”‚  â”‚     â”‚ æ“ä½œ       â”‚ Owner  â”‚ Admin  â”‚ Member â”‚ Viewer â”‚                            â”‚       â”‚
â”‚  â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚       â”‚
â”‚  â”‚     â”‚ æŸ¥çœ‹èµ„æº   â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚                            â”‚       â”‚
â”‚  â”‚     â”‚ åˆ›å»ºå­èµ„æº â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚   âŒ   â”‚                            â”‚       â”‚
â”‚  â”‚     â”‚ ä¿®æ”¹èµ„æº   â”‚   âœ…   â”‚   âœ…   â”‚   âŒ   â”‚   âŒ   â”‚                            â”‚       â”‚
â”‚  â”‚     â”‚ åˆ é™¤èµ„æº   â”‚   âœ…   â”‚   âœ…   â”‚   âŒ   â”‚   âŒ   â”‚                            â”‚       â”‚
â”‚  â”‚     â”‚ ç®¡ç†æˆå‘˜   â”‚   âœ…   â”‚   âœ…   â”‚   âŒ   â”‚   âŒ   â”‚  â† ä»…åœ¨ System å±‚å¯æ“ä½œ       â”‚       â”‚
â”‚  â”‚     â”‚ è½¬è®©æ‰€æœ‰æƒ â”‚   âœ…   â”‚   âŒ   â”‚   âŒ   â”‚   âŒ   â”‚                            â”‚       â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ’¡ è®¾è®¡è¯´æ˜:                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  â€¢ Service å’Œ VM å±‚ä¸å•ç‹¬é…ç½®æˆå‘˜ï¼Œæƒé™å®Œå…¨ç»§æ‰¿è‡ª System                            â”‚       â”‚
â”‚  â”‚  â€¢ ä»¥ System ä¸ºå•ä½ç®¡ç†æƒé™ï¼Œç®€åŒ–è¿ç»´                                               â”‚       â”‚
â”‚  â”‚  â€¢ å¦‚éœ€æ›´ç»†ç²’åº¦éš”ç¦»ï¼Œå¯å°†èµ„æºæ‹†åˆ†åˆ°ä¸åŒ System                                       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  âš ï¸ æƒé™è¾¹ç•Œ:                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  Shepherd æ²»ç†å¹³å°è´Ÿè´£:                                                             â”‚       â”‚
â”‚  â”‚    âœ… è°å¯ä»¥çœ‹åˆ°è¿™äº› VM (å¯è§æ€§)                                                    â”‚       â”‚
â”‚  â”‚    âœ… è°å¯ä»¥åˆ›å»º/å¯åœ/åˆ é™¤ VM (ç”Ÿå‘½å‘¨æœŸç®¡ç†)                                         â”‚       â”‚
â”‚  â”‚    âœ… è°å¯ä»¥é€šè¿‡ VNC æ§åˆ¶å°è®¿é—® (Web æ§åˆ¶å°)                                         â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  Shepherd ä¸è´Ÿè´£:                                                                   â”‚       â”‚
â”‚  â”‚    âŒ è°å¯ä»¥ SSH/RDP ç™»å½• VM (ç”±ä¼ä¸šå ¡å’æœºæ§åˆ¶)                                      â”‚       â”‚
â”‚  â”‚    âŒ VM å†…éƒ¨çš„ç”¨æˆ·æƒé™ç®¡ç† (ç”± OS è‡ªèº«ç®¡ç†)                                         â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  å…¸å‹ä¼ä¸šæ¶æ„:                                                                       â”‚       â”‚
â”‚  â”‚    ç”¨æˆ· â†’ å ¡å’æœº (è®¤è¯/å®¡è®¡/å½•å±) â†’ VM                                              â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 4.B: ç”¨æˆ·åˆ›å»ºæœåŠ¡ (Service)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ç”¨æˆ·æ“ä½œ:                                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  åˆ›å»ºæœåŠ¡                                                                          â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  æ‰€å±ç³»ç»Ÿ:     [shop â–¼]                                                             â”‚       â”‚
â”‚  â”‚  æœåŠ¡åç§°:     [redis              ]    ğŸ‘ˆ ç³»ç»Ÿå†…å”¯ä¸€, æœ€é•¿ 15 å­—ç¬¦                  â”‚       â”‚
â”‚  â”‚  æœåŠ¡æè¿°:     [ç¼“å­˜æœåŠ¡            ]    ğŸ‘ˆ æ”¯æŒ Markdown æ ¼å¼                       â”‚       â”‚
â”‚  â”‚               [é¢„è§ˆ] [ä¸Šä¼  .md æ–‡ä»¶]        â† æˆ–ä¸Šä¼ å·²æœ‰ Markdown æ–‡ä»¶                â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  [åˆ›å»º]                                                                             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ“¦ æ•°æ®åº“æ“ä½œ (å•äº‹åŠ¡):                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  BEGIN TRANSACTION;                                                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 1. åˆ›å»ºæœåŠ¡                                                                    â”‚       â”‚
â”‚  â”‚  INSERT INTO services (id, name, description, system_id, created_by, created_at)  â”‚       â”‚
â”‚  â”‚  VALUES ('svc-001', 'redis', 'ç¼“å­˜æœåŠ¡', 'sys-001', 'zhang.san', NOW());           â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 2. æƒé™è‡ªåŠ¨ç»§æ‰¿è‡ª System (ä¸éœ€è¦é¢å¤– RoleBinding)                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  -- 3. ğŸ“ è®°å½•å®¡è®¡æ—¥å¿—                                                             â”‚       â”‚
â”‚  â”‚  INSERT INTO audit_logs (action, actor_id, resource_type, resource_id,            â”‚       â”‚
â”‚  â”‚                          parent_type, parent_id, details) VALUES                  â”‚       â”‚
â”‚  â”‚    ('service.create', 'zhang.san', 'service', 'svc-001', 'system', 'sys-001',     â”‚       â”‚
â”‚  â”‚     '{"name": "redis", "description": "ç¼“å­˜æœåŠ¡"}');                               â”‚       â”‚
â”‚  â”‚                                                                                    â”‚       â”‚
â”‚  â”‚  COMMIT;                                                                          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                              â”‚
â”‚  âœ… æ— éœ€å®¡æ‰¹: ç³»ç»Ÿæˆå‘˜å¯ä»¥åˆ›å»ºæœåŠ¡                                                             â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### State Transitions (Part 2)

| å®ä½“ | å…¸å‹çŠ¶æ€å˜åŒ– |
|------|-------------|
| System | `none -> ACTIVE`ï¼ˆåˆ›å»ºæˆåŠŸï¼‰ |
| Service | çˆ¶ System æ ¡éªŒé€šè¿‡å `none -> ACTIVE` |
| èµ„æºæˆå‘˜å…³ç³» | `none -> owner/admin/member/viewer`ï¼ˆéµå¾ªç»§æ‰¿è¯­ä¹‰ï¼‰ |

### Failure & Edge Cases (Part 2)

- æœªæˆæƒæˆ–ä¸å¯è§çš„çˆ¶ System ä¸‹åˆ›å»º Service å¿…é¡»å¤±è´¥ã€‚
- åŒä¸€ä½œç”¨åŸŸå†…é€»è¾‘åå†²çªå¿…é¡»åœ¨æäº¤å‰å¤±è´¥ã€‚
- åˆ é™¤å¿…é¡»æ»¡è¶³çº§è”çº¦æŸä¸ç¡®è®¤å‚æ•°è¦æ±‚ã€‚

### Authority Links (Part 2)

- [ADR-0015 Â§13 Deletion Cascade Constraints](../../../../adr/ADR-0015-governance-model-v2.md#13-deletion-cascade-constraints)
- [ADR-0019 Â§Baseline Controls (Normative)](../../../../adr/ADR-0019-governance-security-baseline-controls.md#baseline-controls-normative)
- [04-governance.md Â§6.1 Delete Cascade and Confirmation](../../../../design/phases/04-governance.md#61-delete-cascade-and-confirmation-mechanism-adr-0015-13-131)
- [database/schema-catalog.md Â§Table Domains](../../../../design/database/schema-catalog.md#table-domains)

### Scope Boundary (Part 2)

æœ¬éƒ¨åˆ†å®šä¹‰å±‚çº§ä¸æƒé™äº¤äº’é¢„æœŸã€‚DDLã€ç´¢å¼•ç­–ç•¥ä¸ SQL å®ç°ç»†èŠ‚ä»¥ database/phase æ–‡æ¡£ä¸ºå‡†ã€‚

---

## Part 3: VM ç”Ÿå‘½å‘¨æœŸæµç¨‹

> **è¯´æ˜**: æœ¬èŠ‚æè¿° VM çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼šåˆ›å»ºè¯·æ±‚ â†’ å®¡æ‰¹ â†’ æ‰§è¡Œ â†’ è¿è¡Œ â†’ åˆ é™¤

### Purpose

æè¿° VM ä»æäº¤ç”³è¯·åˆ°å®¡æ‰¹ã€æ‰§è¡Œã€è¿è¡Œã€åˆ é™¤çš„ç«¯åˆ°ç«¯äº¤äº’é¢„æœŸã€‚

### Actors & Trigger

- è§¦å‘ï¼šæ™®é€šç”¨æˆ·åœ¨ Service ä½œç”¨åŸŸæäº¤ VM åˆ›å»ºè¯·æ±‚ã€‚
- å‚ä¸æ–¹ï¼šç”³è¯·ç”¨æˆ·ã€å¹³å°å®¡æ‰¹ç®¡ç†å‘˜ã€å¼‚æ­¥ workerã€provider é›†æˆå±‚ã€‚

### Interaction Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 5.A: ç”¨æˆ·æäº¤ VM è¯·æ±‚                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  æ™®é€šç”¨æˆ·:                                                                                    â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ æäº¤ VM åˆ›å»ºè¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ç”¨æˆ·çœ‹åˆ°çš„ç•Œé¢:                                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  åˆ›å»ºè™šæ‹Ÿæœº                                                                        â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  æ‰€å±æœåŠ¡:     [shop / redis â–¼]                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  å‘½åç©ºé—´:     [prod-shop â–¼]                                                       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  æ¨¡æ¿:         [centos7-docker â–¼]                                                  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  InstanceSizeï¼ˆè§„æ ¼ï¼‰:         [gpu-workstation â–¼]                                                 â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€ InstanceSizeï¼ˆè§„æ ¼ï¼‰è¯¦æƒ… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  CPU: 8 æ ¸   å†…å­˜: 32 GB                                                      â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  âš ï¸ æ­¤InstanceSizeï¼ˆè§„æ ¼ï¼‰åŒ…å« GPU: nvidia.com/GA102GL_A10                                    â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚     è¯·ç¡®è®¤æ‚¨çš„ä¸šåŠ¡ç¡®å®éœ€è¦ GPU èµ„æº                                             â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€ å¿«é€Ÿé…ç½® â”€â”€                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  ç£ç›˜å¤§å°:     [====â—==========] [100] GB   ğŸ‘ˆ é»˜è®¤å€¼æ¥è‡ªInstanceSizeï¼ˆè§„æ ¼ï¼‰é¢„è®¾                   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                 50 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 500           ç”¨æˆ·å¯é€šè¿‡æ»‘å—æˆ–è¾“å…¥æ¡†è°ƒæ•´             â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  ç”³è¯·ç†ç”±:     [ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²                ]                                       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  [æäº¤ç”³è¯·]                                                                         â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â”‚  ğŸ‘† InstanceSizeï¼ˆè§„æ ¼ï¼‰ä¸‹æ‹‰æ¡†æ˜¾ç¤ºå…³é”®ä¿¡æ¯:                                                               â”‚ â”‚
â”‚  â”‚     - æ™®é€šInstanceSizeï¼ˆè§„æ ¼ï¼‰: "medium (4æ ¸ 8GB)" â†’ ç”¨æˆ·çœ‹åˆ° CPU å’Œå†…å­˜                                 â”‚ â”‚
â”‚  â”‚     - GPU InstanceSizeï¼ˆè§„æ ¼ï¼‰: "gpu-workstation (8æ ¸ 32GB)" + âš ï¸GPU æç¤º â†’ æé†’ç”¨æˆ·ç¡®è®¤æ˜¯å¦éœ€è¦         â”‚ â”‚
â”‚  â”‚                                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 5.B: ç®¡ç†å‘˜å®¡æ‰¹                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  å¹³å°ç®¡ç†å‘˜:                                                                                  â”‚
â”‚                                                                                              â”‚
â”‚  ç³»ç»Ÿæ ¹æ® InstanceSize.spec_overrides æå–èµ„æºéœ€æ±‚ï¼ŒåŒ¹é…é›†ç¾¤èƒ½åŠ›:                              â”‚
â”‚                                                                                              â”‚
â”‚  1. æå–èµ„æºéœ€æ±‚:                                                                             â”‚
â”‚     - GPU: nvidia.com/GA102GL_A10                                                            â”‚
â”‚     - Hugepages: hugepages-2Mi                                                               â”‚
â”‚                                                                                              â”‚
â”‚  2. åŒ¹é…é›†ç¾¤:                                                                                 â”‚
â”‚     - Cluster-A: æ”¯æŒ nvidia.com/GA102GL_A10, hugepages-2Mi â†’ âœ… åŒ¹é…                        â”‚
â”‚     - Cluster-B: ä¸æ”¯æŒ GPU â†’ âŒ è¿‡æ»¤                                                         â”‚
â”‚                                                                                              â”‚
â”‚  3. ç®¡ç†å‘˜å®¡æ‰¹ç•Œé¢:                                                                           â”‚
â”‚                                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å®¡æ‰¹ VM è¯·æ±‚                                                                              â”‚ â”‚
â”‚  â”‚                                                                                            â”‚ â”‚
â”‚  â”‚  è¯·æ±‚è¯¦æƒ…:                                                                                 â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚ â”‚
â”‚  â”‚  ç”³è¯·äºº:       zhang.san                                                                   â”‚ â”‚
â”‚  â”‚  å‘½åç©ºé—´:     prod-shop              ğŸ‘ˆ ç”Ÿäº§ç¯å¢ƒ                                          â”‚ â”‚
â”‚  â”‚  æœåŠ¡:         shop/redis                                                                  â”‚ â”‚
â”‚  â”‚  InstanceSizeï¼ˆè§„æ ¼ï¼‰:         gpu-workstation (8æ ¸ 32GB)                                                  â”‚ â”‚
â”‚  â”‚                                                                                            â”‚ â”‚
â”‚  â”‚  â”€â”€ ç£ç›˜é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚ â”‚
â”‚  â”‚  ç£ç›˜å¤§å°:     [100     ] GB   (ç”¨æˆ·ç”³è¯·å€¼: 100GB, InstanceSizeï¼ˆè§„æ ¼ï¼‰èŒƒå›´: 50-500GB)                      â”‚ â”‚
â”‚  â”‚                                                                                            â”‚ â”‚
â”‚  â”‚  â”€â”€ èµ„æºåˆ†é… (InstanceSizeï¼ˆè§„æ ¼ï¼‰å«è¶…å–æ—¶æ˜¾ç¤ºï¼Œå¯è¦†ç›–) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚ â”‚
â”‚  â”‚                                                                                            â”‚ â”‚
â”‚  â”‚  [âœ“] å¯ç”¨è¦†ç›–    ğŸ‘ˆ ç®¡ç†å‘˜å¯è¦†ç›–InstanceSizeï¼ˆè§„æ ¼ï¼‰çš„é»˜è®¤ request/limit å€¼                                  â”‚ â”‚
â”‚  â”‚                                                                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚                                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  CPU:    Request [4    ] æ ¸    Limit [8    ] æ ¸                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  å†…å­˜:   Request [16Gi ]       Limit [32Gi ]                                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  âš ï¸ è­¦å‘Š: ç”Ÿäº§ç¯å¢ƒå¯ç”¨äº†è¶…å–ï¼                 ğŸ‘ˆ ä»…ç”Ÿäº§ç¯å¢ƒæ˜¾ç¤ºæ­¤è­¦å‘Š                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚     é«˜è´Ÿè½½æ—¶å¯èƒ½å½±å“ VM æ€§èƒ½ã€‚                                                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  âŒ é”™è¯¯: ä¸“ç”¨ CPU ä¸è¶…å–ä¸å…¼å®¹ï¼Â²                 ğŸ‘ˆ æ£€æµ‹åˆ°å†²çªæ—¶æ˜¾ç¤º (çº¢è‰²é”™è¯¯)       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚     VM æ— æ³•å¯åŠ¨ã€‚å®¡æ‰¹å·²é˜»æ­¢ã€‚ä¿®å¤: ç¦ç”¨è¶…å– æˆ– å–æ¶ˆä¸“ç”¨ CPUã€‚                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                                            â”‚ â”‚
â”‚  â”‚  é›†ç¾¤:         [cluster-a â–¼]     ğŸ‘ˆ ç³»ç»Ÿå·²è¿‡æ»¤ä¸ç¬¦åˆè¦æ±‚çš„é›†ç¾¤                              â”‚ â”‚
â”‚  â”‚                                                                                            â”‚ â”‚
â”‚  â”‚  [æ‰¹å‡†]  [æ‹’ç»]                                                                            â”‚ â”‚
â”‚  â”‚                                                                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ‘† æ˜¾ç¤ºé€»è¾‘:                                                                                 â”‚
â”‚     - ç£ç›˜é…ç½®: å§‹ç»ˆæ˜¾ç¤ºï¼Œç®¡ç†å‘˜å¯è°ƒæ•´                                                          â”‚
â”‚     - èµ„æºåˆ†é… (request/limit): InstanceSizeï¼ˆè§„æ ¼ï¼‰å¯ç”¨è¶…å–æ—¶æ˜¾ç¤ºï¼Œä¸åŒºåˆ†ç¯å¢ƒ                                   â”‚
â”‚                                                                                              â”‚
â”‚  ğŸ‘† éªŒè¯é€»è¾‘:                                                                                  â”‚
â”‚     1. request â‰  limit ä¸”ç¯å¢ƒä¸º prod â†’ âš ï¸ é»„è‰²è­¦å‘Š (ä»…æç¤º)                                     â”‚
â”‚     2. è¶…å– + ä¸“ç”¨ CPU åŒæ—¶å¯ç”¨ â†’ âŒ é”™è¯¯ (é˜»æ­¢å®¡æ‰¹) Â²                                          â”‚
â”‚        KubeVirt è¦æ±‚ requests.cpu == limits.cpu æ‰èƒ½å¯ç”¨ dedicatedCpuPlacement (Guaranteed QoS)â”‚
â”‚                                                                                              â”‚
â”‚  Â² **æŠ€æœ¯çº¦æŸ**: `dedicatedCpuPlacement` è¦æ±‚ KubeVirt ä½¿ç”¨ Guaranteed QoS ç±»ï¼Œ               â”‚
â”‚    æ„å‘³ç€ CPU request å¿…é¡»ç­‰äº limitã€‚è¿™æ˜¯ K8s/KubeVirt ç¡¬æ€§çº¦æŸï¼Œæ— æ³•ç»•è¿‡ã€‚                       â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 5.C: VM åˆ›å»ºæ‰§è¡Œ                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œ:                                                                                â”‚
â”‚                                                                                              â”‚
â”‚  1. ç”Ÿæˆ VM åç§°: prod-shop-shop-redis-01                                                    â”‚
â”‚                                                                                              â”‚
â”‚  2. åˆå¹¶ç”Ÿæˆæœ€ç»ˆ YAML:                                                                        â”‚
â”‚     Template (åŸºç¡€æ¨¡æ¿) + InstanceSize.spec_overrides + ç”¨æˆ·å‚æ•° (disk_gb)                    â”‚
â”‚                                                                                              â”‚
â”‚  3. æ¸²æŸ“è¾“å‡º:                                                                                 â”‚
â”‚     apiVersion: kubevirt.io/v1                                                               â”‚
â”‚     kind: VirtualMachine                                                                     â”‚
â”‚     spec:                                                                                    â”‚
â”‚       template:                                                                              â”‚
â”‚         spec:                                                                                â”‚
â”‚           domain:                                                                            â”‚
â”‚             cpu:                                                                             â”‚
â”‚               cores: 8                                   â† æ¥è‡ª spec_overrides               â”‚
â”‚               dedicatedCpuPlacement: true                â† æ¥è‡ª spec_overrides               â”‚
â”‚             memory:                                                                          â”‚
â”‚               hugepages:                                                                     â”‚
â”‚                 pageSize: 2Mi                            â† æ¥è‡ª spec_overrides               â”‚
â”‚             devices:                                                                         â”‚
â”‚               gpus:                                                                          â”‚
â”‚                 - name: gpu1                             â† æ¥è‡ª spec_overrides               â”‚
â”‚                   deviceName: nvidia.com/GA102GL_A10                                        â”‚
â”‚                                                                                              â”‚
â”‚  4. æäº¤åˆ° K8s é›†ç¾¤                                                                           â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é˜¶æ®µ 5.B çº¦æŸè¯´æ˜ï¼šä¸“ç”¨ CPU ä¸è¶…å–

- ç¡¬çº¦æŸï¼š`dedicatedCpuPlacement` è¦æ±‚ Guaranteed QoSï¼Œå› æ­¤ CPU request å¿…é¡»ç­‰äº CPU limitã€‚
- è¯¥æ ¡éªŒåœ¨å®¡æ‰¹æµä¸­æ˜¯é˜»æ–­å‹é”™è¯¯ï¼ˆä¸æ˜¯æç¤ºå‹è­¦å‘Šï¼‰ã€‚
- å‚è€ƒï¼š
  [KubeVirt Compute resource requests and limits](https://kubevirt.io/user-guide/compute/resources_requests_and_limits/)

### å‚æ•°æ¥æºæ€»ç»“

| å‚æ•° | å¡«å†™è€… | æ¥æº | è¯´æ˜ |
|------|--------|------|------|
| **Schema å­—æ®µç±»å‹/é€‰é¡¹** | KubeVirt å®˜æ–¹ | JSON Schema | å¼€å‘è€…ä¸å®šä¹‰ï¼Œç›´æ¥ä½¿ç”¨å®˜æ–¹ Schema |
| **Mask è·¯å¾„** | å¼€å‘è€… | config/mask.yaml | åªæŒ‡å®šæš´éœ²å“ªäº›è·¯å¾„ |
| **InstanceSize å…·ä½“å€¼** | ç®¡ç†å‘˜ | Admin UI (Schema é©±åŠ¨) | ç®¡ç†å‘˜æ ¹æ® UI å¡«å†™ï¼Œå­˜ä¸º spec_overrides |
| **Cluster/StorageClass** | ç®¡ç†å‘˜ | å®¡æ‰¹æ—¶é€‰æ‹© | ç³»ç»Ÿè‡ªåŠ¨è¿‡æ»¤ç¬¦åˆæ¡ä»¶çš„é›†ç¾¤ |
| **VM Name/Labels** | ç³»ç»Ÿ | è‡ªåŠ¨ç”Ÿæˆ | ç”¨æˆ·ä¸å¯å¹²é¢„ |

### ä¸ä¹‹å‰è®¾è®¡çš„å…³é”®åŒºåˆ«

| æ–¹é¢ | ä¹‹å‰ï¼ˆé”™è¯¯ï¼‰ | ç°åœ¨ï¼ˆæ­£ç¡®ï¼‰ |
|------|-------------|-------------|
| **å­—æ®µé€‰é¡¹æ¥æº** | å¼€å‘è€…åœ¨ Mask ä¸­å®šä¹‰ | KubeVirt å®˜æ–¹ Schema |
| **å­˜å‚¨ç»“æ„** | `requirements map[string]string` | `spec_overrides map[string]interface{}` |
| **UI æ¸²æŸ“** | å¼€å‘è€…é¢„å®šä¹‰ä¸‹æ‹‰æ¡†é€‰é¡¹ | å‰ç«¯æ ¹æ® Schema ç±»å‹è‡ªåŠ¨æ¸²æŸ“ |
| **åç«¯èŒè´£** | åš KV å­é›†åŒ¹é… | åªå­˜å‚¨ JSONï¼Œæå–èµ„æºåšåŒ¹é… |

### State Transitions (é˜¶æ®µ 5.A-5.C)

| é˜¶æ®µ | å·¥å• | é¢†åŸŸäº‹ä»¶ | VM | Worker Job |
|------|------|----------|----|------------|
| 5.A æäº¤ | åˆ›å»ºä¸º `PENDING_APPROVAL` | åˆ›å»ºä¸º `PENDING` | æ—  | æ—  |
| 5.B æ‰¹å‡† | `PENDING_APPROVAL -> APPROVED` | `PENDING -> PROCESSING` | åˆ›å»ºä¸º `CREATING` | æ’å…¥ |
| 5.B æ‹’ç» | `PENDING_APPROVAL -> REJECTED` | `PENDING -> CANCELLED` | æ—  | æ—  |
| 5.C æ‰§è¡Œ | ä¸å˜ | éšæ‰§è¡Œæ¨è¿› | `CREATING -> RUNNING|FAILED` | æ¶ˆè´¹å¹¶å®Œæˆ |

### Failure & Edge Cases (é˜¶æ®µ 5.A-5.C)

- åŒä¸€æ“ä½œçš„é‡å¤å¾…å®¡æ‰¹æäº¤å¿…é¡»åœ¨å†™å…¥å‰æ‹¦æˆªã€‚
- å®¡æ‰¹é˜¶æ®µé›†ç¾¤èƒ½åŠ›ä¸åŒ¹é…å¿…é¡»é˜»æ–­å®¡æ‰¹ï¼Œä¸å¾—è°ƒåº¦ workerã€‚
- æ‰§è¡Œå¤±è´¥å¿…é¡»ä¿ç•™å¯å®¡è®¡è½¨è¿¹å¹¶æ”¯æŒç¡®å®šæ€§é‡è¯•ã€‚

### Authority Links (é˜¶æ®µ 5.A-5.C)

- [ADR-0017 Â§Decision](../../../../adr/ADR-0017-vm-request-flow-clarification.md#decision)
- [ADR-0018 Â§User Interaction Flow](../../../../adr/ADR-0018-instance-size-abstraction.md#user-interaction-flow)
- [database/vm-lifecycle-write-model.md Â§Stage 5.A](../../../../design/database/vm-lifecycle-write-model.md#stage-5a-vm-request-submission-pending-approval)
- [frontend/FRONTEND.md Â§API Type Integration](../../../../design/frontend/FRONTEND.md#api-type-integration-adr-0021)

### Scope Boundary (é˜¶æ®µ 5.A-5.C)

æœ¬èŠ‚å®šä¹‰äº¤äº’é¡ºåºä¸çŠ¶æ€é¢„æœŸã€‚SQL/DDL/è¿ç§»ä¸ worker å®ç°ç»†èŠ‚ä»¥ database/phase æ–‡æ¡£ä¸ºå‡†ã€‚

---

### é˜¶æ®µ 5.Aï¼šæŒä¹…åŒ–æ‘˜è¦ {#stage-5-a}

#### Purpose

æ€»ç»“ç”¨æˆ·æäº¤ VM è¯·æ±‚åçš„æŒä¹…åŒ–æ„å›¾ï¼ŒåŒæ—¶å°†å®ç°ç»†èŠ‚ä¸‹æ²‰åˆ°æ•°æ®åº“æ–‡æ¡£å±‚ã€‚

#### Actors & Trigger

- è§¦å‘ï¼šç”¨æˆ·æäº¤ VM åˆ›å»ºè¯·æ±‚ã€‚
- å‚ä¸æ–¹ï¼šç”³è¯·äººã€å®¡æ‰¹å·¥ä½œæµå­ç³»ç»Ÿã€é€šçŸ¥å­ç³»ç»Ÿã€‚

#### Interaction Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 5.A æŒä¹…åŒ–æ„å›¾ï¼ˆæäº¤å†™é›†ï¼‰                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  ç”³è¯·äººæäº¤ VM è¯·æ±‚                                                                           â”‚
â”‚        â”‚                                                                                     â”‚
â”‚        â–¼                                                                                     â”‚
â”‚  API é¢„æ£€æŸ¥ï¼ˆRBAC + é‡å¤å¾…å®¡æ‰¹æ‹¦æˆªï¼‰                                                          â”‚
â”‚        â”‚                                                                                     â”‚
â”‚        â–¼                                                                                     â”‚
â”‚  å•äº‹åŠ¡å†™å…¥ï¼š                                                                                â”‚
â”‚    1) approval_tickets: åˆ›å»º `PENDING_APPROVAL`                                              â”‚
â”‚    2) domain_events: åˆ›å»º `PENDING`                                                          â”‚
â”‚    3) audit_logs: è¿½åŠ è§„èŒƒæäº¤åŠ¨ä½œ                                                           â”‚
â”‚        â”‚                                                                                     â”‚
â”‚        â–¼                                                                                     â”‚
â”‚  è¿”å› `202 Accepted`ï¼Œå‰ç«¯æ®æ­¤è½®è¯¢å·¥å•çŠ¶æ€                                                     â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### State Transitions

| å®ä½“ | ä¹‹å‰ | ä¹‹å |
|------|------|------|
| `approval_tickets` | æ—  | `PENDING_APPROVAL` |
| `domain_events` | æ—  | `PENDING` |
| `vms` | æ—  | æ—  |
| `river_job` | æ—  | æ—  |

#### Failure & Edge Cases

- åŒç±»å¾…å®¡æ‰¹è¯·æ±‚é‡å¤æäº¤å¿…é¡»è¿”å›å†²çªå¹¶ç»™å‡ºå·²æœ‰å·¥å•å¼•ç”¨ã€‚
- äº‹åŠ¡å†…ä»»ä¸€å†™å…¥å¤±è´¥å¿…é¡»æ•´ä½“å›æ»šã€‚

#### Authority Links

- [database/vm-lifecycle-write-model.md Â§Stage 5.A](../../../../design/database/vm-lifecycle-write-model.md#stage-5a-vm-request-submission-pending-approval)
- [ADR-0009 Â§Constraint 1 DomainEvent Payload Immutability](../../../../adr/ADR-0009-domain-event-pattern.md#constraint-1-domainevent-payload-immutability-append-only)
- [ADR-0012 Â§Adopt Ent + sqlc Hybrid Mode](../../../../adr/ADR-0012-hybrid-transaction.md#adopt-ent-sqlc-hybrid-mode)

#### Scope Boundary

æœ¬èŠ‚ä¸å®šä¹‰ SQL è¯­å¥ã€ç´¢å¼•å’Œè¿ç§»ç»†èŠ‚ã€‚

### é˜¶æ®µ 5.Bï¼šæŒä¹…åŒ–æ‘˜è¦ {#stage-5-b}

#### Purpose

æ€»ç»“ç®¡ç†å‘˜æ‰¹å‡†/æ‹’ç»è·¯å¾„ä¸‹çš„å†™å…¥ç»“æœä¸ä¸€è‡´æ€§ä¿è¯ã€‚

#### Actors & Trigger

- è§¦å‘ï¼šç®¡ç†å‘˜å¯¹å¾…å®¡æ‰¹ VM è¯·æ±‚æ‰§è¡Œæ‰¹å‡†æˆ–æ‹’ç»ã€‚
- å‚ä¸æ–¹ï¼šå®¡æ‰¹äººã€äº‹åŠ¡ç¼–æ’å±‚ã€River è°ƒåº¦å™¨ã€‚

#### Interaction Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 5.B æŒä¹…åŒ–æ„å›¾ï¼ˆå†³ç­–å†™é›†ï¼‰                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  å®¡æ‰¹äººæ‰“å¼€å¾…å®¡æ‰¹å·¥å•                                                                          â”‚
â”‚        â”‚                                                                                     â”‚
â”‚        â”œâ”€â”€ æ‰¹å‡†è·¯å¾„                                                                            â”‚
â”‚        â”‚      1) å·¥å•ï¼š`PENDING_APPROVAL -> APPROVED`                                        â”‚
â”‚        â”‚      2) äº‹ä»¶ï¼š`PENDING -> PROCESSING`                                               â”‚
â”‚        â”‚      3) VMï¼šæ’å…¥å¹¶ç½®ä¸º `CREATING`                                                   â”‚
â”‚        â”‚      4) Riverï¼šå…¥é˜Ÿæ‰§è¡Œä»»åŠ¡                                                         â”‚
â”‚        â”‚      5) å®¡è®¡ï¼šè®°å½•æ‰¹å‡†åŠ¨ä½œ                                                          â”‚
â”‚        â”‚                                                                                     â”‚
â”‚        â””â”€â”€ æ‹’ç»è·¯å¾„                                                                            â”‚
â”‚               1) å·¥å•ï¼š`PENDING_APPROVAL -> REJECTED`                                        â”‚
â”‚               2) äº‹ä»¶ï¼š`PENDING -> CANCELLED`                                                â”‚
â”‚               3) ä¸åˆ›å»º VM / ä¸å…¥é˜Ÿ River                                                    â”‚
â”‚               4) å®¡è®¡ï¼šè®°å½•æ‹’ç»åŠ¨ä½œ                                                          â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### State Transitions

| è·¯å¾„ | å·¥å• | é¢†åŸŸäº‹ä»¶ | VM | River Job |
|------|------|----------|----|-----------|
| æ‰¹å‡† | `PENDING_APPROVAL -> APPROVED` | `PENDING -> PROCESSING` | åˆ›å»ºå¹¶ç½®ä¸º `CREATING` | æ’å…¥ï¼ˆ`available`ï¼‰ |
| æ‹’ç» | `PENDING_APPROVAL -> REJECTED` | `PENDING -> CANCELLED` | ä¸åˆ›å»º | ä¸æ’å…¥ |

#### Failure & Edge Cases

- æ‰¹å‡†è·¯å¾„å¿…é¡»ä¿æŒ claim-checkï¼ˆRiver ä»…æºå¸¦ EventID å¼•ç”¨ï¼‰ã€‚
- æ‹’ç»è·¯å¾„ä¸å¾—åˆ›å»º VM è®°å½•æˆ–å¼‚æ­¥ä»»åŠ¡ã€‚

#### Authority Links

- [database/vm-lifecycle-write-model.md Â§Stage 5.B](../../../../design/database/vm-lifecycle-write-model.md#stage-5b-admin-approval-rejection)
- [ADR-0006 Â§Decision](../../../../adr/ADR-0006-unified-async-model.md#decision)
- [ADR-0009 Â§Constraint 1 DomainEvent Payload Immutability](../../../../adr/ADR-0009-domain-event-pattern.md#constraint-1-domainevent-payload-immutability-append-only)
- [ADR-0012 Â§Adopt Ent + sqlc Hybrid Mode](../../../../adr/ADR-0012-hybrid-transaction.md#adopt-ent-sqlc-hybrid-mode)

#### Scope Boundary

æœ¬èŠ‚ä»…å®šä¹‰çŠ¶æ€ç»“æœä¸äº‹åŠ¡ä¿è¯ï¼Œä¸å±•å¼€ SQL/DDLã€‚

### é˜¶æ®µ 5.D: åˆ é™¤æ“ä½œ {#stage-5-d}

#### Purpose

å®šä¹‰ VM/Service/System åˆ é™¤çš„äº¤äº’è¡Œä¸ºä¸çŠ¶æ€é¢„æœŸã€‚

#### Actors & Trigger

- è§¦å‘ï¼šç”¨æˆ·æˆ–ç®¡ç†å‘˜å‘èµ·åˆ é™¤ APIï¼Œå¹¶æºå¸¦å¿…éœ€ç¡®è®¤å‚æ•°ã€‚
- å‚ä¸æ–¹ï¼šè¯·æ±‚æ–¹ã€å®¡æ‰¹å·¥ä½œæµï¼ˆä»… VMï¼‰ã€å¼‚æ­¥ workerã€å®¡è®¡å­ç³»ç»Ÿã€‚

#### Interaction Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ é™¤ç”¨æˆ·æ—…ç¨‹ï¼ˆäº¤äº’æ„å›¾ï¼‰                                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  èµ„æºè¯¦æƒ…é¡µï¼ˆVM / Service / Systemï¼‰                                                           â”‚
â”‚        â”‚                                                                                     â”‚
â”‚        â–¼                                                                                     â”‚
â”‚  ç‚¹å‡»åˆ é™¤ -> UI äºŒæ¬¡ç¡®è®¤ï¼ˆ`confirm=true` æˆ– `confirm_name`ï¼‰                                 â”‚
â”‚        â”‚                                                                                     â”‚
â”‚        â–¼                                                                                     â”‚
â”‚  API æ ¡éªŒï¼šRBAC + çº§è”å‰ç½®æ¡ä»¶ + ç¯å¢ƒç­–ç•¥                                                      â”‚
â”‚        â”‚                                                                                     â”‚
â”‚        â”œâ”€â”€ VM è·¯å¾„ï¼šåˆ›å»ºåˆ é™¤å®¡æ‰¹å·¥å• -> å®¡æ‰¹å†³ç­–                                                â”‚
â”‚        â”‚                                                                                     â”‚
â”‚        â””â”€â”€ Service/System è·¯å¾„ï¼šæ— åˆ é™¤å®¡æ‰¹å·¥å•                                                 â”‚
â”‚        â”‚                                                                                     â”‚
â”‚        â–¼                                                                                     â”‚
â”‚  æ‰§è¡Œè·¯å¾„å¯çŸ­æš‚è¿›å…¥ `DELETING`ï¼Œå®Œæˆæ¸…ç†åä¸»è¡¨ç¡¬åˆ é™¤                                           â”‚
â”‚  ï¼ˆå®¡è®¡æ—¥å¿—/å®¡æ‰¹è®°å½•/é¢†åŸŸäº‹ä»¶æŒ‰ä¿ç•™ç­–ç•¥ç‹¬ç«‹ç•™å­˜ï¼‰                                              â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å®ä½“è§„åˆ™çŸ©é˜µï¼š

| å®ä½“ | å‰ç½®æ¡ä»¶ | å®¡æ‰¹ | ç¡®è®¤æ–¹å¼ | ä¸»è¡¨è¡Œä¸º |
|------|------|------|------|------|
| VMï¼ˆæµ‹è¯•ï¼‰ | æ—  | âœ… éœ€è¦ | `confirm=true` | `DELETING`ï¼ˆçŸ­æš‚ï¼‰-> ç¡¬åˆ é™¤ |
| VMï¼ˆç”Ÿäº§ï¼‰ | æ—  | âœ… éœ€è¦ | `confirm_name` | `DELETING`ï¼ˆçŸ­æš‚ï¼‰-> ç¡¬åˆ é™¤ |
| Service | å­ VM å¿…é¡»ä¸º 0 | âŒ ä¸éœ€è¦ | `confirm=true` | `DELETING`ï¼ˆçŸ­æš‚ï¼‰-> ç¡¬åˆ é™¤ |
| System | å­ Service å¿…é¡»ä¸º 0 | âŒ ä¸éœ€è¦ | `confirm_name` | ç›´æ¥ç¡¬åˆ é™¤ |

#### State Transitions

| æµç¨‹ | å·¥å• | èµ„æº | æœ€ç»ˆæŒä¹…åŒ–ç»“æœ |
|------|------|------|----------------|
| VM åˆ é™¤ï¼ˆå®¡æ‰¹é€šè¿‡ï¼‰ | `PENDING_APPROVAL -> APPROVED` | `RUNNING/STOPPED -> DELETING -> (ä¸»è¡¨åˆ é™¤)` | VM ä¸»è®°å½•ç¡¬åˆ é™¤ï¼Œå®¡è®¡/å·¥å•/äº‹ä»¶ç‹¬ç«‹ä¿ç•™ |
| Service åˆ é™¤ | æ— å·¥å• | `ACTIVE -> DELETING -> (ä¸»è¡¨åˆ é™¤)` | æ¸…ç†å®Œæˆåç¡¬åˆ é™¤ Service ä¸»è®°å½• |
| System åˆ é™¤ | æ— å·¥å• | `ACTIVE -> (ä¸»è¡¨åˆ é™¤)` | æ ¡éªŒé€šè¿‡åäº‹åŠ¡å†…ç¡¬åˆ é™¤ |

#### Failure & Edge Cases

- çº§è”å‰ç½®æ¡ä»¶ä¸æ»¡è¶³å¿…é¡»é˜»æ–­åˆ é™¤ã€‚
- ç¡®è®¤å‚æ•°ä¸åŒ¹é…å¿…é¡»åœ¨å†™å…¥å‰å¤±è´¥ã€‚
- è¿›å…¥ `DELETING` åè‹¥ worker å¤±è´¥ï¼Œå¿…é¡»å¯é‡è¯•ä¸”å¯å®¡è®¡ã€‚

#### Authority Links

- [ADR-0015 Â§13 Deletion Cascade Constraints](../../../../adr/ADR-0015-governance-model-v2.md#13-deletion-cascade-constraints)
- [ADR-0015 Â§13.1 Confirmation Mechanism](../../../../adr/ADR-0015-governance-model-v2.md#131-delete-confirmation-mechanism)
- [04-governance.md Â§6.1 Delete Cascade and Confirmation](../../../../design/phases/04-governance.md#61-delete-cascade-and-confirmation-mechanism-adr-0015-13-131)
- [04-governance.md Â§7 Audit Logging](../../../../design/phases/04-governance.md#7-audit-logging)
- [database/lifecycle-retention.md Â§Retention Classes](../../../../design/database/lifecycle-retention.md#retention-classes-table-centric)
- [database/vm-lifecycle-write-model.md Â§Stage 5.D](../../../../design/database/vm-lifecycle-write-model.md#stage-5d-delete-write-model)

#### Scope Boundary

æœ¬èŠ‚åªå®šä¹‰åˆ é™¤äº¤äº’æ„å›¾å’Œç»“æœï¼Œä¸å±•å¼€ Schema/DDL/å½’æ¡£ä½œä¸šç»†èŠ‚ã€‚

> **åˆ é™¤åŠ¨ä½œå‘½åè§„èŒƒ**:
> - V1 è§„èŒƒåŠ¨ä½œï¼š`*.delete_submitted`ã€`*.delete_approved`ï¼ˆè‹¥é€‚ç”¨ï¼‰ã€`*.delete_executed`ã€‚
> - `*.delete_request` / `*.delete` å±äºæ—§å‘½åï¼Œåªå…è®¸å‡ºç°åœ¨å†å²æè¿°ä¸­ï¼›æ–°å¢è®¾è®¡å†…å®¹å¿…é¡»ä½¿ç”¨ä¸Šè¿°è§„èŒƒå‘½åã€‚

---

### é˜¶æ®µ 5.E: æ‰¹é‡æ“ä½œ

#### Purpose

å®šä¹‰çˆ¶å­å·¥å•æ¨¡å‹ä¸‹çš„æ‰¹é‡æäº¤æµç¨‹ã€æ‰§è¡Œè¯­ä¹‰ä¸å‰ç«¯å¯è§è¡Œä¸ºã€‚

#### Actors & Trigger

- è§¦å‘ï¼šç”¨æˆ·/ç®¡ç†å‘˜æäº¤åŒ…å«å¤šä¸ªå­é¡¹çš„æ‰¹é‡æ“ä½œã€‚
- å‚ä¸æ–¹ï¼šå‰ç«¯é˜Ÿåˆ— UIã€API å±‚ã€æ²»ç†äº‹åŠ¡å±‚ã€River workerã€‚

#### Interaction Flow

UI æ•…äº‹æ¿ï¼ˆçˆ¶å­é˜Ÿåˆ—ï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰¹é‡é˜Ÿåˆ— UI æ•…äº‹æ¿                                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                  â”‚
â”‚  [æ‰¹é‡æ“ä½œé¡µé¢]                                                                                  â”‚
â”‚     é€‰æ‹© VM + é€‰æ‹©æ“ä½œ + æäº¤                                                                     â”‚
â”‚                                  â”‚                                                               â”‚
â”‚                                  â–¼                                                               â”‚
â”‚  [é˜Ÿåˆ—åˆ—è¡¨é¡µ]                                                                                     â”‚
â”‚     æ–°çˆ¶å·¥å•å‡ºç°ï¼š`PENDING_APPROVAL`                                                             â”‚
â”‚     å±•ç¤ºï¼šæ€»æ•°/æˆåŠŸ/å¤±è´¥/å¾…å¤„ç† + ç”³è¯·äºº + æ›´æ–°æ—¶é—´                                               â”‚
â”‚                                  â”‚                                                               â”‚
â”‚                                  â–¼                                                               â”‚
â”‚  [å±•å¼€çˆ¶å·¥å•]                                                                                     â”‚
â”‚     å­ä»»åŠ¡è¡¨å±•ç¤ºï¼šå•é¡¹çŠ¶æ€ + attempt_count + last_error                                          â”‚
â”‚                                  â”‚                                                               â”‚
â”‚                                  â–¼                                                               â”‚
â”‚  [è¿›è¡Œä¸­/ç»ˆæ€å¤„ç†]                                                                                â”‚
â”‚     `IN_PROGRESS`      -> æ“ä½œï¼šç»ˆæ­¢æœªå¼€å§‹å­é¡¹                                                    â”‚
â”‚     `PARTIAL_SUCCESS`  -> æ“ä½œï¼šé‡è¯•å¤±è´¥å­é¡¹                                                      â”‚
â”‚     `FAILED`           -> æ“ä½œï¼šé‡è¯•å¤±è´¥å­é¡¹                                                      â”‚
â”‚     `COMPLETED`        -> æ“ä½œï¼šå¯¼å‡ºç»“æœ                                                          â”‚
â”‚                                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰¹é‡æäº¤æµç¨‹ï¼ˆè§„èŒƒï¼‰                                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                  â”‚
â”‚  1. ç”¨æˆ·/ç®¡ç†å‘˜åœ¨ UI é€‰æ‹©æ‰¹é‡é¡¹                                                                   â”‚
â”‚  2. å‰ç«¯: POST /api/v1/vms/batch                                                                 â”‚
â”‚  3. åç«¯å‰ç½®æ£€æŸ¥:                                                                                 â”‚
â”‚     â€¢ Layer 1ï¼ˆå…¨å±€ï¼‰: çˆ¶å·¥å•ç§¯å‹é˜ˆå€¼ + API é€Ÿç‡                                                   â”‚
â”‚     â€¢ Layer 2ï¼ˆç”¨æˆ·ï¼‰: ç”¨æˆ·çˆ¶/å­å·¥å•é˜ˆå€¼ + æäº¤å†·å´æ—¶é—´                                             â”‚
â”‚  4. åŸå­äº‹åŠ¡:                                                                                     â”‚
â”‚     â€¢ æ’å…¥çˆ¶å·¥å•                                                                                  â”‚
â”‚     â€¢ æ’å…¥å…¨éƒ¨å­å·¥å•                                                                              â”‚
â”‚     â€¢ ä»»ä¸€å­å·¥å•å¤±è´¥åˆ™æ•´ä½“å›æ»š                                                                      â”‚
â”‚  5. è¿”å› 202: {batch_id, status, status_url, retry_after_seconds}                                â”‚
â”‚  6. å‰ç«¯è½®è¯¢: GET /api/v1/vms/batch/{batch_id}                                                   â”‚
â”‚                                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰¹é‡æ‰§è¡Œæµç¨‹                                                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                  â”‚
â”‚  1. çˆ¶å·¥å•è¿›å…¥ APPROVED/IN_PROGRESS                                                              â”‚
â”‚  2. Worker ç‹¬ç«‹æ¶ˆè´¹å­ä»»åŠ¡                                                                         â”‚
â”‚  3. èšåˆç»ˆæ€è®¡ç®—:                                                                                 â”‚
â”‚     â€¢ COMPLETED: å…¨éƒ¨æˆåŠŸ                                                                         â”‚
â”‚     â€¢ FAILED: å…¨éƒ¨å¤±è´¥                                                                            â”‚
â”‚     â€¢ PARTIAL_SUCCESS: éƒ¨åˆ†æˆåŠŸ                                                                    â”‚
â”‚     â€¢ CANCELLED: æœªå¼€å§‹å­ä»»åŠ¡è¢«ç»ˆæ­¢                                                                â”‚
â”‚  4. å‰ç«¯å¯æ“ä½œ:                                                                                   â”‚
â”‚     â€¢ POST /api/v1/vms/batch/{id}/retry  ï¼ˆä»…é‡è¯•å¤±è´¥å­é¡¹ï¼‰                                      â”‚
â”‚     â€¢ POST /api/v1/vms/batch/{id}/cancel ï¼ˆç»ˆæ­¢å¾…æ‰§è¡Œå­é¡¹ï¼‰                                       â”‚
â”‚                                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…¼å®¹æ¥å£è¯´æ˜                                                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                  â”‚
â”‚  å…¼å®¹ä¿ç•™ï¼š                                                                                        â”‚
â”‚  â€¢ POST /api/v1/approvals/batch                                                                  â”‚
â”‚  â€¢ POST /api/v1/vms/batch/power                                                                  â”‚
â”‚                                                                                                  â”‚
â”‚  å†…éƒ¨ç»Ÿä¸€å½’ä¸€åˆ°åŒä¸€å¥—çˆ¶å­å·¥å•æµæ°´çº¿ã€‚                                                               â”‚
â”‚                                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### State Transitions

| èŒƒå›´ | çŠ¶æ€å˜åŒ–æ¨¡å¼ |
|------|-------------|
| çˆ¶å·¥å• | `PENDING_APPROVAL -> APPROVED/IN_PROGRESS -> COMPLETED|PARTIAL_SUCCESS|FAILED|CANCELLED` |
| å­å·¥å• | `PENDING -> RUNNING -> SUCCESS|FAILED|CANCELLED` |

#### Failure & Edge Cases

- å…¨å±€æˆ–ç”¨æˆ·çº§é™æµæ‹’ç»å¿…é¡»è¿”å›å¯æ‰§è¡Œé‡è¯•çª—å£ã€‚
- å­ä»»åŠ¡å¤±è´¥ä¸å¾—å›æ»šå·²æˆåŠŸå­ä»»åŠ¡ã€‚
- é‡è¯•/ç»ˆæ­¢æ“ä½œä»…ä½œç”¨äºç¬¦åˆæ¡ä»¶å­ä»»åŠ¡ï¼Œå¹¶é‡ç®—çˆ¶å·¥å•èšåˆçŠ¶æ€ã€‚

#### Authority Links

- [ADR-0015 Â§19 Batch Operations V1](../../../../adr/ADR-0015-governance-model-v2.md#19-batch-operations)
- [04-governance.md Â§5.6 Batch Operations](../../../../design/phases/04-governance.md#56-batch-operations-adr-0015-19)
- [database/vm-lifecycle-write-model.md Â§Stage 5.E](../../../../design/database/vm-lifecycle-write-model.md#stage-5e-batch-parent-child-write-model)
- [frontend/features/batch-operations-queue.md Â§2.0 End-to-End UI Storyboard](../../../../design/frontend/features/batch-operations-queue.md#20-end-to-end-ui-storyboard)

#### Scope Boundary

æœ¬èŠ‚ä»…å®šä¹‰äº¤äº’è¡Œä¸ºä¸çŠ¶æ€è¯­ä¹‰ï¼Œé˜Ÿåˆ—å†…éƒ¨å®ç°ã€è¡¨ç»“æ„å’Œ worker è°ƒä¼˜ç»†èŠ‚ä»¥ phase/database æ–‡æ¡£ä¸ºå‡†ã€‚

---

### é˜¶æ®µ 5.F: é€šçŸ¥ç³»ç»Ÿ

#### Purpose

å®šä¹‰å®¡æ‰¹ä¸ VM ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„ç”¨æˆ·å¯è§é€šçŸ¥è¡Œä¸ºã€‚

#### Actors & Trigger

- è§¦å‘ï¼šå®¡æ‰¹æµç¨‹äº‹ä»¶å’Œ VM çŠ¶æ€å˜æ›´ã€‚
- å‚ä¸æ–¹ï¼šäº‹åŠ¡ç¼–æ’å±‚ã€ç«™å†…ä¿¡é€šçŸ¥æœåŠ¡ã€å‰ç«¯è½®è¯¢ç•Œé¢ã€‚

#### Interaction Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€šçŸ¥è§¦å‘ç‚¹                                                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                  â”‚
â”‚  äº‹ä»¶: VM è¯·æ±‚å·²æäº¤                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ INSERT INTO notifications (recipient_id, type, title, body, metadata)               â”‚        â”‚
â”‚  â”‚ SELECT user_id, 'APPROVAL_PENDING', 'æ–° VM è¯·æ±‚å¾…å®¡æ‰¹',                               â”‚        â”‚
â”‚  â”‚        'ç”¨æˆ· X åœ¨å‘½åç©ºé—´ Y æäº¤äº†ä¸€ä¸ªè¯·æ±‚',                                            â”‚        â”‚
â”‚  â”‚        '{"ticket_id": "TKT-001", "requester": "user-a"}'                             â”‚        â”‚
â”‚  â”‚ FROM role_bindings                                                                   â”‚        â”‚
â”‚  â”‚ WHERE role_id IN (SELECT id FROM roles WHERE permissions @> 'approval:approve');    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                                                  â”‚
â”‚  äº‹ä»¶: è¯·æ±‚å·²æ‰¹å‡†/æ‹’ç»                                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ INSERT INTO notifications (recipient_id, type, title, metadata)                     â”‚        â”‚
â”‚  â”‚ VALUES (ticket.requested_by, 'APPROVAL_COMPLETED',                                  â”‚        â”‚
â”‚  â”‚         'æ‚¨çš„ VM è¯·æ±‚å·²æ‰¹å‡†', '{"ticket_id": "TKT-001"}');                            â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                                                  â”‚
â”‚  äº‹ä»¶: VM çŠ¶æ€å˜æ›´                                                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ INSERT INTO notifications (recipient_id, type, title, metadata)                     â”‚        â”‚
â”‚  â”‚ VALUES (vm.owner_id, 'VM_STATUS_CHANGE',                                            â”‚        â”‚
â”‚  â”‚         'VM vm-name-01 ç°å·²è¿è¡Œä¸­', '{"vm_id": "...", "new_state": "Running"}');     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·é€šçŸ¥äº¤äº’                                                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                  â”‚
â”‚  å‰ç«¯é¡¶æ :                                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚  ğŸ”” (3)  â† å¾½ç« æ˜¾ç¤ºæœªè¯»æ•°é‡                                          â”‚                        â”‚
â”‚  â”‚    â†“ æ¯ 30s è½®è¯¢: GET /api/v1/notifications/unread-count            â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                                                  â”‚
â”‚  ç‚¹å‡»é€šçŸ¥é“ƒé“› â†’ ä¸‹æ‹‰é¢æ¿:                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚  GET /api/v1/notifications?page=1&per_page=10                       â”‚                        â”‚
â”‚  â”‚                                                                     â”‚                        â”‚
â”‚  â”‚  â€¢ ğŸ”µ æ–° VM è¯·æ±‚å¾…å¤„ç† (2 åˆ†é’Ÿå‰)                                    â”‚                        â”‚
â”‚  â”‚  â€¢ ğŸ”µ æ‚¨çš„è¯·æ±‚å·²æ‰¹å‡† (1 å°æ—¶å‰)                                      â”‚                        â”‚
â”‚  â”‚  â€¢ VM shop-redis-01 ç°å·²è¿è¡Œä¸­ (3 å°æ—¶å‰)                            â”‚                        â”‚
â”‚  â”‚                                                                     â”‚                        â”‚
â”‚  â”‚  [å…¨éƒ¨æ ‡ä¸ºå·²è¯»]  [æŸ¥çœ‹å…¨éƒ¨ â†’]                                         â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                                                  â”‚
â”‚  æ ‡è®°å·²è¯»: PATCH /api/v1/notifications/{id}/read                                                â”‚
â”‚  å…¨éƒ¨å·²è¯»: POST /api/v1/notifications/mark-all-read                                             â”‚
â”‚                                                                                                  â”‚
â”‚  âš ï¸ V1 é™åˆ¶: ä»…æ”¯æŒè½®è¯¢ï¼Œä¸æ”¯æŒ WebSocket æ¨é€                                                     â”‚
â”‚  âš ï¸ V1 é™åˆ¶: ä¸æ”¯æŒå¤–éƒ¨æ¸ é“ï¼ˆé‚®ä»¶/Webhookï¼‰ï¼›V2+ è§„åˆ’è§ä¸‹æ–¹é“¾æ¥                                    â”‚
â”‚                                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### State Transitions

| äº‹ä»¶ç±»å‹ | äº¤ä»˜é¢„æœŸ |
|------|----------|
| éœ€è¦å®¡æ‰¹ | å·¥å•æäº¤åç«‹å³é€šçŸ¥å®¡æ‰¹äºº |
| å®¡æ‰¹ç»“æœ | æ‰¹å‡†/æ‹’ç»åé€šçŸ¥ç”³è¯·äºº |
| è¿è¡Œæ€å˜æ›´ | VM çŠ¶æ€å˜åŒ–åé€šçŸ¥èµ„æºæ‹¥æœ‰è€… |

#### Failure & Edge Cases

- é€šçŸ¥å†™å…¥å¤±è´¥ä¸å¾—é™é»˜ä¸¢å¼ƒï¼Œå¿…é¡»å¯è§‚æµ‹ã€‚
- V1 ä»…è½®è¯¢ï¼Œå‰ç«¯éœ€å®¹å¿æœ€ç»ˆä¸€è‡´æ€§å»¶è¿Ÿã€‚
- é€šçŸ¥ payload çš„æ•æ„Ÿä¿¡æ¯å¿…é¡»éµå¾ªè„±æ•ç­–ç•¥ã€‚

#### Authority Links

- [ADR-0015 Â§20 Notification System](../../../../adr/ADR-0015-governance-model-v2.md#20-notification-system)
- [04-governance.md Â§6.3 Notification System](../../../../design/phases/04-governance.md#63-notification-system-adr-0015-20)
- [04-governance.md Â§7 Audit Logging](../../../../design/phases/04-governance.md#7-audit-logging)
- [RFC-0018 Â§Proposed Solution](../../../../rfc/RFC-0018-external-notification.md#proposed-solution)

#### Scope Boundary

æœ¬èŠ‚å®šä¹‰ç”¨æˆ·å¯è§é€šçŸ¥è¡Œä¸ºï¼›æ¸ é“é€‚é…å™¨ã€é‡è¯•ç­–ç•¥å’Œä¾›åº”å•†é›†æˆç»†èŠ‚åœ¨æ²»ç†æ–‡æ¡£ä¸ RFC ä¸­å®šä¹‰ã€‚

---

## Part 4: çŠ¶æ€æœºä¸æ•°æ®æ¨¡å‹

> **è¯´æ˜**: æœ¬èŠ‚å®šä¹‰ç³»ç»Ÿä¸­æ ¸å¿ƒå®ä½“çš„çŠ¶æ€æœºå’Œæ•°æ®åº“è¡¨å…³ç³»ï¼Œæ˜¯å‰åç«¯å¼€å‘çš„é‡è¦å‚è€ƒã€‚

### Purpose

ä¸ºå‰åç«¯å’Œè¿ç»´æä¾›ç»Ÿä¸€çŠ¶æ€è¯­ä¹‰ä¸å…±äº«æ•°æ®æ¨¡å‹æ„å›¾ï¼Œé¿å…è·¨å±‚ç†è§£åå·®ã€‚

### Actors & Trigger

- è§¦å‘ï¼šå·¥ç¨‹å®ç°æˆ–è¯„å®¡éœ€è¦ç»Ÿä¸€è§£é‡Šå·¥å•/VM/å®¡è®¡çŠ¶æ€ã€‚
- å‚ä¸æ–¹ï¼šåç«¯å·¥ç¨‹å¸ˆã€å‰ç«¯å·¥ç¨‹å¸ˆã€SRE/è¿ç»´è¯„å®¡äººå‘˜ã€‚

### Interaction Flow

Part 4 å±äºå‚è€ƒè§†å›¾ï¼Œä¸æ˜¯ç”¨æˆ·æ“ä½œæµç¨‹ã€‚
å®ƒæ±‡æ€»å®ä½“çŠ¶æ€ã€å…³ç³»è¯­ä¹‰ä¸å®¡è®¡è§„åˆ™ï¼Œä¾›å…¶å®ƒæµç¨‹ç« èŠ‚å¤ç”¨ã€‚

### å®¡æ‰¹å·¥å•çŠ¶æ€æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®¡æ‰¹å·¥å• (ApprovalTicket) çŠ¶æ€æµè½¬                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
â”‚                        â”‚  PENDING_APPROVAL â”‚                                                 â”‚
â”‚                        â”‚     (å¾…å®¡æ‰¹)       â”‚                                                 â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚                                  â”‚                                                           â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚              â”‚                   â”‚                   â”‚                                      â”‚
â”‚              â–¼                   â–¼                   â–¼                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚     â”‚  APPROVED   â”‚     â”‚  REJECTED   â”‚     â”‚  CANCELLED  â”‚                                 â”‚
â”‚     â”‚   (å·²æ‰¹å‡†)   â”‚     â”‚   (å·²æ‹’ç»)   â”‚     â”‚  (å·²å–æ¶ˆ)   â”‚                                 â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚            â”‚                 (ç»ˆæ€)              (ç»ˆæ€)                                      â”‚
â”‚            â–¼                                                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                          â”‚
â”‚     â”‚  EXECUTING  â”‚                                                                          â”‚
â”‚     â”‚   (æ‰§è¡Œä¸­)   â”‚                                                                          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                                          â”‚
â”‚            â”‚                                                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                                                                          â”‚
â”‚     â–¼             â–¼                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                    â”‚
â”‚  â”‚ SUCCESS â”‚  â”‚ FAILED  â”‚                                                                    â”‚
â”‚  â”‚ (æˆåŠŸ)   â”‚  â”‚ (å¤±è´¥)   â”‚                                                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                    â”‚
â”‚    (ç»ˆæ€)       (ç»ˆæ€)                                                                        â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### VM çŠ¶æ€æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         VM çŠ¶æ€æµè½¬                                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚     â”‚  CREATING   â”‚â”€â”€â”€â”€â–¶â”‚   RUNNING   â”‚â—€â”€â”€â”€â”€â”‚   STOPPED   â”‚                                 â”‚
â”‚     â”‚   (åˆ›å»ºä¸­)   â”‚     â”‚   (è¿è¡Œä¸­)   â”‚     â”‚   (å·²åœæ­¢)   â”‚                                 â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚            â”‚                   â”‚                   â–²                                         â”‚
â”‚            â”‚                   â–¼                   â”‚                                         â”‚
â”‚            â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                                         â”‚
â”‚            â”‚            â”‚  STOPPING   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚            â”‚            â”‚   (åœæ­¢ä¸­)   â”‚                                                      â”‚
â”‚            â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚            â”‚                                                                                 â”‚
â”‚            â”‚                   â”‚                                                             â”‚
â”‚            â–¼                   â–¼                                                             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚     â”‚   FAILED    â”‚     â”‚  DELETING   â”‚                                                      â”‚
â”‚     â”‚  (åˆ›å»ºå¤±è´¥)  â”‚     â”‚   (åˆ é™¤ä¸­)   â”‚                                                      â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚                                â”‚                                                             â”‚
â”‚                                â–¼                                                             â”‚
â”‚                     (ç”± worker æ‰§è¡Œç¡¬åˆ é™¤ï¼Œä¸»èµ„æºè¡¨ä¸ä¿ç•™ DELETED æŒä¹…çŠ¶æ€)                   â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### æ•°æ®åº“è¡¨å…³ç³»æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ ¸å¿ƒè¡¨å…³ç³»å›¾                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚   systems    â”‚ 1 â”€â”€â”€ N â”‚   services   â”‚ 1 â”€â”€â”€ N â”‚     vms      â”‚                         â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚
â”‚  â”‚ id           â”‚         â”‚ id           â”‚         â”‚ id           â”‚                         â”‚
â”‚  â”‚ name         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ system_id    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ service_id   â”‚                         â”‚
â”‚  â”‚ description  â”‚         â”‚ name         â”‚         â”‚ name         â”‚                         â”‚
â”‚  â”‚ status       â”‚         â”‚ status       â”‚         â”‚ status       â”‚                         â”‚
â”‚  â”‚ created_by   â”‚         â”‚ created_by   â”‚         â”‚ namespace    â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ cluster_id   â”‚                         â”‚
â”‚         â”‚                                          â”‚ ticket_id    â”‚                         â”‚
â”‚         â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚         â”‚                                                  â”‚                                 â”‚
â”‚         â–¼                                                  â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ role_bindingsâ”‚                               â”‚ approval_tickets â”‚                        â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
â”‚  â”‚ user_id      â”‚                               â”‚ id               â”‚                        â”‚
â”‚  â”‚ role         â”‚                               â”‚ type             â”‚                        â”‚
â”‚  â”‚ resource_typeâ”‚                               â”‚ status           â”‚                        â”‚
â”‚  â”‚ resource_id  â”‚                               â”‚ requester_id     â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚ approver_id      â”‚                        â”‚
â”‚                                                 â”‚ service_id       â”‚                        â”‚
â”‚                                                 â”‚ instance_size_id â”‚                        â”‚
â”‚                                                 â”‚ template_id      â”‚                        â”‚
â”‚                                                 â”‚ final_*          â”‚ â† å®¡æ‰¹æ—¶ç¡®å®šçš„æœ€ç»ˆå€¼    â”‚
â”‚                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                          â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                                  â”‚
â”‚  â”‚instance_sizesâ”‚         â”‚  templates   â”‚              â–¼                                  â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ id           â”‚         â”‚ id           â”‚       â”‚ audit_logs   â”‚                          â”‚
â”‚  â”‚ name         â”‚         â”‚ name         â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
â”‚  â”‚ spec_overridesâ”‚        â”‚ image_source â”‚       â”‚ action       â”‚                          â”‚
â”‚  â”‚ cpu_overcommitâ”‚        â”‚ cloud_init   â”‚       â”‚ actor_id     â”‚                          â”‚
â”‚  â”‚ mem_overcommitâ”‚        â”‚ version      â”‚       â”‚ resource_*   â”‚                          â”‚
â”‚  â”‚ disk_gb_*    â”‚         â”‚ status       â”‚       â”‚ details      â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ created_at   â”‚                          â”‚
â”‚                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®¡è®¡æ—¥å¿—è®¾è®¡

> **å‚è€ƒ**: ADR-0015 Â§7 (Deletion & Cascade Constraints) - "audit records are preserved"

> **è¾¹ç•Œè¯´æ˜**: æœ¬èŠ‚ä»…å®šä¹‰å®¡è®¡è¯­ä¹‰ã€‚
> Schema/DDL/ç´¢å¼•ä»¥ä»¥ä¸‹æ–‡æ¡£ä¸ºæƒå¨æ¥æºï¼š
> - [04-governance.md Â§7](../../../../design/phases/04-governance.md#7-audit-logging)
> - [database/schema-catalog.md Â§Table Domains](../../../../design/database/schema-catalog.md#table-domains)
> - [database/lifecycle-retention.md Â§Retention Classes](../../../../design/database/lifecycle-retention.md#retention-classes-table-centric)

#### å¿…é¡»è¦†ç›–èŒƒå›´

- æ‰€æœ‰çŠ¶æ€å˜åŒ–æ“ä½œï¼ˆCREATE/UPDATE/DELETEï¼‰
- æ•æ„Ÿè¯»æ“ä½œï¼ˆä¾‹å¦‚ `vnc.access`ï¼‰
- æäº¤/å®¡æ‰¹/æ‰§è¡Œé“¾è·¯ä¸­çš„æˆåŠŸä¸å¤±è´¥è·¯å¾„

#### è§„èŒƒåŠ¨ä½œå‘½å

| é¢†åŸŸ | V1 è§„èŒƒåŠ¨ä½œ | è¯´æ˜ |
|------|------|------|
| è®¤è¯ | `user.login`, `user.login_failed`, `user.logout` | è®¤è¯äº‹ä»¶ |
| System | `system.create`, `system.update`, `system.delete_submitted`, `system.delete_executed` | System åˆ é™¤æ— å®¡æ‰¹å·¥å• |
| Service | `service.create`, `service.delete_submitted`, `service.delete_executed` | Service åˆ é™¤æ— å®¡æ‰¹å·¥å• |
| VM | `vm.request`, `vm.create`, `vm.start`, `vm.stop`, `vm.restart`, `vm.delete_submitted`, `vm.delete_approved`, `vm.delete_executed` | VM åˆ é™¤éœ€å®¡æ‰¹ |
| VNC | `vnc.access` | æ•æ„Ÿè¯» |
| Approval | `approval.approve`, `approval.reject`, `approval.cancel` | å·¥å•å†³ç­– |
| RBAC | `role.create`, `role.update`, `role.delete`, `role.assign`, `role.revoke`, `permission.create`, `permission.delete` | æƒé™æ²»ç† |
| Cluster | `cluster.register`, `cluster.update`, `cluster.delete`, `cluster.credential_rotate` | é›†ç¾¤ç”Ÿå‘½å‘¨æœŸ |
| Template | `template.create`, `template.update`, `template.deprecate`, `template.delete` | æ¨¡æ¿ç”Ÿå‘½å‘¨æœŸ |
| InstanceSize | `instance_size.create`, `instance_size.update`, `instance_size.deprecate`, `instance_size.delete` | è§„æ ¼ç”Ÿå‘½å‘¨æœŸ |
| Namespace | `namespace.create`, `namespace.delete` | å‘½åç©ºé—´ç”Ÿå‘½å‘¨æœŸ |
| Auth Provider | `auth_provider.configure`, `auth_provider.update`, `auth_provider.delete`, `auth_provider.sync`, `auth_provider.mapping_create`, `auth_provider.mapping_update`, `auth_provider.mapping_delete` | ADR-0015 ä¿®è®¢ï¼šä½¿ç”¨ `auth_provider.*`ï¼Œä¸å†ç”¨ `idp.*` |
| Config | `config.update` | å¹³å°é…ç½®å˜æ›´ |

#### æ¯æ¡å®¡è®¡è®°å½•å¿…å¤‡å­—æ®µ

- `action`ã€`actor_id`ã€`resource_type`ã€`resource_id`ã€`created_at`
- å¯é€‰ä½†å»ºè®®ï¼š`parent_type`ã€`parent_id`ã€`environment`
- `details` å¿…é¡»æŒ‰ ADR-0019 è„±æ•åè½åº“

#### å¸¸è§å¯è±å…å®¡è®¡çš„æ“ä½œ

| ç±»åˆ« | æ“ä½œ | åŸå›  |
|------|------|------|
| ç³»ç»Ÿå·¡æ£€ | é›†ç¾¤å¥åº·è½®è¯¢ã€VM çŠ¶æ€è½®è¯¢ | é«˜é¢‘ä¸”æ— ç›´æ¥ç”¨æˆ·æ„å›¾ |
| åªè¯»æŸ¥è¯¢ | åˆ—è¡¨/è¯¦æƒ… `GET` API | ä¸æ”¹å˜çŠ¶æ€ |
| å†…éƒ¨æµé‡ | Worker å¿ƒè·³ã€æŒ‡æ ‡é‡‡é›† | å†…éƒ¨å¯è§‚æµ‹æµé‡ |

> **è±å…åŸåˆ™**:
> - å†™æ“ä½œé»˜è®¤å¿…é¡»å®¡è®¡ã€‚
> - è±å…å¿…é¡»æ˜¾å¼å®šä¹‰å¹¶ç»è¿‡è¯„å®¡ã€‚
> - æ•æ„Ÿè¯»å³ä½¿ä¸æ”¹çŠ¶æ€ä¹Ÿåº”å®¡è®¡ã€‚

#### ä¿ç•™ç­–ç•¥åŸºçº¿

| ç¯å¢ƒ | ä¿ç•™æ—¶é—´ | è¯´æ˜ |
|------|------|------|
| ç”Ÿäº§ç¯å¢ƒ | >= 1 å¹´ | åˆè§„åŸºçº¿ |
| æµ‹è¯•ç¯å¢ƒ | >= 90 å¤© | å¯æŒ‰ç­–ç•¥ç¼©çŸ­ |
| æ•æ„Ÿæ“ä½œ | >= 3 å¹´ | `*.delete*`ã€`approval.*`ã€`rbac.*` |

---

### å®¡è®¡æ—¥å¿— JSON å¯¼å‡º (v1+)

> **åœºæ™¯**: å°†å®¡è®¡æ—¥å¿—é›†æˆåˆ°ä¼ä¸šçº§ SIEM ç³»ç»Ÿï¼ˆElasticsearchã€Datadogã€Splunk ç­‰ï¼‰

> ğŸ“¦ **API è§„èŒƒ**: å®Œæ•´ API å’Œå“åº”æ ¼å¼è§ [04-governance.md Â§7 JSON Export API](../../../../design/phases/04-governance.md#7-json-export-api)

**ä¸»è¦åŠŸèƒ½**:
- æ”¯æŒæ—¶é—´èŒƒå›´è¿‡æ»¤çš„åˆ†é¡µå¯¼å‡º
- Webhook æ¨é€é›†æˆï¼Œå®ç°å®æ—¶æµå¼ä¼ è¾“
- ç»“æ„åŒ– JSON æ ¼å¼ï¼Œå…¼å®¹ä¸»æµæ—¥å¿—èšåˆå™¨

---

<a id="external-approval-v2-roadmap"></a>

### å®¡æ‰¹ Provider æ’ä»¶åŒ–æ¶æ„ (V2+ è·¯çº¿å›¾)

> **åœºæ™¯**: ä¸ä¼ä¸šç°æœ‰ ITSM ç³»ç»Ÿï¼ˆJira Service Managementã€ServiceNow ç­‰ï¼‰é›†æˆã€‚
>
> **V1 è¾¹ç•Œ**: V1 åŸºäºç»Ÿä¸€å®¡æ‰¹ Provider å¥‘çº¦ï¼Œä»…å®ç°ä¸€ä¸ªå†…ç½® Providerï¼ˆ`builtin-default`ï¼‰ã€‚
> å¤–éƒ¨ç³»ç»Ÿä½œä¸ºæ’ä»¶é€‚é…å™¨åœ¨ V2+ å¼•å…¥ã€‚

#### è®¾è®¡åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®¡æ‰¹ Provider æ’ä»¶åŒ–æ¶æ„                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Shepherd   â”‚  â”€â”€â”€â”€ Webhook â”€â”€â”€â–¶ â”‚  å¤–éƒ¨ç³»ç»Ÿ    â”‚  â”€â”€â”€â”€ Callback â”€â”€â–¶ â”‚   Shepherd   â”‚   â”‚
â”‚  â”‚   Platform   â”‚                    â”‚ (Jira/SNOW)  â”‚                    â”‚   Platform   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                              â”‚
â”‚  å…³é”®åŸåˆ™:                                                                                    â”‚
â”‚  1. Shepherd è´Ÿè´£ç»Ÿä¸€å·¥å•çŠ¶æ€æœºä¸å®¡è®¡è½¨è¿¹                                                      â”‚
â”‚  2. å†…ç½®/å¤–éƒ¨ Provider å…±äº«ç¨³å®šå¥‘çº¦ï¼Œé¿å…æ ¸å¿ƒæµç¨‹åˆ†å‰                                           â”‚
â”‚  3. å¼‚æ­¥é›†æˆ + å¤±è´¥å®‰å…¨å›é€€ï¼Œå¤–éƒ¨æ•…éšœä¸å¾—é˜»å¡å†…ç½®ä¸»è·¯å¾„                                         â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®¡æ‰¹ Provider é…ç½®ï¼ˆå¤–éƒ¨é€‚é…å™¨ï¼ŒWeb UIï¼‰

> ç®¡ç†å‘˜åœ¨ **è®¾ç½® â†’ å¤–éƒ¨å®¡æ‰¹ç³»ç»Ÿ â†’ æ·»åŠ ** è¿›è¡Œé…ç½®ã€‚
> å¤–éƒ¨é€‚é…å™¨æ³¨å†Œä¿¡æ¯å­˜å‚¨äº `external_approval_systems`ã€‚

**Webhook å®‰å…¨æœ€ä½³å®è·µ**ï¼š
- æ‰€æœ‰ webhook URL å¿…é¡»ä½¿ç”¨ HTTPSã€‚
- ä½¿ç”¨å…±äº«å¯†é’¥è¿›è¡Œç­¾åæ ¡éªŒï¼Œå¹¶é‡‡ç”¨å¸¸é‡æ—¶é—´æ¯”è¾ƒã€‚
- åœ¨ç­¾åè½½è·ä¸­åŒ…å«æ—¶é—´æˆ³ï¼Œæ‹’ç»è¿‡æœŸè¯·æ±‚ï¼Œé˜²æ­¢é‡æ”¾ã€‚
- webhook å¯†é’¥éœ€åŠ å¯†å­˜å‚¨ï¼Œæ³„éœ²æ—¶åŠæ—¶è½®æ¢ã€‚

å‚è€ƒï¼š
- https://docs.github.com/en/webhooks/using-webhooks/validating-webhook-deliveries
- https://docs.stripe.com/webhooks/test

å…³é”®è½åº“å¯¹è±¡ï¼ˆå­—æ®µæƒå¨å®šä¹‰åœ¨ phase/database æ–‡æ¡£ï¼‰ï¼š

| å¯¹è±¡ | ä»£è¡¨å­—æ®µ | ä½œç”¨ |
|----------|------|------|
| `external_approval_systems` | `id`, `name`, `type`, `enabled`, `webhook_url`, `webhook_secret`, `timeout_seconds`, `retry_count` | å¤–éƒ¨é€‚é…å™¨æ³¨å†Œä¸æŠ•é€’ä¿æŠ¤ç­–ç•¥ |
| `audit_logs` | `action`, `resource_type`, `resource_id`, `result`, `metadata` | å¤–éƒ¨å†³ç­–/å›é€€åŠ¨ä½œçš„æœ¬åœ°ä¸å¯å˜å®¡è®¡è½¨è¿¹ |

#### Webhook å‘é€æ ¼å¼ (Shepherd â†’ å¤–éƒ¨ç³»ç»Ÿ)

```json
// POST https://jira.company.com/api/v2/tickets
{
  "shepherd_ticket_id": "ticket-001",
  "type": "VM_CREATE",
  "callback_url": "https://shepherd.company.com/api/v1/approvals/callback",
  "requester": {
    "id": "zhang.san",
    "name": "å¼ ä¸‰",
    "email": "zhang.san@company.com"
  },
  "request_details": {
    "namespace": "prod-shop",
    "service": "redis",
    "instance_size": "medium-gpu",
    "template": "centos7-docker",
    "vm_count": 3,
    "reason": "ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²"
  },
  "resource_summary": {
    "cpu_cores": 8,
    "memory_gb": 32,
    "disk_gb": 100,
    "gpu_count": 1
  },
  "environment": "prod",
  "created_at": "2026-01-26T10:14:16Z"
}
```

#### Callback æ¥æ”¶æ ¼å¼ (å¤–éƒ¨ç³»ç»Ÿ â†’ Shepherd)

```json
// POST https://shepherd.company.com/api/v1/approvals/callback
// Headers:
//   X-Shepherd-Signature: HMAC-SHA256 ç­¾å
//   Content-Type: application/json
{
  "shepherd_ticket_id": "ticket-001",
  "external_ticket_id": "JIRA-12345",    // å¤–éƒ¨ç³»ç»Ÿå·¥å• ID (ç”¨äºè¿½æº¯)
  "status": "Approved",                   // å¤–éƒ¨ç³»ç»ŸçŠ¶æ€ (å°†é€šè¿‡ status_mapping è½¬æ¢)
  "approver": {
    "id": "admin.li",
    "name": "ç®¡ç†å‘˜æå››"
  },
  "comments": "èµ„æºå……è¶³ï¼Œæ‰¹å‡†åˆ›å»º",
  "approved_at": "2026-01-26T11:30:00Z"
}
```

#### Shepherd å¤„ç†å›è°ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Callback å¤„ç†æµç¨‹                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  1. éªŒè¯ HMAC ç­¾å                                                                           â”‚
â”‚  2. æŸ¥æ‰¾ shepherd_ticket_id å¯¹åº”çš„å·¥å•                                                       â”‚
â”‚  3. é€šè¿‡ status_mapping è½¬æ¢çŠ¶æ€                                                             â”‚
â”‚  4. æ›´æ–°å·¥å•çŠ¶æ€å’Œ approver ä¿¡æ¯                                                              â”‚
â”‚  5. å¦‚æœ APPROVED:                                                                          â”‚
â”‚     a. è§¦å‘ VM åˆ›å»º Worker ä»»åŠ¡                                                              â”‚
â”‚     b. å‘é€é€šçŸ¥ç»™ç”³è¯·äºº                                                                      â”‚
â”‚  6. å¦‚æœ REJECTED:                                                                          â”‚
â”‚     a. è®°å½•æ‹’ç»åŸå›                                                                           â”‚
â”‚     b. å‘é€é€šçŸ¥ç»™ç”³è¯·äºº                                                                      â”‚
â”‚  7. è®°å½•å®¡è®¡æ—¥å¿—                                                                              â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é›†æˆæ³¨æ„äº‹é¡¹

| æ³¨æ„äº‹é¡¹ | è¯´æ˜ |
|----------|------|
| **å¹‚ç­‰æ€§** | Callback å¯èƒ½é‡è¯•ï¼Œéœ€ç¡®ä¿å¤šæ¬¡å¤„ç†åŒä¸€å›è°ƒä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨ |
| **çŠ¶æ€åŒæ­¥** | å®šæœŸæ£€æŸ¥å¤–éƒ¨ç³»ç»Ÿä¸­ pending çŠ¶æ€çš„å·¥å•ï¼Œé˜²æ­¢å›è°ƒä¸¢å¤± |
| **è¶…æ—¶å¤„ç†** | V1: ä¸è‡ªåŠ¨å–æ¶ˆã€‚è¶…æ—¶åå¤–éƒ¨ç³»ç»Ÿå¯è°ƒç”¨æ‹’ç» APIï¼ˆå‚è§ [ADR-0015 Â§11](../../../../adr/ADR-0015-governance-model-v2.md#11-approval-timeout-handling)ï¼‰ |
| **å®‰å…¨æ€§** | å§‹ç»ˆéªŒè¯ HMAC ç­¾åï¼Œé˜²æ­¢ä¼ªé€ å›è°ƒ |
| **å›é€€æœºåˆ¶** | å¤–éƒ¨ç³»ç»Ÿä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨å›é€€åˆ°å†…ç½®å®¡æ‰¹ |

### State Transitions (Part 4 å‚è€ƒ)

| é¢†åŸŸ | è§„èŒƒçŠ¶æ€é›†åˆ |
|------|-------------|
| å®¡æ‰¹å·¥å• | `PENDING_APPROVAL`, `APPROVED`, `REJECTED`, `CANCELLED`, `EXECUTING`, `SUCCESS`, `FAILED` |
| VM è¿è¡Œæ€ | `CREATING`, `RUNNING`, `STOPPING`, `STOPPED`, `FAILED`, `DELETING` |
| å®¡è®¡è®°å½•ç”Ÿå‘½å‘¨æœŸ | ä»…è¿½åŠ å†™å…¥ï¼ŒæŒ‰ç­–ç•¥ä¿ç•™/å½’æ¡£ |

### Failure & Edge Cases (Part 4 å‚è€ƒ)

- API/UI/worker çš„çŠ¶æ€æœºè¯­ä¹‰æ¼‚ç§»å±äºè®¾è®¡ç¼ºé™·ï¼Œç¦æ­¢å‘ç”Ÿã€‚
- æ–°å¢ç»ˆæ€å¿…é¡»åŒæ—¶æ›´æ–° flowã€governanceã€API åˆåŒæ–‡æ¡£ã€‚
- å®¡è®¡è„±æ•è¿è§„å±äºå®‰å…¨äº‹ä»¶ï¼Œè€Œéæ™®é€šæ–‡æ¡£é—®é¢˜ã€‚

### Authority Links (Part 4)

- [04-governance.md Â§7 Audit Logging](../../../../design/phases/04-governance.md#7-audit-logging)
- [database/schema-catalog.md Â§Relationship Baseline](../../../../design/database/schema-catalog.md#relationship-baseline)
- [database/lifecycle-retention.md Â§Database Guardrails](../../../../design/database/lifecycle-retention.md#database-guardrails)
- [ADR-0015 Â§11 Approval Timeout Handling](../../../../adr/ADR-0015-governance-model-v2.md#11-approval-timeout-handling)

### Scope Boundary (Part 4)

æœ¬éƒ¨åˆ†å®šä¹‰è¯­ä¹‰æ¨¡å‹ä¸è·¨ç»„ä»¶çº¦æŸï¼Œä¸æ›¿ä»£ DDLã€API å¥‘çº¦æˆ– worker å®ç°è§„èŒƒæ–‡æ¡£ã€‚

---

## é˜¶æ®µ 6: VNC æ§åˆ¶å°è®¿é—®

### Purpose

å®šä¹‰æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒä¸‹çš„å®‰å…¨æ§åˆ¶å°è®¿é—®äº¤äº’è¡Œä¸ºã€‚

### Actors & Trigger

- è§¦å‘ï¼šç”¨æˆ·åœ¨ VM è¯¦æƒ…é¡µè¯·æ±‚æ§åˆ¶å°è®¿é—®ã€‚
- å‚ä¸æ–¹ï¼šè¯·æ±‚ç”¨æˆ·ã€RBAC æ ¡éªŒå±‚ã€å®¡æ‰¹æµç¨‹ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ã€Token ç­¾å‘å™¨ã€VNC ä»£ç†å±‚ã€‚

### Interaction Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 6 æ§åˆ¶å°è®¿é—®æ€»è§ˆ                                                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  VM è¯¦æƒ…é¡µ -> ç”¨æˆ·ç‚¹å‡»â€œæ§åˆ¶å°â€æˆ–â€œç”³è¯·æ§åˆ¶å°è®¿é—®â€                                                â”‚
â”‚        â”‚                                                                                     â”‚
â”‚        â–¼                                                                                     â”‚
â”‚  åç«¯ç»Ÿä¸€æ ¡éªŒï¼šRBACï¼ˆ`vnc:access`ï¼‰+ VM çŠ¶æ€ï¼ˆ`RUNNING`ï¼‰                                     â”‚
â”‚        â”‚                                                                                     â”‚
â”‚        â”œâ”€â”€ æµ‹è¯•ç¯å¢ƒï¼šç­¾å‘ token -> ç›´æ¥æ‰“å¼€ noVNC                                              â”‚
â”‚        â”‚                                                                                     â”‚
â”‚        â””â”€â”€ ç”Ÿäº§ç¯å¢ƒï¼šåˆ›å»ºå®¡æ‰¹å·¥å• -> ç®¡ç†å‘˜æ‰¹å‡†/æ‹’ç»                                            â”‚
â”‚                 â”œâ”€â”€ æ‰¹å‡†ï¼šç­¾å‘ token -> æ‰“å¼€ noVNC                                             â”‚
â”‚                 â””â”€â”€ æ‹’ç»ï¼šæ— æ§åˆ¶å°ä¼šè¯                                                         â”‚
â”‚                                                                                              â”‚
â”‚  ä¸¤æ¡è·¯å¾„éƒ½å¿…é¡»è½å®¡è®¡ï¼ˆè¯·æ±‚ä¸è®¿é—®ç»“æœï¼‰                                                         â”‚
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æƒé™çŸ©é˜µ

| ç¯å¢ƒ | éœ€è¦å®¡æ‰¹ | Token TTL | è¯´æ˜ |
|------|----------|-----------|------|
| **æµ‹è¯•** | âŒ å¦ | 2 å°æ—¶ | ä»… RBAC æ£€æŸ¥ï¼ˆ`vnc:access` æƒé™ï¼‰ |
| **ç”Ÿäº§** | âœ… æ˜¯ | 2 å°æ—¶ | éœ€è¦å®¡æ‰¹å·¥å• |

### VNC è®¿é—®æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ 6: VNC æ§åˆ¶å°è®¿é—®                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ æµ‹è¯•ç¯å¢ƒ (æ— éœ€å®¡æ‰¹) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚                                                                                          â”‚
â”‚  â”‚  1. ç”¨æˆ·ç‚¹å‡» VM è¯¦æƒ…é¡µçš„ [æ§åˆ¶å°] æŒ‰é’®                                                    â”‚
â”‚  â”‚                                                                                          â”‚
â”‚  â”‚  2. åç«¯æ£€æŸ¥:                                                                            â”‚
â”‚  â”‚     a. ç”¨æˆ·æ‹¥æœ‰è¯¥å‘½åç©ºé—´çš„ `vnc:access` æƒé™                                            â”‚
â”‚  â”‚     b. VM å¤„äº RUNNING çŠ¶æ€                                                              â”‚
â”‚  â”‚     c. ç¯å¢ƒä¸ºæµ‹è¯•ç¯å¢ƒï¼ˆæ— éœ€å®¡æ‰¹ï¼‰                                                         â”‚
â”‚  â”‚                                                                                          â”‚
â”‚  â”‚  3. ç”Ÿæˆ VNC Token (JWT):                                                               â”‚
â”‚  â”‚     {                                                                                    â”‚
â”‚  â”‚       "sub": "user-123",           ğŸ‘ˆ ç”¨æˆ·ç»‘å®š                                           â”‚
â”‚  â”‚       "vm_id": "vm-456",           ğŸ‘ˆ èµ„æºç»‘å®š                                           â”‚
â”‚  â”‚       "cluster": "cluster-a",                                                           â”‚
â”‚  â”‚       "namespace": "test-ns",                                                           â”‚
â”‚  â”‚       "exp": now + 2h,             ğŸ‘ˆ æœ‰æ•ˆæœŸ                                              â”‚
â”‚  â”‚       "jti": "vnc-token-789",      ğŸ‘ˆ å”¯ä¸€ ID ç”¨äºå®¡è®¡                                   â”‚
â”‚  â”‚       "single_use": true           ğŸ‘ˆ é¦–æ¬¡è¿æ¥åå¤±æ•ˆ                                     â”‚
â”‚  â”‚     }                                                                                    â”‚
â”‚  â”‚                                                                                          â”‚
â”‚  â”‚  4. åœ¨æ–°æ ‡ç­¾é¡µ/å¼¹çª—æ‰“å¼€ noVNC:                                                           â”‚
â”‚  â”‚     GET /api/v1/vms/{vm_id}/vnc?token={vnc_jwt}                                         â”‚
â”‚  â”‚                                                                                          â”‚
â”‚  â”‚  5. åç«¯ä»£ç† WebSocket åˆ° KubeVirt:                                                      â”‚
â”‚  â”‚     â†’ subresources.kubevirt.io/v1/namespaces/{ns}/virtualmachineinstances/{name}/vnc    â”‚
â”‚  â”‚                                                                                          â”‚
â”‚  â”‚  6. åˆ›å»ºå®¡è®¡æ—¥å¿—:                                                                        â”‚
â”‚  â”‚     INSERT INTO audit_logs (action, actor_id, resource_type, resource_id, details)      â”‚
â”‚  â”‚     VALUES ('VNC_SESSION_STARTED', 'user-123', 'vm', 'vm-456',                          â”‚
â”‚  â”‚             '{"token_id": "vnc-token-789", "environment": "test"}')                      â”‚
â”‚  â”‚                                                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                                                              â”‚
â”‚  â”Œâ”€ ç”Ÿäº§ç¯å¢ƒ (éœ€è¦å®¡æ‰¹) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚                                                                                          â”‚
â”‚  â”‚  1. ç”¨æˆ·ç‚¹å‡» VM è¯¦æƒ…é¡µçš„ [ç”³è¯·æ§åˆ¶å°è®¿é—®] æŒ‰é’®                                            â”‚
â”‚  â”‚                                                                                          â”‚
â”‚  â”‚  2. åç«¯æ£€æŸ¥:                                                                            â”‚
â”‚  â”‚     a. ç”¨æˆ·æ‹¥æœ‰è¯¥å‘½åç©ºé—´çš„ `vnc:access` æƒé™                                            â”‚
â”‚  â”‚     b. VM å¤„äº RUNNING çŠ¶æ€                                                              â”‚
â”‚  â”‚     c. ç¯å¢ƒä¸ºç”Ÿäº§ç¯å¢ƒ â†’ éœ€è¦å®¡æ‰¹                                                         â”‚
â”‚  â”‚     d. ä¸å­˜åœ¨å¾…å¤„ç†çš„ VNC è®¿é—®è¯·æ±‚ï¼ˆé‡å¤æ£€æŸ¥ï¼‰                                            â”‚
â”‚  â”‚                                                                                          â”‚
â”‚  â”‚  3. åˆ›å»ºå®¡æ‰¹å·¥å•:                                                                        â”‚
â”‚  â”‚     INSERT INTO approval_tickets (type, status, requester_id, resource_id, ...)         â”‚
â”‚  â”‚     VALUES ('VNC_ACCESS_REQUESTED', 'PENDING_APPROVAL', 'user-123', 'vm-456', ...)      â”‚
â”‚  â”‚                                                                                          â”‚
â”‚  â”‚  4. é€šçŸ¥ç®¡ç†å‘˜å®¡æ‰¹                                                                       â”‚
â”‚  â”‚                                                                                          â”‚
â”‚  â”‚  5. ç®¡ç†å‘˜å®¡æ‰¹ï¼ˆä¸ VM è¯·æ±‚å®¡æ‰¹æµç¨‹ç›¸åŒï¼‰                                                   â”‚
â”‚  â”‚                                                                                          â”‚
â”‚  â”‚  6. å®¡æ‰¹é€šè¿‡å:                                                                          â”‚
â”‚  â”‚     a. ç”Ÿæˆ VNC Tokenï¼ˆç»“æ„ä¸æµ‹è¯•ç¯å¢ƒç›¸åŒï¼‰                                               â”‚
â”‚  â”‚     b. é€šçŸ¥ç”¨æˆ·å¹¶æä¾›è®¿é—®é“¾æ¥                                                            â”‚
â”‚  â”‚     c. ç”¨æˆ·åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ noVNC                                                          â”‚
â”‚  â”‚                                                                                          â”‚
â”‚  â”‚  7. åˆ›å»ºå®¡è®¡æ—¥å¿—ï¼ˆä¸æµ‹è¯•ç¯å¢ƒç›¸åŒï¼‰                                                         â”‚
â”‚  â”‚                                                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### State Transitions

| ç¯å¢ƒ | å·¥å• | è®¿é—®ç»“æœ |
|------|------|---------|
| æµ‹è¯•ç¯å¢ƒ | æ— å®¡æ‰¹å·¥å• | RBAC é€šè¿‡ -> ç­¾å‘ token -> å»ºç«‹ä¼šè¯ |
| ç”Ÿäº§ç¯å¢ƒ | `PENDING_APPROVAL -> APPROVED/REJECTED` | æ‰¹å‡†åç­¾å‘ tokenï¼›æ‹’ç»åˆ™æ— æ§åˆ¶å°è®¿é—® |

### Failure & Edge Cases

- VM é `RUNNING` çŠ¶æ€å¿…é¡»é˜»æ–­ token ç­¾å‘ã€‚
- ç”Ÿäº§ç¯å¢ƒé‡å¤å¾…å®¡æ‰¹è¯·æ±‚å¿…é¡»å¹‚ç­‰æ‹’ç»ã€‚
- token é¦–æ¬¡æˆåŠŸè¿æ¥åå†æ¬¡é‡æ”¾å¿…é¡»æ‹’ç»å¹¶è®°å½•å®¡è®¡ã€‚

### Authority Links

- [ADR-0015 Â§18 VNC Console Access](../../../../adr/ADR-0015-governance-model-v2.md#18-vnc-console-access-permissions)
- [RFC-0011 Â§V1 Implementation Scope](../../../../rfc/RFC-0011-vnc-console.md#v1-implementation-scope)
- [database/vm-lifecycle-write-model.md Â§Stage 6](../../../../design/database/vm-lifecycle-write-model.md#stage-6-vnc-access-write-model)
- [04-governance.md Â§7 Audit Logging](../../../../design/phases/04-governance.md#7-audit-logging)

### Scope Boundary

æœ¬èŠ‚å®šä¹‰äº¤äº’æµç¨‹ä¸ token ç­–ç•¥ï¼Œä¸å±•å¼€ WebSocket ä»£ç†å†…éƒ¨å®ç°å’Œå­˜å‚¨ç»†èŠ‚ã€‚

### VNC Token å®‰å…¨æ€§ (V1 ç®€åŒ–ç‰ˆ)

| å®‰å…¨ç‰¹æ€§ | V1 å®ç° | ADR-0015 è¦æ±‚ |
|----------|---------|---------------|
| **å•æ¬¡ä½¿ç”¨** | é¦–æ¬¡è¿æ¥åæ ‡è®° `used_at` | âœ… å¿…é¡» |
| **æ—¶é—´é™åˆ¶** | JWT `exp` = now + 2h | âœ… 2 å°æ—¶ï¼ˆå¯é…ç½®ï¼‰ |
| **ç”¨æˆ·ç»‘å®š** | JWT `sub` = user_id | âœ… å¿…é¡» |
| **åŠ å¯†** | AES-256-GCMï¼ˆå…±äº«å¯†é’¥ç®¡ç†ï¼‰ | âœ… å¿…é¡» |
| **å®¡è®¡è®°å½•** | `VNC_SESSION_STARTED` äº‹ä»¶ | âœ… å¿…é¡» |

> **V1 é™åˆ¶**: ä¸æ”¯æŒä¸»åŠ¨ Token æ’¤é”€ã€‚å®‰å…¨æ€§ä¾èµ–çŸ­ TTL å’Œå•æ¬¡ä½¿ç”¨æ ‡è®°ã€‚

### API ç«¯ç‚¹

```
# è¯·æ±‚ VNC è®¿é—®ï¼ˆç”Ÿäº§ç¯å¢ƒåˆ›å»ºå®¡æ‰¹å·¥å•ï¼‰
POST /api/v1/vms/{vm_id}/console/request
â†’ å“åº”: { "ticket_id": "...", "status": "PENDING_APPROVAL" }  (ç”Ÿäº§)
â†’ å“åº”: { "vnc_url": "/api/v1/vms/{vm_id}/vnc?token=..." }  (æµ‹è¯•)

# VNC WebSocket ç«¯ç‚¹
GET /api/v1/vms/{vm_id}/vnc?token={vnc_jwt}
Upgrade: websocket
â†’ ä»£ç†åˆ° KubeVirt VNC å­èµ„æº

# æ£€æŸ¥æ§åˆ¶å°è®¿é—®çŠ¶æ€ï¼ˆè½®è¯¢ç”¨ï¼‰
GET /api/v1/vms/{vm_id}/console/status
â†’ å“åº”: { "status": "APPROVED", "vnc_url": "..." } | { "status": "PENDING" }
```

### æ•°æ®åº“æ“ä½œ

| ç¯å¢ƒ | æŒä¹…åŒ–è¡Œä¸º |
|------|------------|
| æµ‹è¯•ç¯å¢ƒ | ä¸åˆ›å»ºå®¡æ‰¹å·¥å•ï¼›è®¿é—®è¡Œä¸ºå¿…é¡»å†™å®¡è®¡ã€‚ |
| ç”Ÿäº§ç¯å¢ƒ | å…ˆåˆ›å»º `VNC_ACCESS_REQUESTED` å®¡æ‰¹å·¥å•ï¼Œå®¡æ‰¹é€šè¿‡åç­¾å‘ token å¹¶è¿½åŠ å®¡è®¡è®°å½•ã€‚ |

å®ç°ç»†èŠ‚å’Œå†™é›†è¾¹ç•Œä»¥ä»¥ä¸‹æ–‡æ¡£ä¸ºå‡†ï¼š

- [database/vm-lifecycle-write-model.md Â§Stage 6](../../../../design/database/vm-lifecycle-write-model.md#stage-6-vnc-access-write-model)
- [04-governance.md Â§7 Audit Logging](../../../../design/phases/04-governance.md#7-audit-logging)

---
